name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-linux-v${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Create package list
        run: |
          cat > packages.x86_64 <<'EOF'
          linux-lts
          linux-firmware
          base
          base-devel
          syslinux
          edk2-shell
          memtest86+
          memtest86+-efi
          mkinitcpio
          mkinitcpio-archiso
          arch-install-scripts
          pacman-contrib
          archlinux-contrib
          plymouth
          plasma-desktop
          plasma-workspace
          plasma-nm
          plasma-pa
          bluedevil
          bluez
          bluez-utils
          sddm
          dolphin
          konsole
          kate
          firefox
          kscreen
          discover
          packagekit-qt6
          flatpak
          fwupd
          networkmanager
          pipewire
          pipewire-pulse
          pipewire-jack
          pipewire-alsa
          wireplumber
          git
          curl
          wget
          xmlstarlet
          vim
          nano
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          gparted
          ntfs-3g
          dosfstools
          exfatprogs
          xf86-input-wacom
          iwd
          kvantum
          papirus-icon-theme
          breeze-gtk
          kcalc
          spectacle
          gwenview
          EOF
      
      - name: Build ISO
        run: |
          docker build -t builder - <<'DOCKERFILE'
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git && pacman -Scc --noconfirm
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged -v $PWD:/workspace -e ISO_NAME="${{ env.ISO_NAME }}" builder bash -c '
          set -euo pipefail
          cp -r /usr/share/archiso/configs/releng /build/cybr
          cd /build/cybr
          cp /workspace/packages.x86_64 .
          
          # Initialize pacman
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syy --noconfirm
          
          # Enable parallel downloads
          sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/" pacman.conf
          pacman -Syy --noconfirm
          
          # Branding files
          mkdir -p airootfs/etc airootfs/etc/motd.d
          mkdir -p airootfs/etc/skel/.config
          mkdir -p airootfs/etc/skel/.local/share/konsole
          mkdir -p airootfs/etc/skel/.local/share/plasma/desktoptheme
          
          cat > airootfs/etc/os-release <<"EOF"
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          ANSI_COLOR="38;2;23;147;209"
          HOME_URL="https://wolfos.uk/"
          LOGO=cybr-logo
          EOF
          
          cat > airootfs/etc/lsb-release <<"EOF"
          DISTRIB_ID="Cybr"
          DISTRIB_RELEASE="rolling"
          DISTRIB_DESCRIPTION="Cybr Linux"
          EOF
          
          echo "cybr-live" > airootfs/etc/hostname
          
          cat > airootfs/etc/issue <<"EOF"
          
          Cybr Linux
          ==========
          Welcome to the Live Environment
          
          EOF
          
          cat > airootfs/etc/motd.d/00-cybr <<"EOF"
          
          ╔══════════════════════════════════════╗
          ║          Cybr Linux                  ║
          ║  Modern • Elegant • User-Friendly    ║
          ║                                      ║
          ║  Install: calamares or archinstall   ║
          ║  Support: https://wolfos.uk/         ║
          ╚══════════════════════════════════════╝
          
          EOF
          
          # Kernel config with Plymouth
          mkdir -p airootfs/etc/mkinitcpio.conf.d
          mkdir -p airootfs/etc/mkinitcpio.d
          mkdir -p airootfs/boot
          
          cat > airootfs/etc/mkinitcpio.conf.d/archiso.conf <<"EOF"
          MODULES=()
          BINARIES=()
          FILES=()
          HOOKS=(base udev plymouth modconf kms keyboard keymap consolefont block filesystems archiso)
          COMPRESSION="xz"
          COMPRESSION_OPTIONS=(-9e)
          EOF
          
          cat > airootfs/etc/mkinitcpio.d/linux-lts.preset <<"EOF"
          ALL_config="/etc/mkinitcpio.conf.d/archiso.conf"
          ALL_kver="/boot/vmlinuz-linux-lts"
          PRESETS=("default")
          default_image="/boot/initramfs-linux-lts.img"
          EOF
          
          # Live user setup script
          cat > airootfs/root/customize_airootfs.sh <<"ENDSCRIPT"
          #!/usr/bin/env bash
          set -e
          
          # Build initramfs
          KVER=$(file -bL /boot/vmlinuz-linux-lts | grep -o "version [^ ]*" | cut -d" " -f2)
          mkinitcpio -k "$KVER" -c /etc/mkinitcpio.conf.d/archiso.conf -g /boot/initramfs-linux-lts.img
          
          if [[ ! -f /boot/vmlinuz-linux-lts || ! -f /boot/initramfs-linux-lts.img ]]; then
            echo "ERROR: Kernel files missing"
            exit 1
          fi
          
          # Create live user
          useradd -m -G wheel,audio,video,optical,storage,network -s /bin/bash liveuser
          echo "liveuser:live" | chpasswd
          echo "root:root" | chpasswd
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel
          chmod 440 /etc/sudoers.d/wheel
          
          # Copy yay installation script for after network setup
          cat > /usr/local/bin/setup-aur.sh <<"AURSETUP"
          #!/bin/bash
          # Install yay AUR helper
          if ! command -v yay &> /dev/null; then
            cd /tmp
            sudo -u liveuser git clone https://aur.archlinux.org/yay-bin.git
            cd yay-bin
            sudo -u liveuser makepkg -si --noconfirm
            cd /
            rm -rf /tmp/yay-bin
          fi
          
          # Install AUR packages
          sudo -u liveuser yay -S --noconfirm calamares latte-dock
          AURSETUP
          chmod +x /usr/local/bin/setup-aur.sh
          
          # Create welcome script that requires network
          cat > /usr/local/bin/cybr-welcome.sh <<"WELCOME"
          #!/bin/bash
          
          # Check if we already completed setup
          if [[ -f /var/lib/cybr-welcome-done ]]; then
            exit 0
          fi
          
          # Check if we have internet
          if ping -c 1 -W 2 archlinux.org &> /dev/null; then
            # We have internet, install AUR packages
            kdialog --title "Cybr Linux" --passivepopup "Setting up additional software..." 5 &
            /usr/local/bin/setup-aur.sh
            kdialog --title "Cybr Linux" --msgbox "Welcome to Cybr Linux!\n\nYour system is ready. Additional software including Calamares installer has been installed."
            touch /var/lib/cybr-welcome-done
            exit 0
          fi
          
          # No internet - require connection
          while true; do
            kdialog --title "Cybr Linux - Network Required" --msgbox \
            "Welcome to Cybr Linux!
            
            An internet connection is required to complete setup and install essential software (Calamares installer, themes, etc.).
            
            Please connect to the internet to continue."
            
            # Open network manager
            kcmshell6 kcm_networkmanagement
            
            # Wait a moment for user to connect
            sleep 3
            
            # Check if connected now
            if ping -c 1 -W 2 archlinux.org &> /dev/null; then
              kdialog --title "Cybr Linux" --passivepopup "Connected! Installing additional software..." 5 &
              /usr/local/bin/setup-aur.sh
              kdialog --title "Cybr Linux" --msgbox "Setup complete!\n\nYour system is ready with all additional software installed."
              touch /var/lib/cybr-welcome-done
              break
            else
              kdialog --title "Connection Failed" --warningyesno \
              "Unable to detect internet connection.\n\nWould you like to try connecting again?" \
              --yes-label "Try Again" --no-label "Use Offline Mode"
              
              if [[ \$? -ne 0 ]]; then
                # User chose offline mode
                kdialog --title "Offline Mode" --msgbox "Running in offline mode.\n\nSome features (Calamares installer) will not be available.\n\nYou can use 'archinstall' from the terminal to install the system."
                touch /var/lib/cybr-welcome-done
                break
              fi
            fi
          done
          WELCOME
          chmod +x /usr/local/bin/cybr-welcome.sh
          
          # Create autostart entry for welcome script
          mkdir -p /home/liveuser/.config/autostart
          cat > /home/liveuser/.config/autostart/cybr-welcome.desktop <<"AUTOSTART"
          [Desktop Entry]
          Type=Application
          Name=Cybr Welcome
          Exec=/usr/local/bin/cybr-welcome.sh
          Hidden=false
          NoDisplay=true
          X-GNOME-Autostart-enabled=true
          X-KDE-autostart-after=panel
          AUTOSTART
          
          # SDDM autologin
          mkdir -p /etc/sddm.conf.d
          cat > /etc/sddm.conf.d/autologin.conf <<"SDDM"
          [Autologin]
          User=liveuser
          Session=plasma
          
          [General]
          HaltCommand=/usr/bin/systemctl poweroff
          RebootCommand=/usr/bin/systemctl reboot
          
          [Theme]
          Current=breeze
          SDDM
          
          # Plymouth config
          mkdir -p /etc/plymouth
          cat > /etc/plymouth/plymouthd.conf <<"PLYM"
          [Daemon]
          Theme=spinner
          ShowDelay=0
          PLYM
          plymouth-set-default-theme spinner
          
          # Dark mode defaults for liveuser
          mkdir -p /home/liveuser/.config
          cat > /home/liveuser/.config/kdeglobals <<"KDE"
          [General]
          ColorScheme=BreezeDark
          
          [KDE]
          LookAndFeelPackage=org.kde.breezedark.desktop
          
          [Icons]
          Theme=Papirus-Dark
          KDE
          
          # Latte Dock config - ChromeOS style bottom dock
          mkdir -p /home/liveuser/.config/latte
          cat > /home/liveuser/.config/lattedockrc <<"LATTE"
          [UniversalSettings]
          canDisableBorders=true
          currentLayout=Cybr
          lastNonAssignedLayout=Cybr
          version=2
          LATTE
          
          # Plasma panel configuration for ChromeOS-like experience
          mkdir -p /home/liveuser/.config/plasma-org.kde.plasma.desktop-appletsrc
          cat > /home/liveuser/.config/kwinrc <<"KWIN"
          [Desktops]
          Number=1
          Rows=1
          
          [Effect-Blur]
          BlurStrength=8
          
          [Plugins]
          blurEnabled=true
          
          [Windows]
          FocusPolicy=FocusFollowsMouse
          RollOverDesktops=true
          KWIN
          
          # Konsole profile
          mkdir -p /home/liveuser/.local/share/konsole
          cat > /home/liveuser/.local/share/konsole/Cybr.profile <<"KONSOLE"
          [Appearance]
          ColorScheme=Breeze
          Font=Monospace,11,-1,5,50,0,0,0,0,0
          
          [General]
          Name=Cybr
          Parent=FALLBACK/
          KONSOLE
          
          # Desktop icons
          mkdir -p /home/liveuser/Desktop
          cat > /home/liveuser/Desktop/install.desktop <<"DESK1"
          [Desktop Entry]
          Type=Application
          Version=1.0
          Name=Install Cybr Linux
          GenericName=System Installer
          Comment=Install the operating system to disk
          Exec=sh -c 'if command -v calamares &> /dev/null; then sudo calamares; else konsole -e sudo archinstall; fi'
          Icon=system-software-install
          Terminal=false
          StartupNotify=true
          Categories=Qt;System;
          X-AppStream-Ignore=true
          DESK1
          chmod +x /home/liveuser/Desktop/install.desktop
          
          cat > /home/liveuser/Desktop/discover.desktop <<"DESK2"
          [Desktop Entry]
          Type=Application
          Name=App Store
          GenericName=Software Center
          Comment=Browse and install applications
          Exec=plasma-discover
          Icon=plasmadiscover
          Terminal=false
          Categories=Qt;KDE;System;PackageManager;
          DESK2
          chmod +x /home/liveuser/Desktop/discover.desktop
          
          # Fix permissions
          chown -R liveuser:liveuser /home/liveuser
          
          # Enable Flatpak repo
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo || true
          ENDSCRIPT
          chmod +x airootfs/root/customize_airootfs.sh
          
          # Calamares config
          mkdir -p airootfs/etc/calamares
          cat > airootfs/etc/calamares/settings.conf <<"CALA"
          modules-search: [ local ]
          instances: [ ]
          sequence:
            - show:
              - welcome
              - locale
              - keyboard
              - partition
              - users
              - summary
            - exec:
              - partition
              - mount
              - unpackfs
              - machineid
              - fstab
              - locale
              - keyboard
              - localecfg
              - users
              - displaymanager
              - networkcfg
              - hwclock
              - services-systemd
              - bootloader
              - umount
            - show:
              - finished
          branding: cybr
          prompt-install: true
          dont-chroot: false
          CALA
          
          mkdir -p airootfs/etc/calamares/branding/cybr
          cat > airootfs/etc/calamares/branding/cybr/branding.desc <<"BRAND"
          componentName: cybr
          strings:
            productName: Cybr Linux
            shortProductName: Cybr
            version: Rolling
            shortVersion: Rolling
            versionedName: Cybr Linux
            shortVersionedName: Cybr
            bootloaderEntryName: Cybr
            productUrl: https://wolfos.uk/
          images:
            productLogo: "logo.png"
            productIcon: "logo.png"
          slideshow: "show.qml"
          style:
            sidebarBackground: "#1793D1"
            sidebarText: "#FFFFFF"
          BRAND
          
          # systemd-boot (UEFI)
          mkdir -p efiboot/loader/entries
          cat > efiboot/loader/loader.conf <<"EOF"
          timeout 15
          default 01-cybr.conf
          console-mode max
          editor no
          EOF
          
          cat > efiboot/loader/entries/01-cybr.conf <<"EOF"
          title   Cybr Linux
          linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          options archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% quiet splash loglevel=3 rd.udev.log_priority=3 vt.global_cursor_default=0
          EOF
          
          cat > efiboot/loader/entries/02-cybr-safe.conf <<"EOF"
          title   Cybr Linux (Safe Graphics)
          linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          options archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% nomodeset quiet splash loglevel=3
          EOF
          
          # Syslinux (BIOS)
          cat > syslinux/archiso_head.cfg <<"EOF"
          UI vesamenu.c32
          MENU TITLE Cybr Linux
          MENU WIDTH 78
          MENU MARGIN 4
          MENU ROWS 7
          MENU COLOR title 1;36;44 #1793D1 #a0000000 std
          MENU COLOR sel 7;37;40 #e0ffffff #201793D1 all
          TIMEOUT 150
          EOF
          
          cat > syslinux/archiso_sys.cfg <<"EOF"
          LABEL arch64
          MENU LABEL Cybr Linux
          LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% quiet splash loglevel=3
          
          LABEL arch64_nomodeset
          MENU LABEL Cybr Linux (Safe Graphics)
          LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% nomodeset quiet splash loglevel=3
          EOF
          
          cat > syslinux/syslinux.cfg <<"EOF"
          DEFAULT arch64
          INCLUDE archiso_head.cfg
          INCLUDE archiso_sys.cfg
          INCLUDE archiso_tail.cfg
          EOF
          
          # Enable services
          mkdir -p airootfs/etc/systemd/system/multi-user.target.wants
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /usr/lib/systemd/system/NetworkManager.service airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /usr/lib/systemd/system/bluetooth.service airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          
          # Extreme compression
          sed -i "s/airootfs_image_tool_options=()/airootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"100%\" \"-no-recovery\" \"-always-use-fragments\" \"-no-duplicates\")/" profiledef.sh
          
          # Build ISO
          echo "Building ISO..."
          mkarchiso -v -w /tmp/work -o /tmp/out .
          
          # Verify kernel exists
          ISO_FILE=$(ls /tmp/out/*.iso)
          mkdir -p /tmp/m
          mount -o loop "$ISO_FILE" /tmp/m
          
          if [[ ! -f /tmp/m/arch/boot/x86_64/vmlinuz-linux-lts ]]; then
            echo "ERROR: Kernel missing from ISO"
            umount /tmp/m
            exit 1
          fi
          
          echo "Kernel verified successfully"
          umount /tmp/m
          mv "$ISO_FILE" /workspace/${ISO_NAME}.iso
          '
      
      - name: Generate checksums
        run: |
          sha256sum "${{ env.ISO_NAME }}.iso" > "${{ env.ISO_NAME }}.iso.sha256"
          echo "ISO Size: $(($(stat -c%s "${{ env.ISO_NAME }}.iso")/1024/1024))MB"
      
      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [[ -z "$SF_USER" || -z "$SF_PASS" ]] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in {1..3}; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "${{ env.ISO_NAME }}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/" && break
            [[ $i -eq 3 ]] && exit 1
            sleep 30
          done