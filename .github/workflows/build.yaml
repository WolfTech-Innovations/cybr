name: "Cybr Network Installer Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build-base:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    outputs:
      base_name: ${{ steps.set-names.outputs.base_name }}
      iso_name: ${{ steps.set-names.outputs.iso_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set build names
        id: set-names
        run: |
          echo "base_name=cybr-base-v${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "iso_name=cybr-netinst-v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache /usr/share/swift /usr/local/.ghcup /usr/local/share/powershell /usr/share/kotlinc /usr/local/lib/node_modules
          sudo docker system prune -af --volumes
          sudo apt-get purge -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk || true
          sudo apt-get autoremove -y && sudo apt-get clean

      - name: Build Base Filesystem
        run: |
          BASE_NAME="${{ steps.set-names.outputs.base_name }}"
          docker run --rm --privileged -v "$PWD:/w" -e BASE_NAME="${BASE_NAME}" ubuntu:24.04 bash -c '
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y debootstrap squashfs-tools wget gnupg2 curl software-properties-common
          
          # Create base system
          debootstrap --arch=amd64 --variant=minbase noble base http://archive.ubuntu.com/ubuntu/
          
          chroot base bash <<'\''CH'\''
          export DEBIAN_FRONTEND=noninteractive
          
          cat > /etc/apt/sources.list <<E
          deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
          deb http://archive.ubuntu.com/ubuntu noble-security main restricted universe multiverse
          E
          
          apt-get update && apt-get install -y software-properties-common curl gnupg2 ca-certificates
          
          # Add Liquorix kernel repo
          curl -fsSL https://liquorix.net/liquorix-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/liquorix-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/liquorix-archive-keyring.gpg] https://liquorix.net/ubuntu noble main" > /etc/apt/sources.list.d/liquorix.list
          
          # Add UbuntuDDE PPA
          add-apt-repository -y ppa:ubuntudde-dev/stable
          
          apt-get update
          
          # Install everything
          apt-get install -y linux-image-liquorix-amd64 linux-headers-liquorix-amd64 firmware-linux-free firmware-linux-nonfree systemd plymouth sudo
          apt-get install -y ubuntudde-dde lightdm
          apt-get install -y firefox flatpak gparted ntfs-3g dosfstools e2fsprogs git curl wget vim nano network-manager gnome-keyring
          
          # Gaming packages
          dpkg --add-architecture i386 && apt-get update
          apt-get install -y steam-installer libgl1-mesa-dri:amd64 libgl1-mesa-dri:i386 libgl1:amd64 libgl1:i386 mesa-vulkan-drivers:amd64 mesa-vulkan-drivers:i386 vulkan-tools
          
          # Discord
          wget -O /tmp/discord.deb "https://discord.com/api/download?platform=linux&format=deb"
          apt-get install -y /tmp/discord.deb || apt-get install -f -y
          
          # Calamares
          apt-get install -y calamares calamares-settings-ubuntu qml-module-qtquick2 qml-module-qtquick-window2 rsync cryptsetup squashfs-tools
          
          # OS Branding
          cat > /etc/os-release <<O
          NAME="Cybr"
          PRETTY_NAME="Cybr Mobile Gaming Edition"
          ID=cybr
          ID_LIKE=ubuntu
          VERSION_ID="1.0"
          HOME_URL="https://getcybr.org/"
          O
          
          wget -O /usr/share/pixmaps/cybr-logo.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641" || echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > /usr/share/pixmaps/cybr-logo.png
          
          # Calamares config
          mkdir -p /etc/calamares/branding/cybr
          cat > /etc/calamares/branding/cybr/branding.desc <<BRAND
          ---
          componentName: cybr
          strings:
              productName: "Cybr Mobile Gaming"
              shortProductName: "Cybr"
              version: "1.0"
              bootloaderEntryName: "Cybr"
              productUrl: "https://getcybr.org/"
          images:
              productLogo: "/usr/share/pixmaps/cybr-logo.png"
              productIcon: "/usr/share/pixmaps/cybr-logo.png"
          style:
              sidebarBackground: "#1a1a1a"
              sidebarText: "#FFFFFF"
              sidebarTextSelect: "#0066ff"
          BRAND
          
          cat > /etc/calamares/settings.conf <<CALA
          ---
          modules-search: [ local, /usr/lib/calamares/modules ]
          sequence:
          - show:
            - welcome
            - locale
            - keyboard
            - partition
            - users
            - summary
          - exec:
            - partition
            - mount
            - unpackfs
            - machineid
            - fstab
            - locale
            - keyboard
            - localecfg
            - users
            - networkcfg
            - hwclock
            - services-systemd
            - bootloader-config
            - grubcfg
            - bootloader
            - umount
          - show:
            - finished
          branding: cybr
          CALA
          
          cat > /etc/calamares/modules/unpackfs.conf <<UNPACK
          ---
          unpack:
              - source: "/run/live/medium/live/filesystem.squashfs"
                sourcefs: "squashfs"
                destination: ""
          UNPACK
          
          systemctl enable lightdm NetworkManager
          apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          CH
          
          # Create squashfs
          mksquashfs base ${BASE_NAME}.squashfs -comp xz -b 1M -Xdict-size 100%
          mv ${BASE_NAME}.squashfs /w/
          '

      - name: Build Network Installer ISO
        run: |
          ISO_NAME="${{ steps.set-names.outputs.iso_name }}"
          docker run --rm --privileged -v "$PWD:/w" -e ISO_NAME="${ISO_NAME}" ubuntu:24.04 bash -c '
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y debootstrap squashfs-tools xorriso isolinux syslinux-efi mtools wget dosfstools
          
          mkdir -p mini iso/{live,boot,isolinux,EFI/boot}
          
          # Minimal initramfs system
          debootstrap --arch=amd64 --variant=minbase noble mini http://archive.ubuntu.com/ubuntu/
          
          chroot mini bash <<'\''CH'\''
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y linux-image-generic live-boot network-manager wireless-tools wpasupplicant curl wget dialog whiptail rsync
          apt-get clean && rm -rf /var/lib/apt/lists/*
          
          # Create installer script
          cat > /usr/local/bin/cybr-install <<'\''INST'\''
#!/bin/bash
set -e

# Colors
RED='\''\\033[0;31m'\''
GREEN='\''\\033[0;32m'\''
BLUE='\''\\033[0;34m'\''
NC='\''\\033[0m'\''

clear
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Cybr Network Installer v1.0         â•‘${NC}"
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo ""

# Check internet
echo -e "${BLUE}[1/5]${NC} Checking internet connection..."
if ! ping -c 1 8.8.8.8 &>/dev/null; then
    echo -e "${RED}No internet! Setting up WiFi...${NC}"
    nmtui-connect
    sleep 2
fi

if ! ping -c 1 8.8.8.8 &>/dev/null; then
    echo -e "${RED}Still no internet. Cannot continue.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ Connected${NC}"

# Download base
echo -e "${BLUE}[2/5]${NC} Downloading base system..."
BASE_URL="https://sourceforge.net/projects/wolfos/files/gaming/base"
wget --progress=bar:force "${BASE_URL}/cybr-base-latest.squashfs" -O /tmp/cybr-base.squashfs

# Partition selection
echo -e "${BLUE}[3/5]${NC} Available disks:"
lsblk -d -n -o NAME,SIZE,TYPE | grep disk | nl
read -p "Select disk number: " DISK_NUM
DISK="/dev/$(lsblk -d -n -o NAME,TYPE | grep disk | sed -n "${DISK_NUM}p" | awk '\''{print $1}'\'')"

echo -e "${RED}WARNING: This will erase ${DISK}!${NC}"
read -p "Continue? (yes/no): " CONFIRM
[[ "$CONFIRM" != "yes" ]] && exit 1

# Partition & format
echo -e "${BLUE}[4/5]${NC} Partitioning ${DISK}..."
parted -s ${DISK} mklabel gpt
parted -s ${DISK} mkpart primary fat32 1MiB 513MiB
parted -s ${DISK} set 1 esp on
parted -s ${DISK} mkpart primary ext4 513MiB 100%

mkfs.vfat -F32 ${DISK}1
mkfs.ext4 -F ${DISK}2

# Mount & extract
mount ${DISK}2 /mnt
mkdir -p /mnt/boot/efi
mount ${DISK}1 /mnt/boot/efi

echo -e "${BLUE}[5/5]${NC} Installing system..."
unsquashfs -f -d /mnt /tmp/cybr-base.squashfs

# Configure system
mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc
mount --bind /sys /mnt/sys

UUID_ROOT=$(blkid -s UUID -o value ${DISK}2)
UUID_EFI=$(blkid -s UUID -o value ${DISK}1)

cat > /mnt/etc/fstab <<FSTAB
UUID=${UUID_ROOT} / ext4 defaults 0 1
UUID=${UUID_EFI} /boot/efi vfat defaults 0 2
FSTAB

# Install GRUB
chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=Cybr ${DISK}
chroot /mnt update-grub

# Create user
chroot /mnt useradd -m -s /bin/bash -G sudo,audio,video,netdev cybruser
echo "cybruser:cybr" | chroot /mnt chpasswd

umount -R /mnt

echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}   Installation Complete!              ${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo "Username: cybruser"
echo "Password: cybr"
echo ""
read -p "Reboot now? (y/n): " REBOOT
[[ "$REBOOT" == "y" ]] && reboot
INST
          chmod +x /usr/local/bin/cybr-install
          
          # Auto-run installer on boot
          cat > /etc/systemd/system/cybr-autoinstall.service <<SVC
          [Unit]
          Description=Cybr Auto Installer
          After=network-online.target
          Wants=network-online.target
          
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/cybr-install
          StandardInput=tty
          StandardOutput=tty
          TTYPath=/dev/tty1
          
          [Install]
          WantedBy=multi-user.target
          SVC
          
          systemctl enable cybr-autoinstall.service
          CH
          
          # Copy kernel
          cp -r mini/boot/* iso/boot/
          K=$(ls iso/boot/vmlinuz-* | head -1 | sed "s|iso/boot/vmlinuz-||")
          
          # Minimal squashfs
          mksquashfs mini iso/live/filesystem.squashfs -comp xz -b 1M -Xdict-size 100%
          
          # Boot config
          cat > iso/isolinux/isolinux.cfg <<BOOT
          DEFAULT cybr
          TIMEOUT 30
          
          LABEL cybr
            SAY Booting Cybr Network Installer...
            KERNEL /boot/vmlinuz-${K}
            APPEND initrd=/boot/initrd.img-${K} boot=live components quiet splash
          BOOT
          
          cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/
          cp /usr/lib/syslinux/modules/bios/*.c32 iso/isolinux/
          
          # Create ISO
          xorriso -as mkisofs -iso-level 3 -full-iso9660-filenames -joliet -rational-rock -volid "CYBR_NET" -eltorito-boot isolinux/isolinux.bin -eltorito-catalog isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin -output "/w/${ISO_NAME}.iso" iso/
          '

      - name: Generate checksums
        run: |
          BASE_NAME="${{ steps.set-names.outputs.base_name }}"
          ISO_NAME="${{ steps.set-names.outputs.iso_name }}"
          
          sha256sum "${BASE_NAME}.squashfs" > "${BASE_NAME}.squashfs.sha256"
          sha256sum "${ISO_NAME}.iso" > "${ISO_NAME}.iso.sha256"
          
          # Create "latest" symlink files
          echo "${BASE_NAME}.squashfs" > cybr-base-latest.txt
          
          BASE_SIZE=$(($(stat -c%s "${BASE_NAME}.squashfs")/1024/1024))
          ISO_SIZE=$(($(stat -c%s "${ISO_NAME}.iso")/1024/1024))
          
          echo "### Cybr Network Installer Build Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "**Network Installer ISO:** ${ISO_NAME}.iso (${ISO_SIZE}MB)" >> $GITHUB_STEP_SUMMARY
          echo "**Base System:** ${BASE_NAME}.squashfs (${BASE_SIZE}MB)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stack:** Ubuntu 24.04 + DDE + Liquorix + Steam + Discord" >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: "cybr-network-installer"
          path: |
            ${{ steps.set-names.outputs.iso_name }}.iso
            ${{ steps.set-names.outputs.iso_name }}.iso.sha256
            ${{ steps.set-names.outputs.base_name }}.squashfs
            ${{ steps.set-names.outputs.base_name }}.squashfs.sha256
            cybr-base-latest.txt
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build-base
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "cybr-network-installer"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
          BASE_NAME: ${{ needs.build-base.outputs.base_name }}
          ISO_NAME: ${{ needs.build-base.outputs.iso_name }}
        run: |
          [ -z "$SF_USER" ] || [ -z "$SF_PASS" ] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          
          # Upload ISO to main gaming folder
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" "${ISO_NAME}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done
          
          # Upload base system to separate folder
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" "${BASE_NAME}.squashfs" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/base/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done
          
          # Upload "latest" pointer
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" cybr-base-latest.txt "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/base/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done