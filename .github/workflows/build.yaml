name: "Cybr Build (Plasma Mobile + Steam + Liquorix)"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    outputs:
      iso_name: ${{ steps.set-iso-name.outputs.iso_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set ISO name
        id: set-iso-name
        run: echo "iso_name=cybr-linux-v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache
          sudo rm -rf /usr/share/swift /usr/local/.ghcup /usr/local/share/powershell /usr/share/kotlinc /usr/local/lib/node_modules
          sudo docker system prune -af --volumes
          sudo apt-get purge -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk || true
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "=== After cleanup ==="
          df -h

      - name: Build Cybr ISO (Phosh + Steam + Liquorix)
        run: |
          ISO_NAME="${{ steps.set-iso-name.outputs.iso_name }}"
          docker build --no-cache --pull -t builder - <<'DOCKERFILE'
          FROM debian:bookworm
          RUN apt-get update && \
              apt-get install -y debootstrap squashfs-tools xorriso isolinux syslinux-efi \
                mtools wget file dosfstools gnupg2 curl && \
              apt-get clean && rm -rf /var/lib/apt/lists/*
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged -v "$PWD:/workspace" -e ISO_NAME="${ISO_NAME}" builder bash -c '
          set -euo pipefail
          
          cd /build
          
          echo "=== Setting up ISO directory structure (SYSLINUX-only boot) ==="
          mkdir -p iso/live iso/boot iso/isolinux iso/EFI/boot
          ls -la iso/
          
          # Bootstrap Debian base
          echo "=== Bootstrapping Debian ==="
          debootstrap --arch=amd64 --variant=minbase bookworm chroot http://deb.debian.org/debian/
          
          # Configure chroot
          echo "=== Configuring chroot environment ==="
          chroot chroot /bin/bash <<'\''CHROOT'\''
          set -e
          export DEBIAN_FRONTEND=noninteractive
          
          # Setup sources with contrib and non-free for Steam and Liquorix
          cat > /etc/apt/sources.list <<'\''EOF'\''
          deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
          EOF
          
          apt-get update
          
          # Install curl first for adding repositories
          apt-get install -y curl gnupg2
          
          # Add Liquorix repository using DEB822 format
          echo "=== Adding Liquorix kernel repository ==="
          mkdir -p /usr/share/keyrings
          curl -fsSL https://liquorix.net/liquorix-keyring.gpg -o /usr/share/keyrings/liquorix-archive-keyring.gpg
          
          cat > /etc/apt/sources.list.d/liquorix.sources <<'\''LIQSRC'\''
          Types: deb
          URIs: https://liquorix.net/debian
          Suites: bookworm
          Components: main
          Architectures: amd64
          Signed-By: /usr/share/keyrings/liquorix-archive-keyring.gpg
          LIQSRC
          
          apt-get update
          
          # Install Liquorix kernel instead of standard kernel
          echo "Installing Liquorix kernel, live-boot packages, and Plymouth..."
          apt-get install -y \
            linux-image-liquorix-amd64 \
            linux-headers-liquorix-amd64 \
            firmware-linux-free \
            firmware-linux-nonfree \
            live-boot \
            live-boot-initramfs-tools \
            systemd-sysv \
            dbus \
            plymouth \
            plymouth-themes
          
          # Install Plasma Mobile (KDE Mobile Desktop Environment)
          echo "Installing Plasma Mobile desktop environment..."
          apt-get install -y \
            plasma-mobile \
            plasma-nm \
            plasma-pa \
            powerdevil \
            kwin-wayland \
            kwin-wayland-backend-drm \
            sddm \
            angelfish \
            index-fm \
            kalk \
            kclock \
            krecorder \
            kweather \
            spacebar \
            vvave \
            firefox-esr \
            flatpak \
            gparted \
            ntfs-3g \
            dosfstools \
            e2fsprogs \
            git \
            curl \
            wget \
            vim \
            nano \
            network-manager \
            qtvirtualkeyboard-plugin
          
          # Enable 32-bit architecture for Steam
          echo "=== Enabling 32-bit architecture for Steam ==="
          dpkg --add-architecture i386
          apt-get update
          
          # Install Steam
          echo "Installing Steam..."
          apt-get install -y \
            steam-installer \
            libgl1-mesa-dri:amd64 \
            libgl1-mesa-dri:i386 \
            libgl1-mesa-glx:amd64 \
            libgl1-mesa-glx:i386 \
            mesa-vulkan-drivers:amd64 \
            mesa-vulkan-drivers:i386
          
          # Install Refractainstaller (lightweight alternative to Calamares)
          echo "Installing Refractainstaller..."
          apt-get install -y wget xterm rsync grub-pc grub-efi-amd64
          wget -O /tmp/refractainstaller-base.deb https://sourceforge.net/projects/refracta/files/tools/refractainstaller-base_9.5.6_all.deb/download
          wget -O /tmp/refractainstaller-gui.deb https://sourceforge.net/projects/refracta/files/tools/refractainstaller-gui_9.5.6_all.deb/download
          dpkg -i /tmp/refractainstaller-base.deb /tmp/refractainstaller-gui.deb || apt-get install -f -y
          rm /tmp/refractainstaller-*.deb
          
          # Cybr branding
          cat > /etc/os-release <<'\''OSREL'\''
          NAME="Cybr"
          PRETTY_NAME="Cybr Mobile Gaming Edition"
          ID=cybr
          ID_LIKE=debian
          VERSION_ID="1"
          HOME_URL="https://wolfos.uk/"
          OSREL
          
          # Live user setup with custom name "Cybr Mobile"
          useradd -m -s /bin/bash -G sudo,audio,video,netdev -c "Cybr Mobile" cybruser
          echo "cybruser:live" | chpasswd
          echo "root:root" | chpasswd
          
          # SDDM autologin for live user (Plasma Mobile uses SDDM)
          mkdir -p /etc/sddm.conf.d
          cat > /etc/sddm.conf.d/autologin.conf <<'\''SDDM'\''
          [Autologin]
          User=cybruser
          Session=plasma-mobile.desktop
          
          [General]
          InputMethod=qtvirtualkeyboard
          SDDM
          
          # Configure Plasma Mobile session as default
          mkdir -p /var/lib/AccountsService/users
          cat > /var/lib/AccountsService/users/cybruser <<'\''ACCT'\''
          [User]
          Session=plasma-mobile
          XSession=plasma-mobile
          Icon=/usr/share/pixmaps/cybr-logo.png
          SystemAccount=false
          ACCT
          
          # Desktop launcher for installer
          mkdir -p /home/cybruser/Desktop
          cat > /home/cybruser/Desktop/calamares.desktop <<'\''DESK'\''
          [Desktop Entry]
          Type=Application
          Name=Install Cybr Linux
          Exec=pkexec calamares
          Icon=calamares
          Terminal=false
          DESK
          chmod +x /home/cybruser/Desktop/calamares.desktop
          
          # Auto-start Calamares on first boot
          mkdir -p /home/cybruser/.config/autostart
          cat > /home/cybruser/.config/autostart/calamares-firstboot.desktop <<'\''AUTOSTART'\''
          [Desktop Entry]
          Type=Application
          Name=Cybr Installer
          Exec=sh -c "sleep 5 && pkexec calamares"
          Icon=calamares
          Terminal=false
          X-GNOME-Autostart-enabled=true
          Comment=Launch Cybr installer on first boot
          AUTOSTART
          chmod +x /home/cybruser/.config/autostart/calamares-firstboot.desktop
          
          # Desktop launcher for Steam
          cat > /home/cybruser/Desktop/steam.desktop <<'\''STEAM'\''
          [Desktop Entry]
          Type=Application
          Name=Steam
          Exec=steam
          Icon=steam
          Terminal=false
          STEAM
          chmod +x /home/cybruser/Desktop/steam.desktop
          
          chown -R cybruser:cybruser /home/cybruser
          
          # Enable services
          systemctl enable sddm NetworkManager
          
          # Cleanup
          apt-get clean
          rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt/archives/*.deb
          CHROOT
          
          echo "=== Copying kernel and initrd to ISO ==="
          echo "Contents of chroot/boot:"
          ls -la chroot/boot/
          
          # Copy kernel and initrd to ISO boot directory
          cp -rv chroot/boot/* iso/boot/
          
          echo "=== Verifying boot files ==="
          ls -lh iso/boot/
          
          # Get Liquorix kernel version
          KERNEL_VERSION=$(ls iso/boot/vmlinuz-*-liquorix-amd64 | head -n1 | sed "s|iso/boot/vmlinuz-||")
          echo "Liquorix Kernel version: $KERNEL_VERSION"
          
          echo "=== Creating squashfs ==="
          # Create squashfs - EXCLUDE boot since we copied it separately
          mksquashfs chroot iso/live/filesystem.squashfs -comp xz -b 1M -Xdict-size 100% -e boot
          echo "Squashfs created:"
          ls -lh iso/live/filesystem.squashfs
          
          # Download splash
          wget -O iso/isolinux/splash.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641" || true
          
          # ========================================
          # BIOS BOOT: ISOLINUX configuration
          # ========================================
          echo "=== Setting up ISOLINUX (BIOS boot) ==="
          
          cat > iso/isolinux/isolinux.cfg <<ISOLINUX
          UI vesamenu.c32
          MENU TITLE Cybr Mobile Gaming - Boot Menu
          MENU BACKGROUND splash.png
          MENU COLOR title 1;36;44 #9033ccff #a0000000
          MENU COLOR sel 7;37;40 #e0ffffff #20ff8000
          DEFAULT live
          TIMEOUT 150
          
          LABEL live
            MENU LABEL Cybr (Live - Liquorix Kernel)
            KERNEL /boot/vmlinuz-${KERNEL_VERSION}
            APPEND initrd=/boot/initrd.img-${KERNEL_VERSION} boot=live components quiet splash plymouth.ignore-serial-consoles live-media-path=/live
          
          LABEL live-safe
            MENU LABEL Cybr (Safe Graphics)
            KERNEL /boot/vmlinuz-${KERNEL_VERSION}
            APPEND initrd=/boot/initrd.img-${KERNEL_VERSION} boot=live components nomodeset plymouth.ignore-serial-consoles live-media-path=/live
          
          LABEL live-failsafe
            MENU LABEL Cybr (Failsafe)
            KERNEL /boot/vmlinuz-${KERNEL_VERSION}
            APPEND initrd=/boot/initrd.img-${KERNEL_VERSION} boot=live components noapic noacpi nosplash nomodeset irqpoll live-media-path=/live
          ISOLINUX
          
          # Copy isolinux files
          cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/
          cp /usr/lib/syslinux/modules/bios/*.c32 iso/isolinux/
          
          # Verify isolinux files
          ls -lh iso/isolinux/
          
          # ========================================
          # UEFI BOOT: Simple SYSLINUX configuration (NO GRUB, NO COM32!)
          # ========================================
          echo "=== Setting up SYSLINUX for UEFI boot (NO GRUB, NO COM32) ==="
          
          # Create simple SYSLINUX config for UEFI (no menu, no .c32 modules)
          cat > iso/EFI/boot/syslinux.cfg <<SYSLINUX
          DEFAULT live
          TIMEOUT 50
          
          LABEL live
            LINUX /boot/vmlinuz-${KERNEL_VERSION}
            APPEND boot=live components quiet splash plymouth.ignore-serial-consoles live-media-path=/live
            INITRD /boot/initrd.img-${KERNEL_VERSION}
          
          LABEL live-safe
            LINUX /boot/vmlinuz-${KERNEL_VERSION}
            APPEND boot=live components nomodeset plymouth.ignore-serial-consoles live-media-path=/live
            INITRD /boot/initrd.img-${KERNEL_VERSION}
          
          LABEL live-failsafe
            LINUX /boot/vmlinuz-${KERNEL_VERSION}
            APPEND boot=live components noapic noacpi nosplash nomodeset irqpoll live-media-path=/live
            INITRD /boot/initrd.img-${KERNEL_VERSION}
          SYSLINUX
          
          # Copy SYSLINUX EFI bootloader
          cp /usr/lib/SYSLINUX.EFI/efi64/syslinux.efi iso/EFI/boot/bootx64.efi
          
          # Copy only essential EFI modules (ldlinux.e64 is required)
          cp /usr/lib/syslinux/modules/efi64/ldlinux.e64 iso/EFI/boot/ || true
          
          # Verify EFI setup
          echo "=== Verifying UEFI boot setup ==="
          ls -lh iso/EFI/boot/
          
          # Create ESP image for UEFI boot
          echo "=== Creating EFI System Partition image ==="
          dd if=/dev/zero of=efiboot.img bs=1M count=10
          mkfs.vfat efiboot.img
          
          # Mount and copy EFI boot files
          mkdir -p efi_mount
          mount -o loop efiboot.img efi_mount
          mkdir -p efi_mount/EFI/boot
          cp -r iso/EFI/boot/* efi_mount/EFI/boot/
          umount efi_mount
          rmdir efi_mount
          
          mv efiboot.img iso/
          
          # Final verification of ISO structure
          echo "=== Final ISO structure ==="
          find iso/ -type f -ls
          
          # Create ISO with SYSLINUX boot (NO GRUB!)
          echo "=== Creating ISO image with SYSLINUX boot ==="
          xorriso -as mkisofs \
            -iso-level 3 \
            -full-iso9660-filenames \
            -joliet \
            -joliet-long \
            -rational-rock \
            -volid "CYBR_MOBILE" \
            -appid "Cybr Mobile Gaming Edition" \
            -publisher "https://wolfos.uk" \
            -preparer "Cybr Build System (Phosh + Steam + Liquorix)" \
            -eltorito-boot isolinux/isolinux.bin \
            -eltorito-catalog isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
            -eltorito-alt-boot \
            -e efiboot.img \
            -no-emul-boot \
            -isohybrid-gpt-basdat \
            -output "/workspace/${ISO_NAME}.iso" \
            iso/
          
          echo "=== Build complete ==="
          echo "ISO created successfully: ${ISO_NAME}.iso"
          echo "Desktop Environment: Plasma Mobile (KDE mobile shell)"
          echo "Kernel: Liquorix (optimized for gaming)"
          echo "Gaming Platform: Steam included"
          echo "Boot method: SYSLINUX (BIOS) + SYSLINUX (UEFI) - NO GRUB!"
          ls -lh "/workspace/${ISO_NAME}.iso"
          '

      - name: Verify ISO contents
        run: |
          echo "=== Verifying ISO contents ==="
          sudo apt-get update && sudo apt-get install -y xorriso
          xorriso -indev "${{ steps.set-iso-name.outputs.iso_name }}.iso" -find / -exec report_lba -- 2>&1 | grep -E "(vmlinuz|initrd|filesystem.squashfs)" || echo "Files found in ISO"

      - name: Generate checksums
        run: |
          ISO_NAME="${{ steps.set-iso-name.outputs.iso_name }}"
          sha256sum "${ISO_NAME}.iso" > "${ISO_NAME}.iso.sha256"
          ISO_SIZE=$(($(stat -c%s "${ISO_NAME}.iso")/1024/1024))
          echo "### Cybr Mobile Gaming Edition Build Complete! ðŸ“±ðŸŽ®ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "**ISO:** ${ISO_NAME}.iso" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${ISO_SIZE}MB" >> $GITHUB_STEP_SUMMARY
          echo "**Desktop:** Plasma Mobile (KDE Mobile)" >> $GITHUB_STEP_SUMMARY
          echo "**Kernel:** Liquorix (Gaming Optimized)" >> $GITHUB_STEP_SUMMARY
          echo "**Gaming:** Steam Pre-installed" >> $GITHUB_STEP_SUMMARY
          echo "**Boot Method:** SYSLINUX (BIOS + UEFI) - NO GRUB" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256:** \`$(cat ${ISO_NAME}.iso.sha256 | cut -d' ' -f1)\`" >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.set-iso-name.outputs.iso_name }}"
          path: |
            ${{ steps.set-iso-name.outputs.iso_name }}.iso
            ${{ steps.set-iso-name.outputs.iso_name }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ needs.build.outputs.iso_name }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
          ISO_NAME: ${{ needs.build.outputs.iso_name }}
        run: |
          [ -z "$SF_USER" ] || [ -z "$SF_PASS" ] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "${ISO_NAME}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done