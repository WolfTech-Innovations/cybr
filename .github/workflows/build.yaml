name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    outputs:
      iso_name: ${{ steps.set-iso-name.outputs.iso_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set ISO name
        id: set-iso-name
        run: echo "iso_name=cybr-gaming-v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache /usr/share/swift /usr/local/.ghcup /usr/local/share/powershell /usr/share/kotlinc /usr/local/lib/node_modules
          sudo docker system prune -af --volumes
          sudo apt-get purge -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk || true
          sudo apt-get autoremove -y && sudo apt-get clean

      - name: Build Cybr i3 Gaming ISO
        run: |
          ISO_NAME="${{ steps.set-iso-name.outputs.iso_name }}"
          docker run --rm --privileged -v "$PWD:/w" -e ISO_NAME="${ISO_NAME}" debian:12 bash -c '
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y debootstrap squashfs-tools xorriso isolinux syslinux-efi grub-efi-amd64-bin mtools wget dosfstools gnupg2 curl
          
          mkdir -p iso/{live,boot,isolinux,EFI/BOOT}
          
          # Create minimal Debian base
          debootstrap --arch=amd64 --variant=minbase bookworm chroot http://deb.debian.org/debian/
          
          chroot chroot bash <<'\''CH'\''
          export DEBIAN_FRONTEND=noninteractive
          
          # Configure APT sources
          cat > /etc/apt/sources.list <<E
          deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
          deb http://security.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
          E
          
          apt-get update
          
          # Install base system
          apt-get install -y --no-install-recommends \
            firmware-linux-free \
            firmware-linux-nonfree \
            live-boot \
            systemd-sysv \
            dbus \
            ca-certificates \
            locales \
            sudo \
            network-manager \
            curl \
            gnupg
          
          # Add Liquorix repository
          curl 'https://liquorix.net/add-liquorix-repo.sh' | bash
          apt-get update
          
          # Install ONLY Liquorix kernel image (not headers - saves ~50MB)
          apt-get install -y --no-install-recommends linux-image-liquorix-amd64
          
          # Install MINIMAL X11 (not full xorg)
          apt-get install -y --no-install-recommends \
            xserver-xorg-core \
            xserver-xorg-input-libinput \
            xserver-xorg-video-fbdev \
            xserver-xorg-video-vesa \
            xserver-xorg-video-intel \
            xserver-xorg-video-amdgpu \
            xinit \
            i3-wm \
            i3status \
            dmenu \
            feh \
            lightdm \
            slick-greeter \
            squeekboard \
            plank
          
          # Install lightweight file manager and apps (NO DOLPHIN/KDE)
          apt-get install -y --no-install-recommends \
            pcmanfm \
            lxterminal \
            firefox-esr
          
          # Install utilities
          apt-get install -y --no-install-recommends \
            nano \
            wget \
            curl \
            htop \
            parted \
            gparted \
            ntfs-3g \
            e2fsprogs
          
          # Install gaming packages - Steam/Discord auto-install on disk installation
          apt-get install -y --no-install-recommends \
            mesa-vulkan-drivers:amd64 \
            libgl1:amd64 \
            mangohud
          
          # Download installers for post-install (will be run by Calamares)
          mkdir -p /opt/cybr-installers
          
          # Create post-install script that Calamares will run
          cat > /opt/cybr-installers/post-install.sh <<'POSTINST'
#!/bin/bash
# This runs after Calamares installs to disk
echo "Installing Steam and Discord..."

# Enable 32-bit architecture for Steam
dpkg --add-architecture i386
apt-get update

# Install Steam
apt-get install -y steam-installer

# Install Discord
cd /tmp
wget -O discord.deb "https://discord.com/api/download?platform=linux&format=deb"
apt-get install -y ./discord.deb || apt-get install -f -y
rm -f discord.deb

echo "Steam and Discord installed!"
POSTINST
          chmod +x /opt/cybr-installers/post-install.sh
          
          # Create desktop installer (for live session)
          cat > /usr/local/bin/install-steam-discord <<'LIVEINSTALL'
#!/bin/bash
echo "Installing Steam and Discord to live session..."
dpkg --add-architecture i386
apt-get update
apt-get install -y steam-installer
cd /tmp
wget -O discord.deb "https://discord.com/api/download?platform=linux&format=deb"
apt-get install -y ./discord.deb || apt-get install -f -y
rm discord.deb
echo "Done! Launch from menu."
LIVEINSTALL
          chmod +x /usr/local/bin/install-steam-discord
          
          # Install Calamares
          apt-get install -y --no-install-recommends \
            calamares \
            qml-module-qtquick2 \
            squashfs-tools
          
          # Configure locales
          echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
          locale-gen
          update-locale LANG=en_US.UTF-8
          
          # Install Calamares installer (minimal)
          apt-get install -y --no-install-recommends \
            calamares \
            qml-module-qtquick2 \
            squashfs-tools
          
          # Configure OS branding
          cat > /etc/os-release <<O
          NAME="Cybr Gaming"
          PRETTY_NAME="Cybr Gaming Edition"
          ID=cybr
          ID_LIKE=debian
          VERSION_ID="1.0"
          VERSION="1.0 (i3 + Latte Dock)"
          HOME_URL="https://getcybr.org/"
          SUPPORT_URL="https://github.com/WolfTech-Innovations/cybr"
          BUG_REPORT_URL="https://github.com/WolfTech-Innovations/cybr/issues"
          O
          
          # Download Cybr logo
          wget -O /usr/share/pixmaps/cybr-logo.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641" || \
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > /usr/share/pixmaps/cybr-logo.png
          
          # Configure LightDM autologin
          mkdir -p /etc/lightdm/lightdm.conf.d
          cat > /etc/lightdm/lightdm.conf.d/50-autologin.conf <<LDM
          [Seat:*]
          autologin-user=cybruser
          autologin-user-timeout=0
          LDM
          
          # Create user
          useradd -m -s /bin/bash -G sudo,audio,video,netdev,plugdev,input -c "Cybr User" cybruser
          echo "cybruser:live" | chpasswd
          echo "root:root" | chpasswd
          
          # Configure i3 with Plank dock
          mkdir -p /home/cybruser/.config/i3
          cat > /home/cybruser/.config/i3/config <<I3CFG
          set \$mod Mod4
          
          font pango:monospace 10
          
          exec --no-startup-id plank
          exec --no-startup-id feh --bg-scale /usr/share/pixmaps/cybr-logo.png
          exec --no-startup-id nm-applet
          
          bindsym \$mod+Return exec lxterminal
          bindsym \$mod+d exec dmenu_run
          bindsym \$mod+Shift+q kill
          bindsym \$mod+Shift+c reload
          bindsym \$mod+Shift+r restart
          bindsym \$mod+k exec squeekboard
          
          bindsym \$mod+h focus left
          bindsym \$mod+j focus down
          bindsym \$mod+k focus up
          bindsym \$mod+l focus right
          
          bindsym \$mod+f fullscreen toggle
          
          bindsym \$mod+1 workspace 1
          bindsym \$mod+2 workspace 2
          bindsym \$mod+3 workspace 3
          bindsym \$mod+4 workspace 4
          
          bar {
              status_command i3status
              position top
          }
          I3CFG
          
          # Configure Plank dock
          mkdir -p /home/cybruser/.config/plank/dock1
          cat > /home/cybruser/.config/plank/dock1/settings <<PLANKSET
          [PlankDockPreferences]
          Theme=Gtk+
          Position=3
          Alignment=50
          ItemsAlignment=3
          HideMode=3
          IconSize=48
          ShowDockItem=false
          PLANKSET
          
          # Create desktop shortcuts
          mkdir -p /home/cybruser/Desktop
          
          cat > /home/cybruser/Desktop/install-cybr.desktop <<INST
          [Desktop Entry]
          Type=Application
          Name=Install Cybr
          Exec=pkexec calamares
          Icon=system-software-install
          Terminal=false
          Categories=System;
          INST
          
          cat > /home/cybruser/Desktop/steam.desktop <<STEAM
          [Desktop Entry]
          Type=Application
          Name=Steam
          Exec=steam
          Icon=steam
          Terminal=false
          Categories=Game;
          STEAM
          
          cat > /home/cybruser/Desktop/discord.desktop <<DISC
          [Desktop Entry]
          Type=Application
          Name=Discord
          Exec=/usr/bin/discord
          Icon=discord
          Terminal=false
          Categories=Network;
          DISC
          
          cat > /home/cybruser/Desktop/dolphin.desktop <<DOLPH
          [Desktop Entry]
          Type=Application
          Name=Dolphin File Manager
          Exec=dolphin
          Icon=folder
          Terminal=false
          Categories=System;FileManager;
          DOLPH
          
          chmod +x /home/cybruser/Desktop/*.desktop
          chown -R cybruser:cybruser /home/cybruser
          
          # Add Plank launchers
          mkdir -p /home/cybruser/.config/plank/dock1/launchers
          
          # Firefox launcher for Plank
          cat > /home/cybruser/.config/plank/dock1/launchers/firefox.dockitem <<FFPLANK
          [PlankDockItemPreferences]
          Launcher=file:///usr/share/applications/firefox-esr.desktop
          FFPLANK
          
          # File manager launcher for Plank
          cat > /home/cybruser/.config/plank/dock1/launchers/pcmanfm.dockitem <<FMPLANK
          [PlankDockItemPreferences]
          Launcher=file:///usr/share/applications/pcmanfm.desktop
          FMPLANK
          
          # Terminal launcher for Plank
          cat > /home/cybruser/.config/plank/dock1/launchers/lxterminal.dockitem <<TERMPLANK
          [PlankDockItemPreferences]
          Launcher=file:///usr/share/applications/lxterminal.desktop
          TERMPLANK
          
          chown -R cybruser:cybruser /home/cybruser/.config/plank
          
          # Install UPX for compression
          apt-get install -y --no-install-recommends upx-ucl
          
          # UPX compress binaries (selective - only large ones)
          echo "Compressing large binaries with UPX..."
          find /usr/bin -type f -executable -size +500k -exec upx --best --lzma {} \; 2>/dev/null || true
          find /usr/lib -type f -name "*.so*" -size +1M -exec upx --best --lzma {} \; 2>/dev/null || true
          find /usr/lib/firefox-esr -type f -executable -size +500k -exec upx --best --lzma {} \; 2>/dev/null || true
          
          # Remove UPX
          apt-get purge -y upx-ucl
          apt-get autoremove -y
          
          # Aggressive cleanup
          find /usr/share/doc -depth -type f ! -name copyright -delete 2>/dev/null || true
          find /usr/share/man -depth -type f -delete 2>/dev/null || true
          find /usr/share/groff -depth -type f -delete 2>/dev/null || true
          find /usr/share/info -depth -type f -delete 2>/dev/null || true
          find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name "en*" -exec rm -rf {} + 2>/dev/null || true
          rm -rf /var/cache/man/* /var/lib/apt/lists/* /tmp/* /var/tmp/*
          rm -rf /var/log/*.log
          find / -name "*.pyc" -delete 2>/dev/null || true
          find / -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # Enable services
          systemctl enable lightdm NetworkManager
          CH
          
          # Copy kernel and initramfs
          cp -r chroot/boot/* iso/boot/
          K=$(ls iso/boot/vmlinuz-* | head -1 | sed "s|iso/boot/vmlinuz-||")
          
          # Create squashfs with MAXIMUM XZ compression (much better than ZSTD for size)
          mksquashfs chroot iso/live/filesystem.squashfs -comp xz -Xbcj x86 -b 1M -Xdict-size 100% -no-recovery -no-exports -no-duplicates -no-fragments
          
          # Create boot menu (BIOS)
          cat > iso/isolinux/isolinux.cfg <<BOOT
          UI vesamenu.c32
          MENU TITLE Cybr Gaming - Boot Menu
          PROMPT 0
          TIMEOUT 300
          DEFAULT live
          
          LABEL live
            MENU LABEL Cybr Gaming (i3 + Latte Dock)
            KERNEL /boot/vmlinuz-${K}
            APPEND initrd=/boot/initrd.img-${K} boot=live components quiet splash
          
          LABEL live-safe
            MENU LABEL Cybr Gaming (Safe Graphics)
            KERNEL /boot/vmlinuz-${K}
            APPEND initrd=/boot/initrd.img-${K} boot=live components nomodeset
          BOOT
          
          # Setup BIOS boot
          cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/
          cp /usr/lib/syslinux/modules/bios/*.c32 iso/isolinux/
          
          # Create GRUB EFI boot (simpler and more reliable than Syslinux EFI)
          grub-mkstandalone \
            --format=x86_64-efi \
            --output=iso/EFI/BOOT/BOOTX64.EFI \
            --locales="" \
            --fonts="" \
            "boot/grub/grub.cfg=iso/EFI/BOOT/grub.cfg"
          
          cat > iso/EFI/BOOT/grub.cfg <<GRUB
          set timeout=30
          set default=0
          
          menuentry "Cybr Gaming (i3 + Latte Dock)" {
              linux /boot/vmlinuz-${K} boot=live components quiet splash
              initrd /boot/initrd.img-${K}
          }
          
          menuentry "Cybr Gaming (Safe Graphics)" {
              linux /boot/vmlinuz-${K} boot=live components nomodeset
              initrd /boot/initrd.img-${K}
          }
          GRUB
          
          # Create El Torito EFI boot image
          dd if=/dev/zero of=efiboot.img bs=1M count=10
          mkfs.vfat efiboot.img
          mkdir efi_mount
          mount -o loop efiboot.img efi_mount
          mkdir -p efi_mount/EFI/BOOT
          cp iso/EFI/BOOT/BOOTX64.EFI efi_mount/EFI/BOOT/
          umount efi_mount
          rmdir efi_mount
          mv efiboot.img iso/
          
          # Create ISO
          xorriso -as mkisofs \
            -iso-level 3 \
            -full-iso9660-filenames \
            -joliet \
            -rational-rock \
            -volid "CYBR_GAMING" \
            -eltorito-boot isolinux/isolinux.bin \
            -eltorito-catalog isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
            -eltorito-alt-boot \
            -e efiboot.img \
            -no-emul-boot \
            -isohybrid-gpt-basdat \
            -output "/w/${ISO_NAME}.iso" \
            iso/
          '

      - name: Generate checksums
        run: |
          ISO_NAME="${{ steps.set-iso-name.outputs.iso_name }}"
          sha256sum "${ISO_NAME}.iso" > "${ISO_NAME}.iso.sha256"
          ISO_SIZE=$(($(stat -c%s "${ISO_NAME}.iso")/1024/1024))
          echo "### Cybr Gaming Edition Build Complete! ðŸŽ®ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "**ISO:** ${ISO_NAME}.iso | **Size:** ${ISO_SIZE}MB" >> $GITHUB_STEP_SUMMARY
          echo "**Base:** Debian 12 Minimal | **Desktop:** i3 + Plank Dock | **Kernel:** Liquorix (gaming-optimized)" >> $GITHUB_STEP_SUMMARY
          echo "**Apps:** Firefox, Steam/Discord (auto-install on disk), MangoHud, Calamares" >> $GITHUB_STEP_SUMMARY
          echo "**Optimizations:** Liquorix 1000Hz, Hard Preemption, BFQ I/O, TCP BBR2, Zen Tuning" >> $GITHUB_STEP_SUMMARY
          echo "**Post-Install:** Steam & Discord automatically installed during Calamares installation" >> $GITHUB_STEP_SUMMARY
          echo "**Compression:** Selective UPX on large binaries + Maximum XZ squashfs" >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.set-iso-name.outputs.iso_name }}"
          path: |
            ${{ steps.set-iso-name.outputs.iso_name }}.iso
            ${{ steps.set-iso-name.outputs.iso_name }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ needs.build.outputs.iso_name }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
          ISO_NAME: ${{ needs.build.outputs.iso_name }}
        run: |
          [ -z "$SF_USER" ] || [ -z "$SF_PASS" ] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" "${ISO_NAME}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done