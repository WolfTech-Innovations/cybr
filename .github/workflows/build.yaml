name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-linux-v${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache
          sudo rm -rf /usr/share/swift /usr/local/.ghcup /usr/local/share/powershell /usr/share/kotlinc /usr/local/lib/node_modules
          sudo docker system prune -af --volumes
          sudo apt-get purge -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk || true
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "=== After cleanup ==="
          df -h

      - name: Build Cybr Linux ISO
        run: |
          docker build --no-cache --pull -t builder - <<'DOCKERFILE'
          FROM debian:bookworm
          RUN apt-get update && \
              apt-get install -y debootstrap squashfs-tools xorriso isolinux syslinux-efi \
                grub-pc-bin grub-efi-amd64-bin mtools wget file && \
              apt-get clean && rm -rf /var/lib/apt/lists/*
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged -v "$PWD:/workspace" -e ISO_NAME="${{ env.ISO_NAME }}" builder bash -c '
          set -euo pipefail
          
          cd /build
          mkdir -p iso/{live,boot/grub,isolinux,EFI/boot}
          
          # Bootstrap Debian base
          echo "=== Bootstrapping Debian ==="
          debootstrap --arch=amd64 --variant=minbase bookworm chroot http://deb.debian.org/debian/
          
          # Configure chroot
          echo "=== Configuring chroot environment ==="
          chroot chroot /bin/bash <<'\''CHROOT'\''
          set -e
          export DEBIAN_FRONTEND=noninteractive
          
          # Setup sources
          cat > /etc/apt/sources.list <<'\''EOF'\''
          deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
          EOF
          
          apt-get update
          
          # Install kernel and live-boot with firmware
          echo "Installing kernel and live-boot packages..."
          apt-get install -y \
            linux-image-amd64 \
            linux-headers-amd64 \
            firmware-linux-free \
            firmware-linux-nonfree \
            live-boot \
            live-boot-initramfs-tools \
            systemd-sysv \
            dbus
          
          # Install KDE Plasma
          echo "Installing KDE Plasma..."
          apt-get install -y \
            kde-plasma-desktop \
            sddm \
            firefox-esr \
            dolphin \
            konsole \
            kate \
            gwenview \
            ark \
            kcalc \
            kde-spectacle \
            flatpak \
            plasma-nm \
            plasma-pa \
            breeze-gtk-theme \
            papirus-icon-theme \
            gparted \
            ntfs-3g \
            dosfstools \
            e2fsprogs \
            git \
            curl \
            wget \
            vim \
            nano \
            network-manager \
            network-manager-gnome
          
          # Install Calamares
          apt-get install -y calamares calamares-settings-debian
          
          # Cybr branding
          cat > /etc/os-release <<'\''OSREL'\''
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux"
          ID=cybr
          ID_LIKE=debian
          VERSION_ID="1"
          HOME_URL="https://wolfos.uk/"
          OSREL
          
          # Download logo
          wget -O /usr/share/pixmaps/cybr-logo.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641" || \
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==" | base64 -d > /usr/share/pixmaps/cybr-logo.png
          
          # Calamares config
          mkdir -p /etc/calamares
          cat > /etc/calamares/settings.conf <<'\''CALACONF'\''
          modules-search: [ local ]
          sequence:
            - show:
              - welcome
              - locale
              - keyboard
              - partition
              - users
              - summary
            - exec:
              - partition
              - mount
              - unpackfs
              - machineid
              - fstab
              - locale
              - keyboard
              - localecfg
              - users
              - displaymanager
              - networkcfg
              - hwclock
              - services-systemd
              - bootloader-config
              - grubcfg
              - packages
              - umount
            - show:
              - finished
          
          branding: cybr
          dont-chroot: false
          CALACONF
          
          # Branding module
          mkdir -p /etc/calamares/branding/cybr
          cat > /etc/calamares/branding/cybr/branding.desc <<'\''BRAND'\''
          componentName: cybr
          welcomeStyleCalamares: false
          strings:
            productName: Cybr Linux
            productUrl: https://wolfos.uk/
            productLogo: cybr-logo.png
            productIcon: cybr-logo.png
          images:
            productLogo: cybr-logo.png
            productIcon: cybr-logo.png
          style:
            sidebarBackground: "#0a0a0a"
            sidebarText: "#ffffff"
          BRAND
          
          cp /usr/share/pixmaps/cybr-logo.png /etc/calamares/branding/cybr/ 2>/dev/null || true
          
          # Module configs
          cat > /etc/calamares/modules/unpackfs.conf <<'\''UNPACK'\''
          unpack:
            - source: "/run/live/medium/live/filesystem.squashfs"
              sourcefs: "squashfs"
              destination: ""
          UNPACK
          
          cat > /etc/calamares/modules/users.conf <<'\''USERS'\''
          defaultGroups:
            - name: users
              must_exist: true
              system: true
            - cdrom
            - floppy
            - sudo
            - audio
            - video
            - netdev
            - plugdev
          autologinGroup: autologin
          sudoersGroup: sudo
          setRootPassword: true
          USERS
          
          cat > /etc/calamares/modules/displaymanager.conf <<'\''DM'\''
          displaymanagers:
            - sddm
          basicSetup: false
          DM
          
          # Live user setup
          useradd -m -s /bin/bash -G sudo,audio,video,netdev liveuser
          echo "liveuser:live" | chpasswd
          echo "root:root" | chpasswd
          
          # SDDM autologin for live
          mkdir -p /etc/sddm.conf.d
          cat > /etc/sddm.conf.d/autologin.conf <<'\''SDDM'\''
          [Autologin]
          User=liveuser
          Session=plasma
          SDDM
          
          # KDE config
          mkdir -p /home/liveuser/.config
          cat > /home/liveuser/.config/kdeglobals <<'\''KDE'\''
          [General]
          ColorScheme=BreezeDark
          [KDE]
          LookAndFeelPackage=org.kde.breezedark.desktop
          [Icons]
          Theme=Papirus-Dark
          KDE
          
          # Desktop launcher
          mkdir -p /home/liveuser/Desktop
          cat > /home/liveuser/Desktop/calamares.desktop <<'\''DESK'\''
          [Desktop Entry]
          Type=Application
          Name=Install Cybr Linux
          Exec=pkexec calamares
          Icon=calamares
          Terminal=false
          DESK
          chmod +x /home/liveuser/Desktop/calamares.desktop
          
          chown -R liveuser:liveuser /home/liveuser
          
          # Enable services
          systemctl enable sddm NetworkManager
          
          # Update initramfs to include live-boot
          update-initramfs -u
          
          # Cleanup
          apt-get clean
          rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt/archives/*.deb
          CHROOT
          
          echo "=== Preparing ISO directories ==="
          # Ensure all ISO directories exist
          mkdir -p iso/live iso/boot/grub iso/isolinux iso/EFI/boot
          ls -la iso/
          
          echo "=== Creating squashfs ==="
          # Create squashfs - DO NOT exclude boot, kernel modules are needed
          mksquashfs chroot iso/live/filesystem.squashfs -comp xz -b 1M -Xdict-size 100%
          
          echo "=== Copying kernel and initrd ==="
          # Verify iso/live exists
          if [ ! -d "iso/live" ]; then
            echo "ERROR: iso/live directory does not exist!"
            mkdir -p iso/live
            echo "Created iso/live directory"
          fi
          # List what we have in chroot/boot
          echo "Contents of chroot/boot:"
          ls -la chroot/boot/
          
          # Find kernel and initrd
          KERNEL=$(find chroot/boot -name "vmlinuz-*" -type f | head -n1)
          INITRD=$(find chroot/boot -name "initrd.img-*" -type f | head -n1)
          
          if [ -z "$KERNEL" ] || [ ! -f "$KERNEL" ]; then
            echo "ERROR: Kernel not found!"
            echo "Searched in chroot/boot/ for vmlinuz-*"
            exit 1
          fi
          
          if [ -z "$INITRD" ] || [ ! -f "$INITRD" ]; then
            echo "ERROR: Initrd not found!"
            echo "Searched in chroot/boot/ for initrd.img-*"
            exit 1
          fi
          
          echo "Found kernel: $KERNEL"
          echo "Found initrd: $INITRD"
          
          # Copy to ISO structure
          cp -v "$KERNEL" iso/live/vmlinuz
          cp -v "$INITRD" iso/live/initrd
          
          # Make sure they're readable
          chmod 644 iso/live/vmlinuz iso/live/initrd
          
          # Verify files were copied and are valid
          echo "=== Verifying copied files ==="
          ls -lh iso/live/
          file iso/live/vmlinuz
          file iso/live/initrd
          
          # Double-check file sizes (kernel should be several MB, initrd too)
          VMLINUZ_SIZE=$(stat -c%s iso/live/vmlinuz)
          INITRD_SIZE=$(stat -c%s iso/live/initrd)
          
          if [ "$VMLINUZ_SIZE" -lt 1000000 ]; then
            echo "ERROR: vmlinuz seems too small ($VMLINUZ_SIZE bytes)"
            exit 1
          fi
          
          if [ "$INITRD_SIZE" -lt 1000000 ]; then
            echo "ERROR: initrd seems too small ($INITRD_SIZE bytes)"
            exit 1
          fi
          
          echo "vmlinuz size: $VMLINUZ_SIZE bytes"
          echo "initrd size: $INITRD_SIZE bytes"
          
          # Download splash
          wget -O iso/isolinux/splash.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641" || true
          
          # ISOLINUX config
          cat > iso/isolinux/isolinux.cfg <<ISOLINUX
          UI vesamenu.c32
          MENU TITLE Cybr Linux Boot Menu
          MENU BACKGROUND splash.png
          MENU COLOR title 1;36;44 #9033ccff #a0000000
          MENU COLOR sel 7;37;40 #e0ffffff #20ff8000
          DEFAULT live
          TIMEOUT 150
          
          LABEL live
            MENU LABEL Cybr Linux (Live)
            KERNEL /boot/vmlinuz-${KERNEL_VERSION}
            APPEND initrd=/boot/initrd.img-${KERNEL_VERSION} boot=live components quiet splash live-media-path=/live
          
          LABEL live-safe
            MENU LABEL Cybr Linux (Safe Graphics)
            KERNEL /boot/vmlinuz-${KERNEL_VERSION}
            APPEND initrd=/boot/initrd.img-${KERNEL_VERSION} boot=live components nomodeset live-media-path=/live
          
          LABEL live-failsafe
            MENU LABEL Cybr Linux (Failsafe)
            KERNEL /boot/vmlinuz-${KERNEL_VERSION}
            APPEND initrd=/boot/initrd.img-${KERNEL_VERSION} boot=live components noapic noacpi nosplash irqpoll live-media-path=/live
          ISOLINUX
          
          # Copy isolinux files
          echo "=== Setting up ISOLINUX ==="
          cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/
          cp /usr/lib/syslinux/modules/bios/*.c32 iso/isolinux/
          
          # Verify isolinux files
          ls -lh iso/isolinux/
          
          # GRUB config for EFI
          mkdir -p iso/boot/grub
          cat > iso/boot/grub/grub.cfg <<GRUB
          set timeout=15
          set default=0
          
          insmod all_video
          insmod gfxterm
          
          menuentry "Cybr Linux (Live)" {
            linux /boot/vmlinuz-${KERNEL_VERSION} boot=live components quiet splash live-media-path=/live
            initrd /boot/initrd.img-${KERNEL_VERSION}
          }
          
          menuentry "Cybr Linux (Safe Graphics)" {
            linux /boot/vmlinuz-${KERNEL_VERSION} boot=live components nomodeset live-media-path=/live
            initrd /boot/initrd.img-${KERNEL_VERSION}
          }
          
          menuentry "Cybr Linux (Failsafe)" {
            linux /boot/vmlinuz-${KERNEL_VERSION} boot=live components noapic noacpi nosplash irqpoll live-media-path=/live
            initrd /boot/initrd.img-${KERNEL_VERSION}
          }
          GRUB
          
          # Create EFI boot image
          echo "=== Creating EFI boot image ==="
          grub-mkstandalone \
            --format=x86_64-efi \
            --output=iso/EFI/boot/bootx64.efi \
            --locales="" \
            --fonts="" \
            "boot/grub/grub.cfg=iso/boot/grub/grub.cfg"
          
          # Verify EFI file was created
          ls -lh iso/EFI/boot/
          
          # Final verification of ISO structure
          echo "=== Final ISO structure ==="
          find iso/ -type f -ls
          
          # Create ISO with proper boot configuration
          echo "=== Creating ISO image ==="
          xorriso -as mkisofs \
            -iso-level 3 \
            -full-iso9660-filenames \
            -joliet \
            -joliet-long \
            -rational-rock \
            -volid "CYBR_LINUX" \
            -appid "Cybr Linux Live" \
            -publisher "https://wolfos.uk" \
            -preparer "Cybr Build System" \
            -eltorito-boot isolinux/isolinux.bin \
            -eltorito-catalog isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
            -eltorito-alt-boot \
            -e EFI/boot/bootx64.efi \
            -no-emul-boot \
            -isohybrid-gpt-basdat \
            -output "/workspace/${ISO_NAME}.iso" \
            iso/
          
          echo "=== Build complete ==="
          echo "ISO created successfully: ${ISO_NAME}.iso"
          ls -lh "/workspace/${ISO_NAME}.iso"
          '

      - name: Verify ISO contents
        run: |
          echo "=== Verifying ISO contents ==="
          sudo apt-get update && sudo apt-get install -y xorriso
          xorriso -indev "${{ env.ISO_NAME }}.iso" -find / -exec report_lba -- 2>&1 | grep -E "(vmlinuz|initrd|filesystem.squashfs)" || echo "Files found in ISO"

      - name: Generate checksums
        run: |
          sha256sum "${{ env.ISO_NAME }}.iso" > "${{ env.ISO_NAME }}.iso.sha256"
          ISO_SIZE=$(($(stat -c%s "${{ env.ISO_NAME }}.iso")/1024/1024))
          echo "### Cybr Linux Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "**ISO:** ${{ env.ISO_NAME }}.iso" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** ${ISO_SIZE}MB" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256:** \`$(cat ${{ env.ISO_NAME }}.iso.sha256 | cut -d' ' -f1)\`" >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [ -z "$SF_USER" ] || [ -z "$SF_PASS" ] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "${{ env.ISO_NAME }}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done