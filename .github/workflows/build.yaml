name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-arch-plasma-v${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Create package list
        run: |
          cat > packages.x86_64 <<'PKGS'
          linux-lts
          linux-firmware
          base
          base-devel
          syslinux
          edk2-shell
          memtest86+
          memtest86+-efi
          mkinitcpio
          mkinitcpio-archiso
          arch-install-scripts
          pacman-contrib
          archlinux-contrib
          plasma-desktop
          plasma-workspace
          plasma-nm
          plasma-pa
          sddm
          dolphin
          konsole
          kate
          firefox
          kscreen
          networkmanager
          pipewire
          pipewire-pulse
          pipewire-jack
          pipewire-alsa
          wireplumber
          git
          curl
          wget
          xmlstarlet
          vim
          nano
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          gparted
          ntfs-3g
          dosfstools
          exfatprogs
          xf86-input-wacom
          iwd
          kvantum
          papirus-icon-theme
          upx
          PKGS
      
      - name: Build ISO
        run: |
          docker build -t builder - <<'DOCKERFILE'
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git && pacman -Scc --noconfirm
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged -v $PWD:/workspace -e ISO_NAME="${{ env.ISO_NAME }}" builder bash -c '
          set -euo pipefail
          cp -r /usr/share/archiso/configs/releng /build/cybr
          cd /build/cybr
          
          # Copy package list from workspace
          cp /workspace/packages.x86_64 .
          
          # Setup keyrings
          pacman-key --init
          pacman-key --populate archlinux
          
          # Install BlackArch using official strap.sh method
          curl -O https://blackarch.org/strap.sh
          chmod +x strap.sh
          ./strap.sh || echo "BlackArch setup optional, continuing..."
          
          # Enable parallel downloads
          sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/" pacman.conf
          
          # Sync databases
          pacman -Sy --noconfirm
          
          # OS Release
          mkdir -p airootfs/etc
          cat > airootfs/etc/os-release <<"EOF"
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux - Dawn Light Shines Upon the Arches"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          ANSI_COLOR="38;2;23;147;209"
          HOME_URL="https://wolfos.uk/"
          LOGO=archlinux-logo
          EOF
          
          # Configure mkinitcpio for archiso
          mkdir -p airootfs/etc/mkinitcpio.conf.d
          cat > airootfs/etc/mkinitcpio.conf.d/archiso.conf <<"EOF"
          MODULES=()
          BINARIES=()
          FILES=()
          HOOKS=(base udev modconf kms keyboard keymap consolefont block filesystems archiso)
          COMPRESSION="xz"
          COMPRESSION_OPTIONS=(-9e)
          EOF
          
          # Create LTS kernel preset for archiso
          mkdir -p airootfs/etc/mkinitcpio.d
          cat > airootfs/etc/mkinitcpio.d/linux-lts.preset <<"EOF"
          # mkinitcpio preset file for linux-lts with archiso
          
          ALL_config="/etc/mkinitcpio.conf.d/archiso.conf"
          ALL_kver="/boot/vmlinuz-linux-lts"
          
          PRESETS=("default" "fallback")
          
          default_image="/boot/initramfs-linux-lts.img"
          
          fallback_image="/boot/initramfs-linux-lts-fallback.img"
          fallback_options="-S autodetect"
          EOF
          
          # Create boot directory structure
          mkdir -p airootfs/boot
          
          # Ensure mkinitcpio runs during build to generate initramfs
          cat > airootfs/root/customize_airootfs.sh <<"EOF"
          #!/usr/bin/env bash
          set -e
          
          # Find the actual kernel version
          KVER=$(file -bL /boot/vmlinuz-linux-lts | grep -o "version [^ ]*" | cut -d" " -f2)
          echo "Detected kernel version: $KVER"
          
          # Generate initramfs for linux-lts
          echo "Generating initramfs for linux-lts..."
          mkinitcpio -k "$KVER" -c /etc/mkinitcpio.conf.d/archiso.conf -g /boot/initramfs-linux-lts.img
          
          # Verify kernel and initramfs exist
          if [[ ! -f /boot/vmlinuz-linux-lts ]]; then
            echo "ERROR: vmlinuz-linux-lts not found!"
            ls -la /boot/
            exit 1
          fi
          
          if [[ ! -f /boot/initramfs-linux-lts.img ]]; then
            echo "ERROR: initramfs-linux-lts.img not found!"
            ls -la /boot/
            exit 1
          fi
          
          echo "Kernel and initramfs verified successfully"
          ls -lh /boot/vmlinuz-linux-lts /boot/initramfs-linux-lts.img
          EOF
          chmod +x airootfs/root/customize_airootfs.sh
          
          # Modify profiledef.sh to ensure kernel is copied
          cat >> profiledef.sh <<"EOF"
          
          # Custom function to ensure kernel files are copied
          _make_boot_extra() {
            local _bootdir="${work_dir}/iso/arch/boot"
            mkdir -p "${_bootdir}/x86_64"
            
            # Copy kernel and initramfs from airootfs
            cp -v "${work_dir}/x86_64/airootfs/boot/vmlinuz-linux-lts" "${_bootdir}/x86_64/vmlinuz-linux-lts"
            cp -v "${work_dir}/x86_64/airootfs/boot/initramfs-linux-lts.img" "${_bootdir}/x86_64/initramfs-linux-lts.img"
            
            # Create symlinks for standard names
            ln -sf vmlinuz-linux-lts "${_bootdir}/x86_64/vmlinuz"
            ln -sf initramfs-linux-lts.img "${_bootdir}/x86_64/initramfs.img"
            
            echo "Kernel files copied to ISO boot directory:"
            ls -lh "${_bootdir}/x86_64/"
          }
          EOF
          
          # Update grub config to use correct kernel paths
          mkdir -p grub
          cat > grub/grub.cfg <<"EOF"
          set timeout=30
          set default=0
          
          menuentry "Cybr Linux - Dawn Light (x86_64, UEFI)" {
              set gfxpayload=keep
              linux /arch/boot/x86_64/vmlinuz-linux-lts archisobasedir=arch archisolabel=CYBR_202601 quiet splash
              initrd /arch/boot/x86_64/initramfs-linux-lts.img
          }
          
          menuentry "Cybr Linux - Dawn Light (x86_64, UEFI, no nouveau)" {
              set gfxpayload=keep
              linux /arch/boot/x86_64/vmlinuz-linux-lts archisobasedir=arch archisolabel=CYBR_202601 nouveau.modeset=0 quiet splash
              initrd /arch/boot/x86_64/initramfs-linux-lts.img
          }
          
          menuentry "Cybr Linux - Dawn Light (x86_64, UEFI, copy to RAM)" {
              set gfxpayload=keep
              linux /arch/boot/x86_64/vmlinuz-linux-lts archisobasedir=arch archisolabel=CYBR_202601 copytoram quiet splash
              initrd /arch/boot/x86_64/initramfs-linux-lts.img
          }
          EOF
          
          # Update syslinux config for BIOS boot
          mkdir -p syslinux
          cat > syslinux/archiso_sys.cfg <<"EOF"
          LABEL cybr
          MENU LABEL Cybr Linux - Dawn Light (x86_64, BIOS)
          LINUX /arch/boot/x86_64/vmlinuz-linux-lts
          INITRD /arch/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=arch archisolabel=CYBR_202601 quiet splash
          
          LABEL cybr_nomodeset
          MENU LABEL Cybr Linux - Dawn Light (x86_64, BIOS, nomodeset)
          LINUX /arch/boot/x86_64/vmlinuz-linux-lts
          INITRD /arch/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=arch archisolabel=CYBR_202601 nomodeset quiet splash
          EOF
          
          # Auto-update service
          mkdir -p airootfs/etc/systemd/system
          cat > airootfs/etc/systemd/system/cybr-autoupdate.service <<"EOF"
          [Unit]
          Description=Cybr Auto Update
          After=network-online.target
          ConditionACPower=true
          
          [Service]
          Type=oneshot
          Nice=19
          IOSchedulingClass=idle
          ExecStart=/usr/local/bin/cybr-autoupdate.sh
          TimeoutSec=3600
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          cat > airootfs/etc/systemd/system/cybr-autoupdate.timer <<"EOF"
          [Unit]
          Description=Cybr Auto Update Timer
          
          [Timer]
          OnCalendar=daily
          OnCalendar=03:00
          RandomizedDelaySec=30min
          Persistent=true
          
          [Install]
          WantedBy=timers.target
          EOF
          
          # Auto-update script
          mkdir -p airootfs/usr/local/bin
          cat > airootfs/usr/local/bin/cybr-autoupdate.sh <<"EOF"
          #!/bin/bash
          LOG="/var/log/cybr-autoupdate.log"
          LOCK="/var/run/cybr-autoupdate.lock"
          log() { echo "[$(date +"%Y-%m-%d %H:%M:%S")] $1" | tee -a "$LOG"; }
          
          [[ -f "$LOCK" && $(($(date +%s)-$(stat -c %Y "$LOCK" 2>/dev/null||echo 0))) -lt 86400 ]] && log "Update running" && exit 1
          [[ -f "$LOCK" ]] && rm -f "$LOCK"
          touch "$LOCK" && trap "rm -f $LOCK" EXIT INT TERM
          
          log "========== Cybr Auto-Update =========="
          ping -c1 -W5 archlinux.org &>/dev/null || { log "No network"; exit 1; }
          
          # Check Arch news
          mkdir -p /var/cache/cybr
          if curl -sm30 https://archlinux.org/feeds/news/ -o /tmp/news.rss; then
            LATEST=$(xmlstarlet sel -t -m "//item[1]" -v "pubDate" /tmp/news.rss 2>/dev/null)
            [[ -f /var/cache/cybr/last-news && "$LATEST" == "$(cat /var/cache/cybr/last-news)" ]] || {
              log "=== Arch News ===" && xmlstarlet sel -t -m "//item[position()<=3]" -n -o "• " -v "title" -n /tmp/news.rss 2>/dev/null | tee -a "$LOG"
              echo "$LATEST" > /var/cache/cybr/last-news
            }
            rm -f /tmp/news.rss
          fi
          
          log "Updating keyring..." && pacman -Sy --noconfirm --needed archlinux-keyring 2>&1 | tee -a "$LOG"
          UPDATES=$(checkupdates 2>/dev/null)
          COUNT=$(echo "$UPDATES"|grep -cv "^$")
          [[ $COUNT -eq 0 ]] && log "Up to date" && exit 0
          log "Found $COUNT updates" && echo "$UPDATES"|tee -a "$LOG"
          pacman -Su --noconfirm 2>&1|tee -a "$LOG" || { log "Update failed"; exit 1; }
          
          PACNEW=$(find /etc -name "*.pacnew" -o -name "*.pacsave" 2>/dev/null)
          [[ -n "$PACNEW" ]] && log "Config files need review:" && echo "$PACNEW"|tee -a "$LOG"
          paccache -rk3 2>&1|tee -a "$LOG"
          [[ ! -f /usr/lib/modules/$(uname -r) ]] && log "WARNING: Reboot recommended (kernel updated)"
          log "Update complete"
          EOF
          chmod +x airootfs/usr/local/bin/cybr-autoupdate.sh
          
          # UI Customization setup script
          mkdir -p airootfs/usr/local/bin
          cat > airootfs/usr/local/bin/setup-modern-ui.sh <<"EOF"
          #!/bin/bash
          # Cybr Modern UI Setup
          echo "Setting up modern UI with rounded corners and blur effects..."
          
          # Build and install KDE Rounded Corners
          cd /tmp
          git clone https://github.com/matinlotfali/KDE-Rounded-Corners
          cd KDE-Rounded-Corners
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr
          make -j$(nproc)
          sudo make install
          
          # Build Better Blur effect
          cd /tmp
          git clone https://github.com/taj-ny/kwin-effects-forceblur
          cd kwin-effects-forceblur
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr
          make -j$(nproc)
          sudo make install
          
          # Apply Layan theme (modern rounded theme)
          mkdir -p ~/.local/share/plasma/desktoptheme
          cd ~/.local/share/plasma/desktoptheme
          git clone https://github.com/vinceliuice/Layan-kde
          
          # Configure Kvantum with Layan
          mkdir -p ~/.config/Kvantum
          cd /tmp
          git clone https://github.com/vinceliuice/Layan-kde
          cp -r Layan-kde/kvantum/* ~/.config/Kvantum/
          
          # Enable effects
          kwriteconfig5 --file kwinrc --group Plugins --key kwin4_effect_shapecornersEnabled true
          kwriteconfig5 --file kwinrc --group Plugins --key blurEnabled true
          kwriteconfig5 --file kwinrc --group Effect-Blur --key BlurStrength 8
          
          # Configure Plasma panel for modern dock-like appearance
          kwriteconfig5 --file plasmashellrc --group PlasmaViews --group Panel\ 2 --key floating 1
          kwriteconfig5 --file plasmashellrc --group PlasmaViews --group Panel\ 2 --key alignment 132
          
          # Restart KWin and Plasma Shell
          kwin_x11 --replace &
          plasmashell --replace &
          
          echo "Modern UI setup complete! Restart your session for full effect."
          echo "To customize further:"
          echo "  - System Settings > Workspace Behavior > Desktop Effects"
          echo "  - Right-click panel > Configure Panel (set to floating and centered)"
          echo "  - Kvantum Manager for transparency settings"
          EOF
          chmod +x airootfs/usr/local/bin/setup-modern-ui.sh
          
          # Installation helper
          cat > airootfs/root/install-cybr.sh <<"EOF"
          #!/bin/bash
          cat <<"INFO"
          ╔════════════════════════════════════════════╗
          ║   Cybr Linux Installation Helper          ║
          ║   Dawn Light Shines Upon the Arches       ║
          ╚════════════════════════════════════════════╝
          
          Quick Install Steps:
            1. cfdisk /dev/sdX          # Partition disk
            2. mkfs.ext4 /dev/sdX1      # Format partition
            3. mount /dev/sdX1 /mnt     # Mount
            4. pacstrap /mnt base linux # Install base
            5. genfstab -U /mnt >> /mnt/etc/fstab
            6. arch-chroot /mnt         # Enter system
            7. Configure & install bootloader
          
          Or use: archinstall (automated installer)
          
          Modern UI Features:
            • Rounded corners on all windows
            • Advanced blur effects with anti-aliasing
            • Latte Dock for Mac-like experience
            • Kvantum theme engine for customization
            • Layan modern theme pre-configured
          
          After installation, run:
            /usr/local/bin/setup-modern-ui.sh
          
          Auto-Update (enabled by default):
            • Checks Arch news before updates
            • Updates daily at 3 AM
            • Runs on AC power only
            • View: journalctl -u cybr-autoupdate
          INFO
          read -p "Press Enter..."
          EOF
          chmod +x airootfs/root/install-cybr.sh
          
          # Enable services
          mkdir -p airootfs/etc/systemd/system/{multi-user.target.wants,timers.target.wants}
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          ln -sf /usr/lib/systemd/system/NetworkManager.service airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /etc/systemd/system/cybr-autoupdate.timer airootfs/etc/systemd/system/timers.target.wants/
          
          # EXTREME COMPRESSION - Configure for maximum compression
          sed -i "s/airootfs_image_type=\"squashfs\"/airootfs_image_type=\"squashfs\"/" profiledef.sh
          sed -i "s/airootfs_image_tool_options=()/airootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"100%\" \"-no-recovery\" \"-always-use-fragments\" \"-no-duplicates\")/" profiledef.sh
          
          # Build ISO with extreme compression
          echo "Building ISO with EXTREME compression settings..."
          echo "WARNING: This will take significantly longer but produce the smallest possible ISO"
          mkarchiso -v -w /tmp/work -o /tmp/out .
          
          # Verify kernel files in ISO
          echo "Verifying kernel files in ISO..."
          ISO_FILE=$(ls /tmp/out/*.iso)
          mkdir -p /tmp/iso_mount
          mount -o loop "$ISO_FILE" /tmp/iso_mount
          ls -lh /tmp/iso_mount/arch/boot/x86_64/
          if [[ ! -f /tmp/iso_mount/arch/boot/x86_64/vmlinuz-linux-lts ]]; then
            echo "ERROR: vmlinuz-linux-lts missing from ISO!"
            umount /tmp/iso_mount
            exit 1
          fi
          echo "Kernel verified in ISO!"
          umount /tmp/iso_mount
          
          mv /tmp/out/*.iso /workspace/${ISO_NAME}.iso
          '
      
      - name: Generate checksums
        run: |
          sha256sum "${{ env.ISO_NAME }}.iso" > "${{ env.ISO_NAME }}.iso.sha256"
          SIZE_MB=$(($(stat -c%s "${{ env.ISO_NAME }}.iso")/1024/1024))
          echo "ISO Size: ${SIZE_MB}MB"
      
      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
      
      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [[ -z "$SF_USER" || -z "$SF_PASS" ]] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in {1..3}; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "${{ env.ISO_NAME }}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/" && break
            [[ $i -eq 3 ]] && exit 1
            sleep 30
          done