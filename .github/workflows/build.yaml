name: "Cybr Linux - Dawn Light Shines Upon the Arches"

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: "Build variant"
        required: false
        default: "standard"
        type: choice
        options: ["minimal", "standard", "full"]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-arch-v${{ github.run_number }}"
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  build:
    name: "Build Cybr Arch Linux"
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Free Disk Space"
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h

      - name: "Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Create Arch Build Container"
        run: |
          cat > Dockerfile << 'EOF'
          FROM archlinux:latest
          
          RUN pacman -Syu --noconfirm && \
              pacman -S --noconfirm archiso git curl wget base-devel && \
              pacman -Scc --noconfirm
          
          WORKDIR /build
          EOF
          
          docker build -t cybr-arch-builder .

      - name: "Build Cybr Linux ISO"
        run: |
          docker run --rm --privileged \
            -v $PWD:/workspace \
            -e ISO_NAME="${{ env.ISO_NAME }}" \
            cybr-arch-builder \
            bash -c '
              set -euo pipefail
              
              echo "═══════════════════════════════════════════════"
              echo "  Dawn light shines upon the arches..."
              echo "  Building Cybr Linux with end-4 Hyprland"
              echo "═══════════════════════════════════════════════"
              
              # Copy archiso profile
              cp -r /usr/share/archiso/configs/releng /build/cybr
              cd /build/cybr
              
              # Add packages for end-4 Hyprland setup (illogical-impulse)
              cat >> packages.x86_64 << "PKGS"
          hyprland
          xdg-desktop-portal-hyprland
          qt5-wayland
          qt6-wayland
          kitty
          firefox
          thunar
          thunar-volman
          gvfs
          tumbler
          ffmpegthumbnailer
          file-roller
          mousepad
          pipewire
          pipewire-pulse
          pipewire-alsa
          wireplumber
          pavucontrol
          networkmanager
          network-manager-applet
          bluez
          bluez-utils
          blueman
          brightnessctl
          playerctl
          pamixer
          grim
          slurp
          wl-clipboard
          cliphist
          swww
          hyprpicker
          hypridle
          hyprlock
          wf-recorder
          nwg-look
          gtk3
          gtk4
          python
          python-pip
          python-gobject
          python-pillow
          python-requests
          python-pywayland
          python-psutil
          gjs
          gtk-layer-shell
          libdbusmenu-gtk3
          gnome-bluetooth-3.0
          power-profiles-daemon
          upower
          polkit-gnome
          gnome-keyring
          libsecret
          seahorse
          nodejs
          npm
          dart-sass
          meson
          ninja
          git
          curl
          wget
          jq
          imagemagick
          socat
          base-devel
          htop
          btop
          fastfetch
          greetd
          greetd-tuigreet
          ttf-jetbrains-mono-nerd
          ttf-font-awesome
          noto-fonts
          noto-fonts-emoji
          noto-fonts-cjk
          gcc
          python-dbus
          glib2
          PKGS
              
              # Cybr branding
              echo "cybr-linux" > airootfs/etc/hostname
              
              cat > airootfs/etc/os-release << "OS"
          NAME="Cybr"
          ID=cybr
          BUILD_ID=rolling
          PRETTY_NAME="Cybr by WolfTech Innovations"
          HOME_URL="https://wolfos.uk/"
          LOGO=cybr-logo
          OS
              
              # Setup scripts directory
              mkdir -p airootfs/usr/local/bin
              mkdir -p airootfs/usr/share/cybr
              
              # BlackArch setup script
              cat > airootfs/usr/local/bin/setup-blackarch << "BA"
          #!/bin/bash
          set -e
          echo "Setting up BlackArch repositories..."
          cd /tmp
          curl -O https://blackarch.org/strap.sh
          chmod +x strap.sh
          sudo ./strap.sh
          rm strap.sh
          sudo pacman -Sy
          echo ""
          echo "✓ BlackArch repositories configured!"
          echo "  Install security tools with: sudo pacman -S <tool-name>"
          echo "  Example: sudo pacman -S nmap metasploit burpsuite"
          BA
              chmod +x airootfs/usr/local/bin/setup-blackarch
              
              # Neo enhancements (optional)
              curl -fsSL https://raw.githubusercontent.com/WolfTech-Innovations/Neo/main/lb-hooks/0201-Neo.chroot \
                -o airootfs/usr/local/bin/neo-enhancements 2>/dev/null || echo "# Neo optional" > airootfs/usr/local/bin/neo-enhancements
              chmod +x airootfs/usr/local/bin/neo-enhancements 2>/dev/null || true
              
              # Setup AUR helper installation script for post-install
              mkdir -p airootfs/usr/local/bin
              cat > airootfs/usr/local/bin/install-aur-helper << "AURHELPER"
          #!/bin/bash
          # Install yay AUR helper for user
          if ! command -v yay &> /dev/null; then
            echo "Installing yay AUR helper..."
            cd /tmp
            git clone https://aur.archlinux.org/yay.git
            cd yay
            makepkg -si --noconfirm
            cd ..
            rm -rf yay
            echo "✓ yay installed successfully"
          else
            echo "✓ yay already installed"
          fi
          AURHELPER
              chmod +x airootfs/usr/local/bin/install-aur-helper
              
              # First boot setup with end-4 dotfiles
              cat > airootfs/usr/local/bin/cybr-first-boot << "FB"
          #!/bin/bash
          FLAG="$HOME/.config/cybr-setup-done"
          
          if [ ! -f "$FLAG" ]; then
            # Wait for internet connection
            echo "Cybr Linux - Waiting for internet connection..."
            for i in {1..30}; do
              if ping -c 1 8.8.8.8 &>/dev/null || ping -c 1 1.1.1.1 &>/dev/null; then
                echo "Internet connected!"
                break
              fi
              if [ $i -eq 30 ]; then
                notify-send "Cybr Linux" "No internet connection. Setup will run on next boot." -u critical
                exit 1
              fi
              sleep 2
            done
            
            # Open terminal with setup wizard
            kitty --title "Cybr Linux Setup" bash -c '"'"'
              clear
              echo "╔═══════════════════════════════════════════════════════╗"
              echo "║                                                       ║"
              echo "║          🌅 Cybr Linux - First Boot Setup 🌅          ║"
              echo "║                by WolfTech Innovations                ║"
              echo "║                                                       ║"
              echo "╚═══════════════════════════════════════════════════════╝"
              echo ""
              echo "Welcome to Cybr Linux with end-4'"'"'s illogical-impulse!"
              echo ""
              echo "This setup will install:"
              echo "  • end-4'"'"'s beautiful Hyprland dotfiles (illogical-impulse)"
              echo "  • AGS (Aylur'"'"'s GTK Shell) for stunning widgets"
              echo "  • AUR helper (yay) and required AUR packages"
              echo "  • BlackArch security tool repositories"
              echo "  • Neo system enhancements"
              echo ""
              echo "Press Enter to continue or Ctrl+C to skip..."
              read
              
              echo ""
              echo "═══════════════════════════════════════════════════════"
              echo "Installing AUR Helper (yay)"
              echo "═══════════════════════════════════════════════════════"
              
              if /usr/local/bin/install-aur-helper; then
                echo "✓ AUR helper ready!"
              else
                echo "⚠ AUR helper installation had issues (continuing anyway)"
              fi
              
              echo ""
              echo "═══════════════════════════════════════════════════════"
              echo "Installing AUR packages for end-4 dotfiles"
              echo "═══════════════════════════════════════════════════════"
              echo ""
              echo "Installing required AUR packages..."
              
              # Install AUR packages needed for end-4 setup
              yay -S --noconfirm --needed \
                python-materialyoucolor \
                python-material-color-utilities \
                nwg-dock-hyprland \
                ttf-material-design-icons-extended \
                adwaita-qt5 \
                adwaita-qt6 || echo "⚠ Some AUR packages failed (will continue)"
              
              echo ""
              echo "═══════════════════════════════════════════════════════"
              echo "Installing end-4 Hyprland Dotfiles (illogical-impulse)"
              echo "═══════════════════════════════════════════════════════"
              echo ""
              echo "Follow the interactive prompts to customize your setup."
              echo "Choose your preferred style and options."
              echo ""
              
              # Install end-4 dotfiles using the official installer
              if bash <(curl -fsSL "https://end-4.github.io/dots-hyprland-wiki/setup.sh"); then
                echo ""
                echo "✓ end-4 dotfiles installed successfully!"
                DOTFILES_OK=1
              else
                echo ""
                echo "✗ Dotfiles installation failed or was cancelled"
                DOTFILES_OK=0
              fi
              
              echo ""
              echo "═══════════════════════════════════════════════════════"
              echo "Configuring dock integration"
              echo "═══════════════════════════════════════════════════════"
              
              # Note: nwg-dock will be configured by end-4 setup if included
              # This is just a backup configuration
              if command -v nwg-dock-hyprland &> /dev/null; then
                mkdir -p "$HOME/.config/nwg-dock-hyprland"
                
                cat > "$HOME/.config/nwg-dock-hyprland/style.css" << '"'"'DOCK_CSS'"'"'
          window {
            background-color: rgba(20, 20, 30, 0.8);
            border-radius: 15px;
            padding: 4px;
            margin: 0px;
          }
          
          #box {
            padding: 8px;
            background-color: transparent;
          }
          
          button {
            border-radius: 10px;
            padding: 8px;
            margin: 2px;
            background-color: transparent;
            color: #ffffff;
            border: none;
          }
          
          button:hover {
            background-color: rgba(100, 100, 150, 0.5);
          }
          
          button:focus {
            background-color: rgba(120, 120, 180, 0.6);
          }
          DOCK_CSS
                
                cat > "$HOME/.config/nwg-dock-hyprland/launch.sh" << '"'"'DOCK_LAUNCH'"'"'
          #!/bin/bash
          nwg-dock-hyprland -f -x -i 48 -nolauncher -a center -ml 8 -mr 8 -mb 8
          DOCK_LAUNCH
                chmod +x "$HOME/.config/nwg-dock-hyprland/launch.sh"
                
                # Add dock to Hyprland autostart if not already present
                if [ -f "$HOME/.config/hypr/hyprland.conf" ]; then
                  if ! grep -q "nwg-dock-hyprland" "$HOME/.config/hypr/hyprland.conf" 2>/dev/null && \
                     ! grep -q "nwg-dock-hyprland" "$HOME/.config/hypr/custom/execs.conf" 2>/dev/null; then
                    echo "exec-once = ~/.config/nwg-dock-hyprland/launch.sh" >> "$HOME/.config/hypr/custom/execs.conf" 2>/dev/null || \
                    echo "exec-once = ~/.config/nwg-dock-hyprland/launch.sh" >> "$HOME/.config/hypr/hyprland.conf"
                  fi
                fi
                
                echo "✓ nwg-dock configured!"
              else
                echo "⚠ nwg-dock not installed (end-4 setup may include alternative)"
              fi
              
              echo ""
              echo "═══════════════════════════════════════════════════════"
              echo "Setting up BlackArch repositories"
              echo "═══════════════════════════════════════════════════════"
              
              if /usr/local/bin/setup-blackarch; then
                echo "✓ BlackArch repositories ready!"
              else
                echo "✗ BlackArch setup had issues (you can run setup-blackarch later)"
              fi
              
              echo ""
              if [ -x /usr/local/bin/neo-enhancements ]; then
                echo "═══════════════════════════════════════════════════════"
                echo "Running Neo enhancements"
                echo "═══════════════════════════════════════════════════════"
                /usr/local/bin/neo-enhancements || echo "✗ Neo enhancements had issues"
              fi
              
              echo ""
              echo "╔═══════════════════════════════════════════════════════╗"
              echo "║                                                       ║"
              echo "║              ✨ Setup Complete! ✨                     ║"
              echo "║                                                       ║"
              echo "╚═══════════════════════════════════════════════════════╝"
              echo ""
              echo "Next steps:"
              echo "  1. Log out of Hyprland (Super+Shift+Q)"
              echo "  2. Log back in to load all configurations"
              echo "  3. Explore with Super+/ to see all keybinds"
              echo "  4. Customize further in ~/.config/"
              echo ""
              echo "Useful commands:"
              echo "  • Super+Q     - Close window"
              echo "  • Super+T     - Terminal"
              echo "  • Super+R     - App launcher"
              echo "  • Super+L     - Lock screen"
              echo ""
              echo "This window will close in 15 seconds or press Enter..."
              read -t 15
            '"'"'
            
            mkdir -p "$HOME/.config"
            touch "$FLAG"
            
            if [ "${DOTFILES_OK:-0}" -eq 1 ]; then
              notify-send "Cybr Linux" "Setup completed! Log out and back in to apply all changes." \
                -i emblem-default -t 5000
            fi
          fi
          FB
              chmod +x airootfs/usr/local/bin/cybr-first-boot
              
              # Autostart configuration
              mkdir -p airootfs/etc/skel/.config/autostart
              cat > airootfs/etc/skel/.config/autostart/cybr-setup.desktop << "AS"
          [Desktop Entry]
          Type=Application
          Name=Cybr First Boot Setup
          Exec=/usr/local/bin/cybr-first-boot
          Hidden=false
          NoDisplay=true
          X-GNOME-Autostart-enabled=true
          AS
              
              # Configure greetd with tuigreet for Wayland login
              mkdir -p airootfs/etc/greetd
              cat > airootfs/etc/greetd/config.toml << "GREETD"
          [terminal]
          vt = 1
          
          [default_session]
          command = "tuigreet --time --remember --cmd Hyprland"
          user = "greeter"
          GREETD
              
              # Create auto-login script for live session
              cat > airootfs/usr/local/bin/autologin-live << "AUTOLOGIN"
          #!/bin/bash
          # Auto-login for live session only
          if [ -f /etc/cybr-live ]; then
            exec Hyprland
          else
            exec tuigreet --time --remember --cmd Hyprland
          fi
          AUTOLOGIN
              chmod +x airootfs/usr/local/bin/autologin-live
              
              # Mark as live session
              touch airootfs/etc/cybr-live
              
              # Update greetd config for auto-login in live session
              cat > airootfs/etc/greetd/config.toml << "GREETD_LIVE"
          [terminal]
          vt = 1
          
          [default_session]
          command = "/usr/local/bin/autologin-live"
          user = "cybr"
          GREETD_LIVE
              
              # Polkit authentication agent
              mkdir -p airootfs/etc/skel/.config/hypr/custom
              cat > airootfs/etc/skel/.config/hypr/custom/polkit.conf << "POLKIT"
          exec-once = /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1
          POLKIT
              
              # Enable required services
              mkdir -p airootfs/etc/systemd/system/{multi-user.target.wants,graphical.target.wants}
              
              ln -sf /usr/lib/systemd/system/NetworkManager.service \
                airootfs/etc/systemd/system/multi-user.target.wants/ || true
              
              ln -sf /usr/lib/systemd/system/bluetooth.service \
                airootfs/etc/systemd/system/multi-user.target.wants/ || true
              
              ln -sf /usr/lib/systemd/system/greetd.service \
                airootfs/etc/systemd/system/graphical.target.wants/ || true
              
              # Create welcome message
              cat > airootfs/etc/motd << "MOTD"
          
          ╔═══════════════════════════════════════════════════════════════╗
          ║                                                               ║
          ║              🌅 Welcome to Cybr Linux 🌅                       ║
          ║                                                               ║
          ║         Dawn Light Shines Upon the Arches                    ║
          ║           by WolfTech Innovations                             ║
          ║                                                               ║
          ║  • Base: Arch Linux (Rolling Release)                        ║
          ║  • Desktop: Hyprland + end-4 dotfiles                        ║
          ║  • Security: BlackArch tools available                       ║
          ║                                                               ║
          ║  First boot will launch an interactive setup wizard          ║
          ║                                                               ║
          ╚═══════════════════════════════════════════════════════════════╝
          
          MOTD
              
              # Build ISO
              echo ""
              echo "═══════════════════════════════════════════════"
              echo "Building ISO with mkarchiso..."
              echo "═══════════════════════════════════════════════"
              
              mkarchiso -v -w /tmp/work -o /tmp/out .
              
              # Move to workspace
              mv /tmp/out/*.iso /workspace/${ISO_NAME}.iso
              
              echo ""
              echo "╔═══════════════════════════════════════════════╗"
              echo "║                                               ║"
              echo "║  ✨ Cybr Linux ISO created successfully! ✨   ║"
              echo "║                                               ║"
              echo "║  File: ${ISO_NAME}.iso                        ║"
              echo "║                                               ║"
              echo "╚═══════════════════════════════════════════════╝"
            '

      - name: "Validate ISO"
        id: validate
      