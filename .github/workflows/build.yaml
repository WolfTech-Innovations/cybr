name: "Cybr NextGen Build System"

on:
  workflow_dispatch:
    inputs:
      force_fail:
        description: "Force build failure for testing"
        required: false
        default: "false"
        type: boolean
      build_variant:
        description: "Build variant"
        required: false
        default: "standard"
        type: choice
        options: ["minimal", "standard", "full"]
      skip_upload:
        description: "Skip upload to SourceForge"
        required: false
        default: "false"
        type: boolean
  push:
    branches: [main, develop]
    paths: ['scripts/**', 'config/**', '.github/workflows/build.yml']
  schedule:
    - cron: '0 2 * * 0' # Weekly builds on Sunday 2AM UTC

env:
  DOCKER_BUILDKIT: 1
  BUILDX_CACHE_TO: type=gha,mode=max
  BUILDX_CACHE_FROM: type=gha
  BUILD_VERSION: ${{ github.run_number }}
  ISO_NAME: "cybr-nextgen-v${{ github.run_number }}"

jobs:
  # ============================================================================
  #                           PRE-BUILD VALIDATION
  # ============================================================================
  validate:
    name: "ğŸ” Pre-Build Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      build_hash: ${{ steps.hash.outputs.hash }}
    steps:
      - name: "ASCII Art Banner"
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                                                                       â•‘
          â•‘    â–„â–ˆâ–ˆâ–ˆâ–ˆâ–„â–“â–ˆâ–ˆ   â–ˆâ–ˆâ–“ â–„â–„â–„â–„    â–ˆâ–ˆâ–€â–ˆâ–ˆâ–ˆ      â–„â–„â–„â–„    â–ˆ    â–ˆâ–ˆ  â–ˆâ–ˆâ–“ â–ˆâ–ˆâ–“   â–„â–„â–„â–„   â•‘
          â•‘   â–’â–ˆâ–ˆâ–€ â–€â–ˆ â–’â–ˆâ–ˆ  â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„ â–“â–ˆâ–ˆ â–’ â–ˆâ–ˆâ–’   â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„  â–ˆâ–ˆ  â–“â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–’â–“â–ˆâ–ˆâ–’  â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„ â•‘
          â•‘   â–’â–“â–ˆ    â–„ â–’â–ˆâ–ˆ â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–’ â–„â–ˆâ–ˆâ–“â–ˆâ–ˆ â–‘â–„â–ˆ â–’   â–’â–ˆâ–ˆâ–’ â–„â–ˆâ–ˆâ–“â–ˆâ–ˆ  â–’â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–’â–’â–ˆâ–ˆâ–‘  â–’â–ˆâ–ˆâ–’ â–„â–ˆâ–ˆâ•‘
          â•‘   â–’â–“â–“â–„ â–„â–ˆâ–ˆâ–’â–‘ â–â–ˆâ–ˆâ–“â–‘â–’â–ˆâ–ˆâ–‘â–ˆâ–€  â–’â–ˆâ–ˆâ–€â–€â–ˆâ–„     â–’â–ˆâ–ˆâ–‘â–ˆâ–€  â–“â–“â–ˆ  â–‘â–ˆâ–ˆâ–‘â–‘â–ˆâ–ˆâ–‘â–’â–ˆâ–ˆâ–‘  â–’â–ˆâ–ˆâ–‘â–ˆâ–€  â•‘
          â•‘   â–’ â–“â–ˆâ–ˆâ–ˆâ–€ â–‘â–‘ â–ˆâ–ˆâ–’â–“â–‘â–‘â–“â–ˆ  â–€â–ˆâ–“â–‘â–ˆâ–ˆâ–“ â–’â–ˆâ–ˆâ–’   â–‘â–“â–ˆ  â–€â–ˆâ–“â–’â–’â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“ â–‘â–ˆâ–ˆâ–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–ˆ  â–€â–ˆâ–“â•‘
          â•‘   â–‘ â–‘â–’ â–’  â–‘ â–ˆâ–ˆâ–’â–’â–’ â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–€â–’â–‘ â–’â–“ â–‘â–’â–“â–‘   â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–€â–’â–‘â–’â–“â–’ â–’ â–’ â–‘â–“  â–‘ â–’â–‘â–“  â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–€â–’â•‘
          â•‘     â–‘  â–’  â–“â–ˆâ–ˆ â–‘â–’â–‘ â–’â–‘â–’   â–‘   â–‘â–’ â–‘ â–’â–‘   â–’â–‘â–’   â–‘ â–‘â–‘â–’â–‘ â–‘ â–‘  â–’ â–‘â–‘ â–‘ â–’  â–‘â–’   â–‘ â•‘
          â•‘   â–‘       â–’ â–’ â–‘â–‘   â–‘    â–‘   â–‘â–‘   â–‘     â–‘    â–‘  â–‘â–‘â–‘ â–‘ â–‘  â–’ â–‘  â–‘ â–‘   â–‘    â–‘ â•‘
          â•‘   â–‘ â–‘     â–‘ â–‘      â–‘         â–‘         â–‘         â–‘      â–‘      â–‘  â–‘      â•‘
          â•‘   â–‘       â–‘ â–‘           â–‘                   â–‘                        â–‘    â•‘
          â•‘                                                                       â•‘
          â•‘                    NEXT-GENERATION SECURITY OS BUILDER               â•‘
          â•‘                                                                       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF
          
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Generate Build Hash"
        id: hash
        run: |
          HASH=$(echo "${{ github.sha }}-${{ github.event.inputs.build_variant }}-${{ github.run_number }}" | sha256sum | cut -d' ' -f1 | head -c 16)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Build Hash: $HASH"
          
      - name: "Validation Checks"
        id: check
        run: |
          echo "should_build=true" >> $GITHUB_OUTPUT
          
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚           VALIDATION REPORT             â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ Build Variant: ${{ github.event.inputs.build_variant || 'standard' }}"
          echo "â”‚ Force Fail:    ${{ github.event.inputs.force_fail || 'false' }}"
          echo "â”‚ Skip Upload:   ${{ github.event.inputs.skip_upload || 'false' }}"
          echo "â”‚ Build Number:  ${{ github.run_number }}"
          echo "â”‚ Trigger:       ${{ github.event_name }}"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

  # ============================================================================
  #                              MAIN BUILD JOB
  # ============================================================================
  build:
    name: "ğŸ—ï¸ Build Cybr OS"
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_build == 'true'
    timeout-minutes: 340
    outputs:
      build_success: ${{ steps.build-status.outputs.success }}
      iso_size: ${{ steps.iso-info.outputs.size }}
      iso_sha256: ${{ steps.iso-info.outputs.sha256 }}

    steps:
      - name: "Build Progress Banner"
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•‘
          â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â•‘
          â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â•‘
          â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â•‘
          â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â•‘
          â•‘  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•     â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF

      - name: "Maximize Build Space"
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          df -h

      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:buildx-stable-1

      - name: "Create Debian Build Environment"
        run: |
          cat > Dockerfile << 'DOCKERFILE_EOF'
          FROM debian:bookworm
          
          # Install build dependencies
          RUN apt-get update && \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                  debootstrap live-build xorriso squashfs-tools \
                  git curl wget ca-certificates gnupg2 \
                  syslinux-utils isolinux mtools rsync \
                  dosfstools parted gdisk \
              && apt-get clean \
              && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          
          WORKDIR /build
          COPY scripts/ ./scripts/
          RUN find ./scripts -name "*.sh" -o -name "*.bash" | xargs chmod +x
          
          ENV DEBIAN_FRONTEND=noninteractive
          ENV LANG=C.UTF-8
          ENV LC_ALL=C.UTF-8
          DOCKERFILE_EOF

      - name: "Build Docker Image"
        run: |
          echo "Building Debian build environment..."
          docker build -t cybr-debian-builder:${{ needs.validate.outputs.build_hash }} .

      - name: "Create Build Scripts"
        run: |
          mkdir -p scripts config
          
          # Main build script
          cat > scripts/build-debian-iso.sh << 'BUILD_EOF'
          #!/bin/bash
          set -euo pipefail
          
          BUILD_VARIANT="${BUILD_VARIANT:-standard}"
          BUILD_VERSION="${BUILD_VERSION:-1}"
          ISO_NAME="${ISO_NAME:-cybr-nextgen}"
          
          echo "Starting Debian-based Cybr build..."
          echo "Variant: $BUILD_VARIANT"
          echo "Version: $BUILD_VERSION"
          
          # Setup live-build configuration
          mkdir -p /build/live-build
          cd /build/live-build
          
          # Configure live-build for Debian
          lb config \
            --distribution bookworm \
            --archive-areas "main contrib non-free non-free-firmware" \
            --architectures amd64 \
            --linux-flavours amd64 \
            --bootappend-live "boot=live components username=cybr hostname=cybr-nextgen quiet splash" \
            --iso-application "Cybr NextGen Security OS" \
            --iso-publisher "WolfTech Innovations" \
            --iso-volume "CybrNextGen" \
            --binary-images iso-hybrid \
            --memtest none \
            --win32-loader false \
            --checksums sha256 \
            --compression xz \
            --zsync false
          
          # Note: Kali repositories will be configured via hook with proper keyring
          
          # Add Kali GPG key setup hook
          mkdir -p config/hooks/live
          cat > config/hooks/live/0050-kali-keyring.hook.chroot << 'KALI_KEY_HOOK_EOF'
          #!/bin/bash
          set -e
          
          echo "Setting up Kali Linux keyring..."
          
          # Download and install the official Kali keyring
          wget -q -O /tmp/kali-archive-keyring.gpg https://archive.kali.org/archive-keyring.gpg
          
          # Install the keyring to the proper location
          cp /tmp/kali-archive-keyring.gpg /usr/share/keyrings/kali-archive-keyring.gpg
          
          # Update the sources list to use the signed-by option
          echo "deb [signed-by=/usr/share/keyrings/kali-archive-keyring.gpg] http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware" > /etc/apt/sources.list.d/kali.list
          
          # Clean up
          rm -f /tmp/kali-archive-keyring.gpg
          
          echo "Kali keyring setup completed"
          KALI_KEY_HOOK_EOF
          chmod +x config/hooks/live/0050-kali-keyring.hook.chroot
          
          # Create package lists based on variant
          mkdir -p config/package-lists
          
          # Base system packages
          cat > config/package-lists/base.list.chroot << 'BASE_EOF'
          # Base system
          live-task-standard
          sudo
          openssh-client
          openssh-server
          curl
          wget
          git
          nano
          htop
          tree
          file
          
          # Network tools
          net-tools
          iputils-ping
          dnsutils
          whois
          nmap
          netcat-traditional
          
          # Basic security
          ufw
          fail2ban
          clamav
          clamav-freshclam
          BASE_EOF
          
          # Desktop environment for standard/full builds
          if [[ "$BUILD_VARIANT" != "minimal" ]]; then
            cat > config/package-lists/desktop.list.chroot << 'DESKTOP_EOF'
          # KDE Plasma Desktop
          kde-plasma-desktop
          plasma-workspace
          plasma-nm
          kde-config-sddm
          
          # Display Manager
          sddm
          
          # Calamares Installer
          calamares
          calamares-settings-debian
          
          # Essential KDE applications
          dolphin
          konsole
          kate
          firefox-esr
          
          # System utilities
          partitionmanager
          kde-spectacle
          ark
          DESKTOP_EOF
          fi
          
          # Additional packages for full build
          if [[ "$BUILD_VARIANT" == "full" ]]; then
            cat > config/package-lists/full.list.chroot << 'FULL_EOF'
          # Development tools
          code
          git-gui
          
          # Media
          vlc
          gimp
          
          # Office
          libreoffice
          
          # Network analysis (from Kali repos)
          wireshark
          tcpdump
          FULL_EOF
          fi
          
          # Create hooks for customization
          mkdir -p config/hooks/normal
          
          # Cybr branding hook
          cat > config/hooks/normal/0100-cybr-branding.hook.chroot << 'BRAND_EOF'
          #!/bin/bash
          set -e
          
          echo "Applying Cybr NextGen branding..."
          
          # Update OS identification
          cat > /etc/os-release << 'OS_EOF'
          PRETTY_NAME="Cybr NextGen"
          NAME="Cybr NextGen"
          VERSION_ID="1.0"
          VERSION="1.0 (NextGen)"
          VERSION_CODENAME=nextgen
          ID=cybr
          ID_LIKE=debian
          HOME_URL="https://cybr-nextgen.org/"
          SUPPORT_URL="https://support.cybr-nextgen.org/"
          BUG_REPORT_URL="https://bugs.cybr-nextgen.org/"
          OS_EOF
          
          # Update issue files
          cat > /etc/issue << 'ISSUE_EOF'
          Cybr NextGen Security OS \n \l
          
          ISSUE_EOF
          
          cat > /etc/issue.net << 'ISSUE_NET_EOF'
          Cybr NextGen Security OS
          ISSUE_NET_EOF
          
          # Create version info
          cat > /etc/cybr-version << 'VERSION_EOF'
          Cybr NextGen Security OS
          Version: $BUILD_VERSION
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Builder: GitHub Actions
          Variant: $BUILD_VARIANT
          VERSION_EOF
          
          echo "Branding applied successfully"
          BRAND_EOF
          chmod +x config/hooks/normal/0100-cybr-branding.hook.chroot
          
          # SDDM configuration hook
          cat > config/hooks/normal/0200-sddm-config.hook.chroot << 'SDDM_EOF'
          #!/bin/bash
          set -e
          
          echo "Configuring SDDM..."
          
          # Enable SDDM service
          systemctl enable sddm
          
          # Configure SDDM theme
          mkdir -p /etc/sddm.conf.d
          cat > /etc/sddm.conf.d/cybr.conf << 'SDDM_CONF_EOF'
          [Theme]
          Current=breeze
          
          [Users]
          MaximumUid=60513
          MinimumUid=500
          
          [Autologin]
          Relogin=false
          Session=
          User=
          SDDM_CONF_EOF
          
          echo "SDDM configured successfully"
          SDDM_EOF
          chmod +x config/hooks/normal/0200-sddm-config.hook.chroot
          
          # User setup hook
          cat > config/hooks/normal/0300-user-setup.hook.chroot << 'USER_EOF'
          #!/bin/bash
          set -e
          
          echo "Setting up default user..."
          
          # Create cybr user
          useradd -m -s /bin/bash -G sudo cybr
          echo "cybr:cybr" | chpasswd
          
          # Configure automatic login for live session
          mkdir -p /etc/systemd/system/getty@tty1.service.d
          cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf << 'AUTOLOGIN_EOF'
          [Service]
          ExecStart=
          ExecStart=-/sbin/agetty --autologin cybr --noclear %I $TERM
          AUTOLOGIN_EOF
          
          echo "User setup completed"
          USER_EOF
          chmod +x config/hooks/normal/0300-user-setup.hook.chroot
          
          # Calamares configuration
          if [[ "$BUILD_VARIANT" != "minimal" ]]; then
            cat > config/hooks/normal/0400-calamares.hook.chroot << 'CALAMARES_EOF'
          #!/bin/bash
          set -e
          
          echo "Configuring Calamares installer..."
          
          # Create basic Calamares configuration
          mkdir -p /etc/calamares
          cat > /etc/calamares/settings.conf << 'CAL_SETTINGS_EOF'
          modules-search: [ local ]
          
          instances:
          - id:       rootfs
            module:   unpackfs
            config:   unpackfs_rootfs.conf
          
          sequence:
          - show:
            - welcome
            - locale
            - keyboard
            - partition
            - users
            - summary
          - exec:
            - partition
            - mount
            - unpackfs@rootfs
            - machineid
            - fstab
            - locale
            - keyboard
            - localecfg
            - luksbootkeyfile
            - luksopenswaphookcfg
            - initcpiocfg
            - initcpio
            - removeuser
            - users
            - displaymanager
            - networkcfg
            - hwclock
            - services-systemd
            - bootloader
            - umount
          - show:
            - finished
          
          branding: cybr
          
          prompt-install: false
          dont-chroot: false
          oem-setup: false
          disable-cancel: false
          disable-cancel-during-exec: false
          hide-back-and-next-during-exec: false
          quit-at-end: false
          CAL_SETTINGS_EOF
          
          # Create branding directory
          mkdir -p /etc/calamares/branding/cybr
          cat > /etc/calamares/branding/cybr/branding.desc << 'BRAND_DESC_EOF'
          componentName:  cybr
          
          strings:
              productName:         Cybr NextGen
              shortProductName:    Cybr
              version:             1.0
              shortVersion:        1.0
              versionedName:       Cybr NextGen 1.0
              shortVersionedName:  Cybr 1.0
              bootloaderEntryName: Cybr
              productUrl:          https://cybr-nextgen.org/
              supportUrl:          https://support.cybr-nextgen.org/
              knownIssuesUrl:      https://bugs.cybr-nextgen.org/
              releaseNotesUrl:     https://cybr-nextgen.org/releases/
          
          images:
              productLogo:         "logo.png"
              productIcon:         "logo.png"
              productWelcome:      "welcome.png"
          
          style:
             sidebarBackground:    "#1d99f3"
             sidebarText:          "#ffffff"
             sidebarTextSelect:    "#4d4d4d"
             sidebarTextCurrent:   "#292929"
          BRAND_DESC_EOF
          
          echo "Calamares configured successfully"
          CALAMARES_EOF
          chmod +x config/hooks/normal/0400-calamares.hook.chroot
          fi
          
          # Build the ISO
          echo "Building live system..."
          lb build 2>&1 | tee build.log
          
          # Find and rename the ISO
          if [[ -f *.iso ]]; then
            mv *.iso "/build/${ISO_NAME}.iso"
            echo "ISO build completed: /build/${ISO_NAME}.iso"
            ls -lh "/build/${ISO_NAME}.iso"
          else
            echo "ERROR: No ISO file generated"
            exit 1
          fi
          BUILD_EOF
          chmod +x scripts/build-debian-iso.sh

      - name: "Execute ISO Build"
        run: |
          echo "Starting Debian-based ISO build process..."
          
          docker run --rm \
            --privileged \
            -v $PWD:/build \
            -e BUILD_VARIANT="${{ github.event.inputs.build_variant || 'standard' }}" \
            -e BUILD_VERSION="${{ env.BUILD_VERSION }}" \
            -e ISO_NAME="${{ env.ISO_NAME }}" \
            cybr-debian-builder:${{ needs.validate.outputs.build_hash }} \
            ./scripts/build-debian-iso.sh

      - name: "Validate ISO Build"
        id: iso-info
        run: |
          ISO_FILE="${{ env.ISO_NAME }}.iso"
          
          if [[ ! -f "$ISO_FILE" ]]; then
            echo "ERROR: ISO file not found: $ISO_FILE"
            exit 1
          fi
          
          # Get ISO information
          SIZE=$(stat -c%s "$ISO_FILE")
          SIZE_MB=$(( SIZE / 1024 / 1024 ))
          SHA256=$(sha256sum "$ISO_FILE" | cut -d' ' -f1)
          
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚            ISO BUILD SUMMARY            â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ File:      $ISO_FILE"
          echo "â”‚ Size:      ${SIZE_MB} MB (${SIZE} bytes)"
          echo "â”‚ SHA256:    $SHA256"
          echo "â”‚ Status:    âœ… Build Successful"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

      - name: "Set Build Status"
        id: build-status
        run: |
          if [[ "${{ github.event.inputs.force_fail }}" == "true" ]]; then
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Build artificially failed due to force_fail=true"
            exit 1
          else
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build completed successfully"
          fi

      - name: "Upload ISO Artifact"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "${{ env.ISO_NAME }}"
          path: "${{ env.ISO_NAME }}.iso"
          retention-days: 7
          compression-level: 0

  # ============================================================================
  #                              UPLOAD JOB
  # ============================================================================
  upload:
    name: "ğŸ“¤ Upload to SourceForge"
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: |
      needs.build.outputs.build_success == 'true' && 
      github.event.inputs.skip_upload != 'true' &&
      (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main')
    timeout-minutes: 30

    steps:
      - name: "Download ISO Artifact"
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"

      - name: "Install Upload Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: "Upload to SourceForge"
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          if [[ -z "$SF_USER" || -z "$SF_PASS" ]]; then
            echo "âŒ SourceForge credentials not configured"
            exit 1
          fi
          
          ISO_FILE="${{ env.ISO_NAME }}.iso"
          REMOTE_PATH="/home/frs/project/cybr-nextgen/$ISO_FILE"
          
          echo "Uploading $ISO_FILE to SourceForge..."
          
          for i in {1..3}; do
            if timeout 1800 sshpass -p "$SF_PASS" \
              rsync -avP --progress \
              -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
              "./$ISO_FILE" \
              "$SF_USER@frs.sourceforge.net:$REMOTE_PATH"; then
              echo "âœ… Upload completed successfully"
              break
            elif [[ $i -eq 3 ]]; then
              echo "âŒ Upload failed after 3 attempts"
              exit 1
            else
              echo "âš ï¸ Upload attempt $i failed, retrying..."
              sleep 30
            fi
          done

  # ============================================================================
  #                            NOTIFICATION JOB
  # ============================================================================
  notify:
    name: "ğŸ”” Send Notifications"
    runs-on: ubuntu-latest
    needs: [validate, build, upload]
    if: always()
    timeout-minutes: 5

    steps:
      - name: "Determine Overall Status"
        id: status
        run: |
          BUILD_STATUS="${{ needs.build.outputs.build_success }}"
          UPLOAD_STATUS="${{ needs.upload.result }}"
          
          if [[ "$BUILD_STATUS" == "true" ]]; then
            if [[ "$UPLOAD_STATUS" == "success" || "$UPLOAD_STATUS" == "skipped" ]]; then
              echo "overall_status=success" >> $GITHUB_OUTPUT
              echo "status_emoji=ğŸ‰" >> $GITHUB_OUTPUT
              echo "status_message=Build and upload completed successfully!" >> $GITHUB_OUTPUT
            else
              echo "overall_status=partial" >> $GITHUB_OUTPUT
              echo "status_emoji=âš ï¸" >> $GITHUB_OUTPUT
              echo "status_message=Build succeeded but upload failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_message=Build pipeline failed" >> $GITHUB_OUTPUT
          fi

      - name: "Create Job Summary"
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'
          # ${{ steps.status.outputs.status_emoji }} Cybr NextGen Build Summary
          
          ## Pipeline Results
          
          | Job | Status |
          |-----|--------|
          | **Validation** | ${{ (needs.validate.result == 'success' && 'âœ… Success') || 'âŒ Failed' }} |
          | **Build** | ${{ (needs.build.result == 'success' && 'âœ… Success') || 'âŒ Failed' }} |
          | **Upload** | ${{ (needs.upload.result == 'success' && 'âœ… Success') || (needs.upload.result == 'skipped' && 'â­ï¸ Skipped') || 'âŒ Failed' }} |
          
          ## Build Details
          
          | Parameter | Value |
          |-----------|-------|
          | **Build Number** | `#${{ github.run_number }}` |
          | **ISO Name** | `${{ env.ISO_NAME }}.iso` |
          | **Build Variant** | `${{ github.event.inputs.build_variant || 'standard' }}` |
          | **ISO Size** | `${{ needs.build.outputs.iso_size || 'N/A' }}` bytes |
          | **SHA256** | `${{ needs.build.outputs.iso_sha256 || 'N/A' }}` |
          
          ## Features
          
          - ğŸ§ **Base**: Debian Bookworm
          - ğŸ–¥ï¸ **Desktop**: KDE Plasma with SDDM
          - ğŸ“¦ **Installer**: Calamares
          - ğŸ”§ **Repositories**: Kali Linux tools available
          - ğŸ¨ **Branding**: Custom Cybr NextGen theme
          
          **Message:** ${{ steps.status.outputs.status_message }}
          SUMMARY_EOF

      - name: "Final Status Report"
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                        ğŸš€ CYBR NEXTGEN BUILD SYSTEM                   â•‘"
          echo "â•‘                             EXECUTION COMPLETE                        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                        â•‘"
          echo "â•‘  Status: ${{ steps.status.outputs.status_emoji }} ${{ steps.status.outputs.overall_status }}                                                    â•‘"
          echo "â•‘  Message: ${{ steps.status.outputs.status_message }}                   "
          echo "â•‘                                                                        â•‘"
          echo "â•‘  Build ID: ${{ github.run_number }}                                                     â•‘"
          echo "â•‘  Repository: ${{ github.repository }}                         â•‘"
          echo "â•‘  Commit: ${{ github.sha }}              â•‘"
          echo "â•‘                                                                        â•‘"
          echo "â•‘  Debian + KDE Plasma + Calamares + Kali Repos = Success!              â•‘"
          echo "â•‘                                                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [[ "${{ steps.status.outputs.overall_status }}" == "failure" ]]; then
            echo "Pipeline completed with failures"
            exit 1
          else
            echo "Pipeline completed successfully"
            exit 0
          fi

# ============================================================================
#                         SECURITY AND MAINTENANCE
# ============================================================================
  security-scan:
    name: "ğŸ”’ Security Scan"
    runs-on: ubuntu-latest
    needs: build
    if: |
      needs.build.outputs.build_success == 'true' && 
      (github.event_name == 'push' || github.event_name == 'schedule')
    timeout-minutes: 30
    continue-on-error: true

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Run Trivy Security Scan"
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'repo'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: "Upload Security Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "security-scan-${{ github.run_number }}"
          path: "trivy-results.sarif"

  cleanup:
    name: "ğŸ§¹ Cleanup"
    runs-on: ubuntu-latest
    needs: [build, upload, notify, security-scan]
    if: always()
    timeout-minutes: 10

    steps:
      - name: "Free Resources"
        run: |
          docker system prune -af || true
          sudo apt-get clean || true
          df -h