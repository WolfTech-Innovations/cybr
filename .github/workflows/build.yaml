name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-arch-plasma-v${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Create package list
        run: |
          cat > packages.x86_64 <<'EOF'
          linux-lts
          linux-firmware
          base
          base-devel
          syslinux
          edk2-shell
          memtest86+
          memtest86+-efi
          mkinitcpio
          mkinitcpio-archiso
          arch-install-scripts
          pacman-contrib
          archlinux-contrib
          plasma-desktop
          plasma-workspace
          plasma-nm
          plasma-pa
          sddm
          dolphin
          konsole
          kate
          firefox
          kscreen
          networkmanager
          pipewire
          pipewire-pulse
          pipewire-jack
          pipewire-alsa
          wireplumber
          git
          curl
          wget
          xmlstarlet
          vim
          nano
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          gparted
          ntfs-3g
          dosfstools
          exfatprogs
          xf86-input-wacom
          iwd
          kvantum
          papirus-icon-theme
          EOF
      
      - name: Build ISO
        run: |
          docker build -t builder - <<'DOCKERFILE'
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git && pacman -Scc --noconfirm
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged -v $PWD:/workspace -e ISO_NAME="${{ env.ISO_NAME }}" builder bash -c '
          set -euo pipefail
          cp -r /usr/share/archiso/configs/releng /build/cybr && cd /build/cybr
          cp /workspace/packages.x86_64 .
          pacman-key --init && pacman-key --populate archlinux
          curl -O https://blackarch.org/strap.sh && chmod +x strap.sh && ./strap.sh || true
          sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/" pacman.conf && pacman -Sy --noconfirm
          
          # Branding files
          mkdir -p airootfs/etc airootfs/etc/motd.d airootfs/etc/skel/.{config,local/share/konsole}
          mkdir -p airootfs/usr/share/plasma/look-and-feel/org.cybr.desktop/contents/{previews,splash/images}
          cat > airootfs/etc/os-release <<EOF
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux - Dawn Light Shines Upon the Arches"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          ANSI_COLOR="38;2;23;147;209"
          HOME_URL="https://wolfos.uk/"
          LOGO=archlinux-logo
          EOF
          cat > airootfs/etc/lsb-release <<EOF
          DISTRIB_ID="Cybr"
          DISTRIB_RELEASE="rolling"
          DISTRIB_DESCRIPTION="Cybr Linux - Dawn Light Shines Upon the Arches"
          EOF
          echo "cybr-live" > airootfs/etc/hostname
          cat > airootfs/etc/issue <<EOF
          
          Cybr Linux - Dawn Light Shines Upon the Arches
          ================================================
          Welcome to the Live Environment
          
          EOF
          cat > airootfs/etc/motd.d/00-cybr <<EOF
          
          ╔════════════════════════════════════════════════════════════╗
          ║        Cybr Linux - Dawn Light Shines Upon the Arches     ║
          ║  Built for performance, security, and ease of use         ║
          ║  • Install: archinstall or /root/install-cybr.sh          ║
          ║  • Modern UI: /usr/local/bin/setup-modern-ui.sh           ║
          ╚════════════════════════════════════════════════════════════╝
          
          EOF
          cat > airootfs/etc/skel/.config/kscreenlockerrc <<EOF
          [Greeter][Wallpaper][org.kde.image][General]
          Image=/usr/share/wallpapers/cybr-wallpaper.png
          EOF
          cat > airootfs/etc/skel/.local/share/konsole/Cybr.profile <<EOF
          [Appearance]
          ColorScheme=Breeze
          [General]
          Name=Cybr
          Parent=FALLBACK/
          EOF
          cat > airootfs/usr/share/plasma/look-and-feel/org.cybr.desktop/metadata.desktop <<EOF
          [Desktop Entry]
          Name=Cybr Linux
          Comment=Cybr Linux - Dawn Light Shines Upon the Arches
          Type=Service
          X-KDE-ServiceTypes=Plasma/LookAndFeel
          X-KDE-PluginInfo-Name=org.cybr.desktop
          X-KDE-PluginInfo-Version=1.0
          X-Plasma-MainScript=defaults
          EOF
          
          # Kernel config
          mkdir -p airootfs/etc/mkinitcpio.{conf.d,d} airootfs/boot
          cat > airootfs/etc/mkinitcpio.conf.d/archiso.conf <<EOF
          MODULES=()
          BINARIES=()
          FILES=()
          HOOKS=(base udev modconf kms keyboard keymap consolefont block filesystems archiso)
          COMPRESSION="xz"
          COMPRESSION_OPTIONS=(-9e)
          EOF
          cat > airootfs/etc/mkinitcpio.d/linux-lts.preset <<EOF
          ALL_config="/etc/mkinitcpio.conf.d/archiso.conf"
          ALL_kver="/boot/vmlinuz-linux-lts"
          PRESETS=("default" "fallback")
          default_image="/boot/initramfs-linux-lts.img"
          fallback_image="/boot/initramfs-linux-lts-fallback.img"
          fallback_options="-S autodetect"
          EOF
          
          # Live user setup
          cat > airootfs/root/customize_airootfs.sh <<EOF
          #!/usr/bin/env bash
          set -e
          KVER=\$(file -bL /boot/vmlinuz-linux-lts | grep -o "version [^ ]*" | cut -d" " -f2)
          mkinitcpio -k "\$KVER" -c /etc/mkinitcpio.conf.d/archiso.conf -g /boot/initramfs-linux-lts.img
          [[ ! -f /boot/vmlinuz-linux-lts || ! -f /boot/initramfs-linux-lts.img ]] && exit 1
          useradd -m -G wheel,audio,video,optical,storage,network -s /bin/bash liveuser
          echo "liveuser:live" | chpasswd && echo "root:root" | chpasswd
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel && chmod 440 /etc/sudoers.d/wheel
          mkdir -p /etc/sddm.conf.d
          cat > /etc/sddm.conf.d/autologin.conf <<SDDM
          [Autologin]
          User=liveuser
          Session=plasma
          [General]
          HaltCommand=/usr/bin/systemctl poweroff
          RebootCommand=/usr/bin/systemctl reboot
          SDDM
          EOF
          chmod +x airootfs/root/customize_airootfs.sh
          
          # systemd-boot (UEFI)
          mkdir -p efiboot/loader/entries
          cat > efiboot/loader/loader.conf <<EOF
          timeout 15
          default 01-cybr.conf
          console-mode max
          editor no
          EOF
          cat > efiboot/loader/entries/01-cybr.conf <<EOF
          title   Cybr Linux - Dawn Light Shines Upon the Arches
          linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          options archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% quiet splash
          EOF
          cat > efiboot/loader/entries/02-cybr-nomodeset.conf <<EOF
          title   Cybr Linux - Dawn Light (Safe Graphics)
          linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          options archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% nomodeset quiet splash
          EOF
          cat > efiboot/loader/entries/03-cybr-copytoram.conf <<EOF
          title   Cybr Linux - Dawn Light (Copy to RAM)
          linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          options archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% copytoram quiet splash
          EOF
          
          # Syslinux (BIOS)
          cat > syslinux/archiso_head.cfg <<EOF
          UI vesamenu.c32
          MENU TITLE Cybr Linux - Dawn Light Shines Upon the Arches
          MENU WIDTH 78
          MENU MARGIN 4
          MENU ROWS 7
          MENU COLOR title 1;36;44 #1793D1 #a0000000 std
          MENU COLOR sel 7;37;40 #e0ffffff #201793D1 all
          TIMEOUT 150
          EOF
          cat > syslinux/archiso_sys.cfg <<EOF
          LABEL arch64
          MENU LABEL Cybr Linux - Dawn Light
          LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% quiet splash
          LABEL arch64_nomodeset
          MENU LABEL Cybr Linux - Dawn Light (Safe Graphics)
          LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% nomodeset quiet splash
          LABEL arch64_copytoram
          MENU LABEL Cybr Linux - Dawn Light (Copy to RAM)
          LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          APPEND archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% copytoram quiet splash
          EOF
          cat > syslinux/syslinux.cfg <<EOF
          DEFAULT arch64
          INCLUDE archiso_head.cfg
          INCLUDE archiso_sys.cfg
          INCLUDE archiso_tail.cfg
          EOF
          
          # Auto-update system
          mkdir -p airootfs/etc/systemd/system airootfs/usr/local/bin
          cat > airootfs/etc/systemd/system/cybr-autoupdate.service <<EOF
          [Unit]
          Description=Cybr Auto Update
          After=network-online.target
          ConditionACPower=true
          [Service]
          Type=oneshot
          Nice=19
          ExecStart=/usr/local/bin/cybr-autoupdate.sh
          TimeoutSec=3600
          [Install]
          WantedBy=multi-user.target
          EOF
          
          cat > airootfs/etc/systemd/system/cybr-autoupdate.timer <<EOF
          [Unit]
          Description=Cybr Auto Update Timer
          [Timer]
          OnCalendar=daily
          OnCalendar=03:00
          RandomizedDelaySec=30min
          [Install]
          WantedBy=timers.target
          EOF
          
          cat > airootfs/usr/local/bin/cybr-autoupdate.sh <<EOF
          #!/bin/bash
          LOG="/var/log/cybr-autoupdate.log"
          LOCK="/var/run/cybr-autoupdate.lock"
          log() { echo "[\$(date +"%Y-%m-%d %H:%M:%S")] \$1" | tee -a "\$LOG"; }
          [[ -f "\$LOCK" && \$((\\$(date +%s)-\\$(stat -c %Y "\$LOCK" 2>/dev/null||echo 0))) -lt 86400 ]] && log "Running" && exit 1
          touch "\$LOCK" && trap "rm -f \$LOCK" EXIT
          log "===== Cybr Auto-Update ====="
          ping -c1 -W5 archlinux.org &>/dev/null || { log "No network"; exit 1; }
          pacman -Sy --noconfirm --needed archlinux-keyring 2>&1|tee -a "\$LOG"
          UPDATES=\\$(checkupdates 2>/dev/null|grep -cv "^\\$")
          [[ \$UPDATES -eq 0 ]] && log "Up to date" && exit 0
          log "Found \$UPDATES updates"
          pacman -Su --noconfirm 2>&1|tee -a "\$LOG" && paccache -rk3 2>&1|tee -a "\$LOG"
          log "Complete"
          EOF
          chmod +x airootfs/usr/local/bin/cybr-autoupdate.sh
          
          # UI setup script
          cat > airootfs/usr/local/bin/setup-modern-ui.sh <<EOF
          #!/bin/bash
          cd /tmp && git clone https://github.com/matinlotfali/KDE-Rounded-Corners && cd KDE-Rounded-Corners
          mkdir build && cd build && cmake .. -DCMAKE_INSTALL_PREFIX=/usr && make -j\\$(nproc) && sudo make install
          cd /tmp && git clone https://github.com/taj-ny/kwin-effects-forceblur && cd kwin-effects-forceblur
          mkdir build && cd build && cmake .. -DCMAKE_INSTALL_PREFIX=/usr && make -j\\$(nproc) && sudo make install
          kwriteconfig5 --file kwinrc --group Plugins --key kwin4_effect_shapecornersEnabled true
          kwriteconfig5 --file kwinrc --group Plugins --key blurEnabled true
          kwin_x11 --replace & plasmashell --replace &
          EOF
          chmod +x airootfs/usr/local/bin/setup-modern-ui.sh
          
          # Install helper
          cat > airootfs/root/install-cybr.sh <<EOF
          #!/bin/bash
          cat <<INFO
          ╔════════════════════════════════════════════╗
          ║   Cybr Linux Installation Helper          ║
          ╚════════════════════════════════════════════╝
          Quick: archinstall
          Manual: cfdisk -> mkfs.ext4 -> mount -> pacstrap -> genfstab -> arch-chroot
          Modern UI: /usr/local/bin/setup-modern-ui.sh
          INFO
          read -p "Press Enter..."
          EOF
          chmod +x airootfs/root/install-cybr.sh
          
          # Enable services
          mkdir -p airootfs/etc/systemd/system/{multi-user.target.wants,timers.target.wants}
          ln -sf /usr/lib/systemd/system/{sddm.service,NetworkManager.service} airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          ln -sf /etc/systemd/system/cybr-autoupdate.timer airootfs/etc/systemd/system/timers.target.wants/
          
          # Compression & build
          sed -i "s/airootfs_image_tool_options=()/airootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"100%\" \"-no-recovery\" \"-always-use-fragments\" \"-no-duplicates\")/" profiledef.sh
          mkarchiso -v -w /tmp/work -o /tmp/out .
          
          # Verify & export
          ISO_FILE=$(ls /tmp/out/*.iso)
          mkdir -p /tmp/m && mount -o loop "$ISO_FILE" /tmp/m
          [[ ! -f /tmp/m/arch/boot/x86_64/vmlinuz-linux-lts ]] && echo "ERROR: Kernel missing!" && exit 1
          umount /tmp/m && mv "$ISO_FILE" /workspace/${ISO_NAME}.iso
          '
      
      - name: Generate checksums
        run: |
          sha256sum "${{ env.ISO_NAME }}.iso" > "${{ env.ISO_NAME }}.iso.sha256"
          echo "ISO Size: $(($(stat -c%s "${{ env.ISO_NAME }}.iso")/1024/1024))MB"
      
      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [[ -z "$SF_USER" || -z "$SF_PASS" ]] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in {1..3}; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "${{ env.ISO_NAME }}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/" && break
            [[ $i -eq 3 ]] && exit 1
            sleep 30
          done