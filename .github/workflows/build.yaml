name: "Cybr Linux - Dawn Light Shines Upon the Arches (Plasma Edition)"
on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: "Build variant"
        required: false
        default: "standard"
        type: choice
        options: ["minimal", "standard", "full"]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-arch-plasma-v${{ github.run_number }}"
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  build:
    name: "Build Cybr Arch Linux (Plasma)"
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/{share/dotnet,local/lib/android} /opt/{ghc,hostedtoolcache}
          sudo apt-get clean && df -h
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          cat << 'EOF' | docker build -t cybr-arch-builder -
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git && pacman -Scc --noconfirm
          WORKDIR /build
          EOF

      - name: Build Cybr Linux ISO
        run: |
          docker run --rm --privileged -v $PWD:/workspace -e ISO_NAME="${{ env.ISO_NAME }}" cybr-arch-builder bash -c '
          set -euo pipefail
          echo "Building Cybr Linux..."
          cp -r /usr/share/archiso/configs/releng /build/cybr && cd /build/cybr
          
          cat > packages.x86_64 << "P"
          linux-lts
          plasma-desktop
          plasma-workspace
          plasma-nm
          plasma-pa
          sddm
          dolphin
          konsole
          kate
          firefox
          calamares
          qt6-virtualkeyboard
          kcm-wacomtablet
          kscreen
          networkmanager
          pipewire
          pipewire-pulse
          wireplumber
          git
          curl
          wget
          base-devel
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          P
          
          echo "cybr-linux" > airootfs/etc/hostname
          
          cat > airootfs/etc/os-release << "O"
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux - Dawn Light Shines Upon the Arches"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          HOME_URL="https://wolfos.uk/"
          O
          
          mkdir -p airootfs/usr/local/bin airootfs/etc/skel/.config
          
          cat > airootfs/usr/local/bin/cybr-setup << "S"
          #!/bin/bash
          cd /tmp
          git clone --depth=1 https://github.com/vinceliuice/McMojave-kde.git && cd McMojave-kde && ./install.sh
          cd /tmp && git clone --depth=1 https://github.com/vinceliuice/ChromeOS-kde.git && cd ChromeOS-kde && ./install.sh
          git clone --depth=1 https://github.com/vinceliuice/WhiteSur-icon-theme.git && cd WhiteSur-icon-theme && ./install.sh
          kwriteconfig5 --file kdeglobals --group General --key ColorScheme McMojave
          kwriteconfig5 --file kdeglobals --group KDE --key widgetStyle Breeze
          plasma-apply-colorscheme McMojave
          S
          chmod +x airootfs/usr/local/bin/cybr-setup
          
          mkdir -p airootfs/etc/calamares/modules
          cat > airootfs/etc/calamares/settings.conf << "C"
          ---
          modules-search: [local]
          sequence:
            - show:
              - welcome
              - locale
              - keyboard
              - partition
              - users
              - summary
            - exec:
              - partition
              - mount
              - unpackfs
              - machineid
              - fstab
              - locale
              - keyboard
              - localecfg
              - users
              - networkcfg
              - hwclock
              - services-systemd
              - bootloader
              - umount
            - show:
              - finished
          C
          
          mkdir -p airootfs/etc/skel/.config/plasma-org.kde.plasma.desktop-appletsrc
          cat > airootfs/etc/skel/.config/kdeglobals << "K"
          [KDE]
          SingleClick=false
          [General]
          ColorScheme=Breeze
          K
          
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          ln -sf /usr/lib/systemd/system/NetworkManager.service airootfs/etc/systemd/system/multi-user.target.wants/
          
          sed -i "s/airootfs_image_type=\"squashfs\"/airootfs_image_type=\"squashfs\"\nairootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"1M\")/" profiledef.sh
          
          mkarchiso -v -w /tmp/work -o /tmp/out .
          mv /tmp/out/*.iso /workspace/${ISO_NAME}.iso
          echo "ISO: ${ISO_NAME}.iso created"
          '

      - name: Verify ISO and generate checksums
        id: verify
        run: |
          ISO="${{ env.ISO_NAME }}.iso"
          [[ ! -f "$ISO" ]] && exit 1
          SIZE_MB=$(($(stat -c%s "$ISO")/1024/1024))
          SHA256=$(sha256sum "$ISO"|cut -d" " -f1)
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Size: ${SIZE_MB}MB SHA256: $SHA256"

      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: "${{ env.ISO_NAME }}.iso"
          retention-days: 7

  upload:
    name: "Upload to SourceForge"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    timeout-minutes: 30
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
      
      - name: Install rsync and sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync
      
      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [[ -z "$SF_USER" || -z "$SF_PASS" ]] && echo "Warning: Configure SF_USER and SF_PASS secrets" && exit 1
          ISO="${{ env.ISO_NAME }}.iso"
          for i in {1..3}; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "./$ISO" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/$ISO" && break
            [[ $i -eq 3 ]] && exit 1
            sleep 30
          done
          echo "Download link: https://sourceforge.net/projects/wolfos/files/plasma/$ISO/download"

  notify:
    name: "Build Summary"
    runs-on: ubuntu-latest
    needs: [build, upload]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Cybr Linux Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Edition:** Plasma | **Build:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY