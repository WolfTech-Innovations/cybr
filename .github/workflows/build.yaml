name: "Cybr Linux - Dawn Light Shines Upon the Arches (Plasma Edition)"

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: "Build variant"
        required: false
        default: "standard"
        type: choice
        options: ["minimal", "standard", "full"]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-arch-plasma-v${{ github.run_number }}"
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  build:
    name: "Build Cybr Arch Linux (Plasma)"
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Free Disk Space"
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h

      - name: "Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Create Arch Build Container"
        run: |
          cat > Dockerfile << 'EOF'
          FROM archlinux:latest
          
          RUN pacman -Syu --noconfirm && \
              # Manual setup option for users
              mkdir -p airootfs/usr/local/bin && \
              cat > airootfs/usr/local/bin/cybr-manual-setup << "MANUAL"
          #!/bin/bash
          
          konsole --title="Cybr Linux Setup" -e bash -c '
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  ðŸŒ… Cybr Linux Manual Setup (Plasma Edition)"
            echo "  by WolfTech Innovations"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This will install:"
            echo "  â€¢ Dracula theme (Plasma, Konsole, Kvantum)"
            echo "  â€¢ BlackArch security tool repositories"
            echo "  â€¢ Neo system enhancements"
            echo ""
            echo "Press Enter to continue or Ctrl+C to cancel..."
            read
            
            echo ""
            echo "ðŸ§› Installing Dracula theme..."
            /usr/local/bin/install-dracula-theme
            
            echo ""
            echo "ðŸ”’ Setting up BlackArch repositories..."
            /usr/local/bin/setup-blackarch
            
            echo ""
            if [ -x /usr/local/bin/neo-enhancements ]; then
              echo "âš¡ Running Neo enhancements..."
              /usr/local/bin/neo-enhancements || true
            fi
            
            echo ""
            echo "âœ¨ Setup Complete!"
            echo "Press Enter to close..."
            read
          '
          MANUAL
              chmod +x airootfs/usr/local/bin/cybr-manual-setup && \
              pacman -S --noconfirm archiso git curl wget base-devel && \
              pacman -Scc --noconfirm
          
          WORKDIR /build
          EOF
          
          docker build -t cybr-arch-builder .

      - name: "Build Cybr Linux ISO"
        run: |
          docker run --rm --privileged \
            -v $PWD:/workspace \
            -e ISO_NAME="${{ env.ISO_NAME }}" \
            cybr-arch-builder \
            bash -c '
              set -euo pipefail
              
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "  ðŸŒ… Dawn light shines upon the arches..."
              echo "  Building Cybr Linux with KDE Plasma"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              # Copy archiso profile
              cp -r /usr/share/archiso/configs/releng /build/cybr
              cd /build/cybr
              
              # Add packages for KDE Plasma
              cat >> packages.x86_64 << "PKGS"
          linux
          linux-headers
          plasma-desktop
          plasma-workspace
          plasma-nm
          plasma-pa
          powerdevil
          bluedevil
          kde-gtk-config
          breeze-gtk
          kscreen
          kinfocenter
          plasma-systemmonitor
          spectacle
          dolphin
          konsole
          kate
          gwenview
          okular
          ark
          filelight
          kcalc
          partitionmanager
          sddm
          sddm-kcm
          firefox
          xorg-server
          xorg-xwayland
          wayland
          egl-wayland
          pipewire
          pipewire-pulse
          pipewire-alsa
          pipewire-jack
          wireplumber
          networkmanager
          bluez
          bluez-utils
          htop
          btop
          git
          curl
          wget
          rsync
          unzip
          zip
          base-devel
          nodejs
          npm
          python
          python-pip
          ttf-dejavu
          ttf-liberation
          ttf-font-awesome
          ttf-jetbrains-mono
          ttf-jetbrains-mono-nerd
          noto-fonts
          noto-fonts-emoji
          noto-fonts-cjk
          papirus-icon-theme
          kvantum
          qt5ct
          qt6ct
          imagemagick
          jq
          bc
          coreutils
          PKGS
              
              # Cybr branding
              echo "cybr-linux" > airootfs/etc/hostname
              
              cat > airootfs/etc/os-release << "OS"
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux - Dawn Light Shines Upon the Arches (Plasma Edition)"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          ANSI_COLOR="38;2;23;147;209"
          HOME_URL="https://wolfos.uk/"
          SUPPORT_URL="https://wolfos.uk/"
          BUG_REPORT_URL="https://wolfos.uk/"
          LOGO=cybr
          OS
              
              # Setup scripts directory
              mkdir -p airootfs/usr/local/bin
              mkdir -p airootfs/etc/skel/.config
              
              # BlackArch setup script
              cat > airootfs/usr/local/bin/setup-blackarch << "BA"
          #!/bin/bash
          set -e
          echo "Setting up BlackArch repositories..."
          cd /tmp
          curl -O https://blackarch.org/strap.sh
          chmod +x strap.sh
          sudo ./strap.sh
          rm strap.sh
          sudo pacman -Sy
          echo "âœ“ BlackArch repos configured!"
          echo "Install tools with: sudo pacman -S <tool-name>"
          BA
              chmod +x airootfs/usr/local/bin/setup-blackarch
              
              # Neo enhancements hook (optional)
              curl -fsSL https://raw.githubusercontent.com/WolfTech-Innovations/Neo/main/lb-hooks/0201-Neo.chroot \
                -o airootfs/usr/local/bin/neo-enhancements 2>/dev/null || echo "Neo hook optional"
              chmod +x airootfs/usr/local/bin/neo-enhancements 2>/dev/null || true
              
              # Install Dracula theme for Plasma
              cat > airootfs/usr/local/bin/install-dracula-theme << "DRACULA"
          #!/bin/bash
          set -e

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ðŸ§› Installing Dracula Theme for KDE Plasma"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Create directories
          mkdir -p ~/.local/share/plasma/desktoptheme
          mkdir -p ~/.local/share/plasma/look-and-feel
          mkdir -p ~/.local/share/color-schemes
          mkdir -p ~/.local/share/aurorae/themes
          mkdir -p ~/.local/share/konsole
          mkdir -p ~/.config/Kvantum

          # Install Dracula Plasma Theme
          echo "ðŸ“¦ Installing Dracula Plasma theme..."
          cd /tmp
          git clone --depth=1 https://github.com/dracula/kde.git dracula-kde 2>/dev/null || true
          if [ -d dracula-kde ]; then
            cp -r dracula-kde/plasma/* ~/.local/share/plasma/desktoptheme/ 2>/dev/null || true
            cp -r dracula-kde/color-schemes/* ~/.local/share/color-schemes/ 2>/dev/null || true
            cp -r dracula-kde/aurorae/* ~/.local/share/aurorae/themes/ 2>/dev/null || true
            rm -rf dracula-kde
            echo "âœ“ Plasma theme installed"
          fi

          # Install Dracula for Konsole
          echo "ðŸ“¦ Installing Dracula Konsole color scheme..."
          cd /tmp
          git clone --depth=1 https://github.com/dracula/konsole.git dracula-konsole 2>/dev/null || true
          if [ -d dracula-konsole ]; then
            cp dracula-konsole/Dracula.colorscheme ~/.local/share/konsole/ 2>/dev/null || true
            rm -rf dracula-konsole
            echo "âœ“ Konsole theme installed"
          fi

          # Install Dracula Kvantum Theme
          echo "ðŸ“¦ Installing Dracula Kvantum theme..."
          cd /tmp
          git clone --depth=1 https://github.com/dracula/kvantum.git dracula-kvantum 2>/dev/null || true
          if [ -d dracula-kvantum ]; then
            cp -r dracula-kvantum/Dracula* ~/.config/Kvantum/ 2>/dev/null || true
            rm -rf dracula-kvantum
            echo "âœ“ Kvantum theme installed"
          fi

          # Configure Kvantum to use Dracula
          cat > ~/.config/Kvantum/kvantum.kvconfig << "KVANTUM"
          [General]
          theme=Dracula
          KVANTUM

          # Apply Plasma theme settings
          echo "ðŸŽ¨ Configuring Plasma to use Dracula..."
          
          # Set color scheme
          kwriteconfig5 --file ~/.config/kdeglobals --group General --key ColorScheme Dracula
          
          # Set window decoration
          kwriteconfig5 --file ~/.config/kwinrc --group org.kde.kdecoration2 --key theme Dracula
          
          # Set Plasma theme
          plasma-apply-desktoptheme Dracula 2>/dev/null || true
          plasma-apply-colorscheme Dracula 2>/dev/null || true
          
          # Set Kvantum as the Qt theme
          kwriteconfig5 --file ~/.config/Kvantum/kvantum.kvconfig --group General --key theme Dracula
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ¨ Dracula Theme Installation Complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Installed components:"
          echo "  âœ“ Plasma Desktop Theme"
          echo "  âœ“ Color Schemes"
          echo "  âœ“ Window Decorations (Aurorae)"
          echo "  âœ“ Konsole terminal theme"
          echo "  âœ“ Kvantum theme"
          echo ""
          echo "Note: Log out and log back in to see all changes"
          echo ""
          DRACULA
              chmod +x airootfs/usr/local/bin/install-dracula-theme
              
              # First boot setup script
              cat > airootfs/usr/local/bin/cybr-first-boot << "FB"
          #!/bin/bash
          FLAG="\$HOME/.config/cybr-setup-done"
          
          if [ ! -f "\$FLAG" ]; then
            # Wait for Plasma to fully start
            sleep 5
            
            # Run setup in background with logging
            (
              exec > /tmp/cybr-setup.log 2>&1
              
              echo "Cybr Linux First Boot Setup Starting..."
              date
              
              # Wait for internet connection
              echo "Checking internet connection..."
              for i in {1..30}; do
                if ping -c 1 8.8.8.8 &>/dev/null || ping -c 1 1.1.1.1 &>/dev/null; then
                  echo "Internet connected!"
                  break
                fi
                if [ \$i -eq 30 ]; then
                  echo "No internet connection after 60 seconds."
                  kdialog --error "No internet connection. Setup skipped.\n\nRun manually: /usr/local/bin/cybr-manual-setup"
                  touch "\$FLAG"
                  exit 1
                fi
                sleep 2
              done
              
              # Show notification that setup is starting
              kdialog --passivepopup "First boot setup in progress..." 5
              
              # Install Dracula theme
              echo "Installing Dracula theme..."
              if /usr/local/bin/install-dracula-theme; then
                echo "âœ“ Dracula theme installed"
                kdialog --passivepopup "âœ“ Dracula theme installed" 3
              else
                echo "âš  Dracula theme installation failed"
              fi
              
              # Setup BlackArch
              echo "Setting up BlackArch repositories..."
              if /usr/local/bin/setup-blackarch; then
                echo "âœ“ BlackArch repositories configured"
                kdialog --passivepopup "âœ“ BlackArch repos configured" 3
              else
                echo "âš  BlackArch setup failed"
              fi
              
              # Run Neo enhancements
              if [ -x /usr/local/bin/neo-enhancements ]; then
                echo "Running Neo enhancements..."
                /usr/local/bin/neo-enhancements || echo "âš  Neo enhancements had issues"
              fi
              
              echo "Setup completed!"
              date
              
              # Mark as done
              mkdir -p "\$HOME/.config"
              touch "\$FLAG"
              
              # Final notification
              kdialog --msgbox "âœ¨ Setup complete! Please log out and log back in to apply all changes."
              
            ) &
          fi
          FB
              chmod +x airootfs/usr/local/bin/cybr-first-boot
              
              # Plasma autostart entry
              mkdir -p airootfs/etc/skel/.config/autostart
              cat > airootfs/etc/skel/.config/autostart/cybr-first-boot.desktop << "AUTOSTART"
          [Desktop Entry]
          Type=Application
          Name=Cybr First Boot Setup
          Exec=/usr/local/bin/cybr-first-boot
          X-KDE-autostart-after=panel
          AUTOSTART
              
              # Enable SDDM
              mkdir -p airootfs/etc/systemd/system/display-manager.service.d
              cat > airootfs/etc/systemd/system/display-manager.service.d/override.conf << "SDDM"
          [Service]
          ExecStart=
          ExecStart=/usr/bin/sddm
          SDDM
              
              ln -sf /usr/lib/systemd/system/sddm.service \
                airootfs/etc/systemd/system/display-manager.service
              
              # Enable NetworkManager
              ln -sf /usr/lib/systemd/system/NetworkManager.service \
                airootfs/etc/systemd/system/multi-user.target.wants/NetworkManager.service
              
              # Enable Bluetooth
              ln -sf /usr/lib/systemd/system/bluetooth.service \
                airootfs/etc/systemd/system/multi-user.target.wants/bluetooth.service
              
              # Build ISO
              echo ""
              echo "ðŸ”¨ Building ISO with mkarchiso..."
              mkarchiso -v -w /tmp/work -o /tmp/out .
              
              # Move to workspace
              mv /tmp/out/*.iso /workspace/${ISO_NAME}.iso
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "  âœ¨ Cybr Linux Plasma ISO created successfully!"
              echo "  ðŸ“¦ File: ${ISO_NAME}.iso"
              echo "  ðŸŒ… Dawn light shines upon the arches"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            '

      - name: "Validate ISO"
        id: validate
        run: |
          ISO_FILE="${{ env.ISO_NAME }}.iso"
          
          if [[ ! -f "$ISO_FILE" ]]; then
            echo "ERROR: ISO not found"
            exit 1
          fi
          
          SIZE=$(stat -c%s "$ISO_FILE")
          SIZE_MB=$(( SIZE / 1024 / 1024 ))
          SHA256=$(sha256sum "$ISO_FILE" | cut -d' ' -f1)
          
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          
          echo "âœ“ ISO: $ISO_FILE"
          echo "âœ“ Size: ${SIZE_MB} MB"
          echo "âœ“ SHA256: $SHA256"

      - name: "Upload ISO Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: "${{ env.ISO_NAME }}.iso"
          retention-days: 7

  upload:
    name: "Upload to SourceForge"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
      - name: "Download ISO"
        uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"

      - name: "Install Upload Tools"
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: "Upload to SourceForge"
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          if [[ -z "$SF_USER" || -z "$SF_PASS" ]]; then
            echo "âš  SourceForge credentials not configured"
            echo "Add SF_USER and SF_PASS secrets to enable SourceForge uploads"
            exit 1
          fi
          
          ISO_FILE="${{ env.ISO_NAME }}.iso"
          REMOTE_PATH="/home/frs/project/wolfos/plasma/$ISO_FILE"
          
          echo "ðŸ“¤ Uploading $ISO_FILE to SourceForge..."
          echo "Remote path: $REMOTE_PATH"
          
          for i in {1..3}; do
            if timeout 1800 sshpass -p "$SF_PASS" \
              rsync -avP --progress \
              -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
              "./$ISO_FILE" \
              "$SF_USER@frs.sourceforge.net:$REMOTE_PATH"; then
              echo "âœ“ Upload completed successfully"
              break
            elif [[ $i -eq 3 ]]; then
              echo "âŒ Upload failed after 3 attempts"
              exit 1
            else
              echo "âš  Upload attempt $i failed, retrying in 30 seconds..."
              sleep 30
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ¨ ISO uploaded to SourceForge!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ”— Download URL:"
          echo "https://sourceforge.net/projects/wolfos/files/plasma/$ISO_FILE/download"
          echo ""

  notify:
    name: "Build Summary"
    runs-on: ubuntu-latest
    needs: [build, upload]
    if: always()

    steps:
      - name: "Generate Summary"
        run: |
          echo "Build complete" >> $GITHUB_STEP_SUMMARY