name: Cybr Build

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-linux-v${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache /usr/share/swift /usr/local/.ghcup /usr/local/share/powershell /usr/share/kotlinc /usr/local/lib/node_modules
          sudo docker system prune -af --volumes
          sudo apt-get purge -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
          sudo apt-get autoremove -y && sudo apt-get clean
          echo "=== After cleanup ===" && df -h
      
      - name: Build Cybr Linux ISO
        run: |
          docker build --no-cache --pull -t builder - <<'DOCKERFILE'
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git base-devel sudo python imagemagick wget && pacman -Scc --noconfirm && rm -rf /var/cache/pacman/pkg/* && useradd -m -G wheel builder && echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged --shm-size=4gb -v "$PWD:/workspace" -e ISO_NAME="${{ env.ISO_NAME }}" builder bash <<'BUILDSCRIPT'
          set -euo pipefail
          cp -r /usr/share/archiso/configs/releng /build/cybr && cd /build/cybr
          
          cat > packages.x86_64 <<'PKG'
          linux-firmware
          base
          base-devel
          syslinux
          edk2-shell
          memtest86+
          memtest86+-efi
          mkinitcpio
          mkinitcpio-archiso
          arch-install-scripts
          pacman-contrib
          archlinux-contrib
          plymouth
          plasma-desktop
          plasma-workspace
          plasma-nm
          bluedevil
          bluez
          bluez-utils
          sddm
          dolphin
          konsole
          kate
          firefox
          kscreen
          discover
          packagekit-qt6
          flatpak
          fwupd
          networkmanager
          pipewire
          pipewire-alsa
          pipewire-pulse
          pipewire-jack
          wireplumber
          git
          curl
          wget
          vim
          nano
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          gparted
          ntfs-3g
          dosfstools
          exfatprogs
          xf86-input-wacom
          iwd
          kvantum
          papirus-icon-theme
          breeze-gtk
          kcalc
          spectacle
          gwenview
          python
          python-pyqt5
          efibootmgr
          zsh
          zsh-completions
          zsh-syntax-highlighting
          zsh-autosuggestions
          fastfetch
          btop
          steam
          gamemode
          lib32-mesa
          vulkan-icd-loader
          lib32-vulkan-icd-loader
          PKG
          
          pacman-key --init && pacman-key --populate archlinux
          sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/" pacman.conf
          
          cat >> pacman.conf <<'LQXREPO'

[liquorix]
Server = https://liquorix.net/archlinux/$repo/$arch
LQXREPO
          
          pacman-key --keyserver hkps://keyserver.ubuntu.com --recv-keys 9AE4078033F8024D
          pacman-key --lsign-key 9AE4078033F8024D
          
          sed -i "1s/^/linux-lqx\nlinux-lqx-headers\n/" packages.x86_64
          
          sudo -u builder bash <<'AURB'
          cd /tmp
          git clone --depth 1 https://github.com/spookykidmm/zen_installer.git
          mkdir -p /build/cybr/airootfs/usr/share/zen_installer
          cp -r zen_installer/* /build/cybr/airootfs/usr/share/zen_installer/
          rm -rf zen_installer
          sudo pacman -Scc --noconfirm
          AURB
          
          mkdir -p airootfs/etc airootfs/etc/skel/.config airootfs/usr/share/plymouth airootfs/usr/local/bin
          
          wget -O airootfs/usr/share/plymouth/cybr-logo.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641"
          
          cat > airootfs/etc/os-release <<'OSREL'
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          ANSI_COLOR="38;2;23;147;209"
          HOME_URL="https://wolfos.uk/"
          LOGO=cybr-logo
          OSREL
          
          echo "cybr-live" > airootfs/etc/hostname
          
          cat > airootfs/etc/issue <<'ISSUE'

â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘  â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•
â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•¦â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ•”â•â–‘
â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–‘
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•¦â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—
â–‘â•šâ•â•â•â•â•â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•  â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•

Welcome to Cybr Linux - Powered by Liquorix Kernel

ISSUE
          
          cat > airootfs/usr/local/bin/cybr-control <<'CYBR'
#!/usr/bin/env python3
import sys
from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *
import subprocess

class CybrControl(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Cybr Control Center")
        self.setGeometry(100,100,700,500)
        self.setup_ui()
    
    def setup_ui(self):
        central=QWidget()
        self.setCentralWidget(central)
        layout=QVBoxLayout(central)
        
        title=QLabel("ðŸº CYBR CONTROL CENTER")
        title.setAlignment(Qt.AlignCenter)
        title.setStyleSheet("font-size:24px;font-weight:bold;color:#1793D1;margin:20px;")
        layout.addWidget(title)
        
        tabs=QTabWidget()
        tabs.addTab(self.gaming_tab(),"ðŸŽ® Gaming")
        tabs.addTab(self.dev_tab(),"ðŸ’» Development")
        tabs.addTab(self.system_tab(),"âš™ï¸ System")
        layout.addWidget(tabs)
    
    def gaming_tab(self):
        w=QWidget()
        l=QVBoxLayout(w)
        l.addWidget(QLabel("Gaming Setup"))
        b1=QPushButton("Install Steam Proton-GE")
        b1.clicked.connect(lambda:self.run_cmd("flatpak install -y com.valvesoftware.Steam.CompatibilityTool.Proton-GE"))
        l.addWidget(b1)
        b2=QPushButton("Enable GameMode")
        b2.clicked.connect(lambda:self.run_cmd("systemctl --user enable --now gamemoded"))
        l.addWidget(b2)
        l.addStretch()
        return w
    
    def dev_tab(self):
        w=QWidget()
        l=QVBoxLayout(w)
        l.addWidget(QLabel("Development Tools"))
        b1=QPushButton("Install VS Code")
        b1.clicked.connect(lambda:self.run_cmd("flatpak install -y com.visualstudio.code"))
        l.addWidget(b1)
        b2=QPushButton("Install Docker")
        b2.clicked.connect(lambda:self.run_cmd("sudo pacman -S --noconfirm docker && sudo systemctl enable --now docker"))
        l.addWidget(b2)
        l.addStretch()
        return w
    
    def system_tab(self):
        w=QWidget()
        l=QVBoxLayout(w)
        l.addWidget(QLabel("System Configuration"))
        b1=QPushButton("Update System")
        b1.clicked.connect(lambda:self.run_cmd("sudo pacman -Syu --noconfirm"))
        l.addWidget(b1)
        b2=QPushButton("Install AUR Helper (yay)")
        b2.clicked.connect(lambda:self.run_cmd("sudo pacman -S --needed --noconfirm git base-devel && git clone https://aur.archlinux.org/yay.git /tmp/yay && cd /tmp/yay && makepkg -si --noconfirm"))
        l.addWidget(b2)
        l.addStretch()
        return w
    
    def run_cmd(self,cmd):
        QMessageBox.information(self,"Running",f"Executing: {cmd}")
        subprocess.Popen(["konsole","-e","bash","-c",f"{cmd}; read -p 'Press Enter to close'"])

if __name__=="__main__":
    app=QApplication(sys.argv)
    app.setStyle("Fusion")
    win=CybrControl()
    win.show()
    sys.exit(app.exec_())
CYBR
          chmod +x airootfs/usr/local/bin/cybr-control
          
          mkdir -p airootfs/etc/mkinitcpio.conf.d
          cat > airootfs/etc/mkinitcpio.conf.d/plymouth.conf <<'MKINIT'
MODULES=()
BINARIES=()
FILES=()
HOOKS=(base udev plymouth modconf kms keyboard keymap consolefont block filesystems archiso)
COMPRESSION="xz"
MKINIT
          
          mkdir -p airootfs/etc/plymouth
          cat > airootfs/etc/plymouth/plymouthd.conf <<'PLYM'
[Daemon]
Theme=spinner
ShowDelay=0
DeviceTimeout=8
PLYM
          
          cat > airootfs/root/customize_airootfs.sh <<'CUSTOM'
#!/usr/bin/env bash
set -e
[ -f /usr/share/plymouth/cybr-logo.png ] && cp /usr/share/plymouth/cybr-logo.png /usr/share/plymouth/themes/spinner/watermark.png
plymouth-set-default-theme -R spinner 2>/dev/null || true
KVER=$(file -bL /boot/vmlinuz-linux-lqx 2>/dev/null | grep -o "version [^ ]*" | cut -d" " -f2 || echo "")
[ -n "$KVER" ] && mkinitcpio -k "$KVER" -c /etc/mkinitcpio.conf.d/plymouth.conf -g /boot/initramfs-linux-lqx.img

useradd -m -G wheel,audio,video,optical,storage,network -s /bin/zsh liveuser || true
echo "liveuser:live" | chpasswd
echo "root:root" | chpasswd
echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel
chmod 440 /etc/sudoers.d/wheel

mkdir -p /etc/sddm.conf.d
cat > /etc/sddm.conf.d/autologin.conf <<"SDDM"
[Autologin]
User=liveuser
Session=plasma
[General]
HaltCommand=/usr/bin/systemctl poweroff
RebootCommand=/usr/bin/systemctl reboot
[Theme]
Current=breeze
SDDM

mkdir -p /home/liveuser/.config
cat > /home/liveuser/.config/kdeglobals <<"KDE"
[General]
ColorScheme=BreezeDark
Name=Cybr
[KDE]
LookAndFeelPackage=org.kde.breezedark.desktop
[Icons]
Theme=Papirus-Dark
KDE

cat > /home/liveuser/.zshrc <<"ZSH"
HISTFILE=~/.histfile
HISTSIZE=10000
SAVEHIST=10000
setopt autocd
bindkey -e
autoload -Uz compinit && compinit
source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh 2>/dev/null || true
source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh 2>/dev/null || true
alias ls="ls --color=auto"
alias ll="ls -lah"
alias update="sudo pacman -Syu"
fastfetch
ZSH

mkdir -p /home/liveuser/Desktop
cat > /home/liveuser/Desktop/install.desktop <<"DESK"
[Desktop Entry]
Type=Application
Name=Install Cybr Linux
Exec=python3 /usr/share/zen_installer/zen_installer.py
Icon=system-software-install
Terminal=false
Categories=System;
DESK
chmod +x /home/liveuser/Desktop/install.desktop

cat > /home/liveuser/Desktop/cybr-control.desktop <<"CC"
[Desktop Entry]
Type=Application
Name=Cybr Control Center
Exec=/usr/local/bin/cybr-control
Icon=preferences-system
Terminal=false
Categories=System;Settings;
CC
chmod +x /home/liveuser/Desktop/cybr-control.desktop

mkdir -p /home/liveuser/.config/autostart
ln -sf /home/liveuser/Desktop/install.desktop /home/liveuser/.config/autostart/
chown -R liveuser:liveuser /home/liveuser
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo 2>/dev/null || true
CUSTOM
          chmod +x airootfs/root/customize_airootfs.sh
          
          mkdir -p efiboot/loader/entries syslinux
          cat > efiboot/loader/loader.conf <<'LOAD'
timeout 15
default 01-cybr-live.conf
console-mode max
editor no
LOAD
          
          cat > efiboot/loader/entries/01-cybr-live.conf <<'ENTRY'
title   Cybr Linux (Live)
linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lqx
initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lqx.img
options archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% splash quiet loglevel=3 rd.udev.log_priority=3 vt.global_cursor_default=0
ENTRY

          cat > efiboot/loader/entries/02-cybr-fallback.conf <<'FALL'
title   Cybr Linux (Fallback)
linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lqx
initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lqx-fallback.img
options archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL%
FALL

          cat > efiboot/loader/entries/03-cybr-nomodeset.conf <<'NOMOD'
title   Cybr Linux (Safe Graphics)
linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lqx
initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lqx.img
options archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% nomodeset
NOMOD
          
          wget -O /tmp/logo.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96&1748003641" || true
          if [ -f /tmp/logo.png ]; then
            magick -size 640x480 xc:"#0a0a0a" /tmp/logo.png -gravity center -composite -pointsize 24 -fill "#ffffff" -gravity south -annotate +0+100 "CYBR LINUX" -pointsize 16 -fill "#888888" -annotate +0+60 "wolfos.uk" syslinux/splash.png 2>/dev/null || convert -size 640x480 xc:"#0a0a0a" /tmp/logo.png -gravity center -composite -pointsize 24 -fill "#ffffff" -gravity south -annotate +0+100 "CYBR LINUX" -pointsize 16 -fill "#888888" -annotate +0+60 "wolfos.uk" syslinux/splash.png
          else
            magick -size 640x480 xc:"#0a0a0a" -gravity center -pointsize 72 -fill "#1793D1" -annotate +0-80 "CYBR" -pointsize 24 -fill "#ffffff" -annotate +0-20 "LINUX" -pointsize 16 -fill "#888888" -annotate +0+40 "wolfos.uk" syslinux/splash.png 2>/dev/null || convert -size 640x480 xc:"#0a0a0a" -gravity center -pointsize 72 -fill "#1793D1" -annotate +0-80 "CYBR" -pointsize 24 -fill "#ffffff" -annotate +0-20 "LINUX" -pointsize 16 -fill "#888888" -annotate +0+40 "wolfos.uk" syslinux/splash.png
          fi
          
          cat > syslinux/syslinux.cfg <<'SYSLIN'
UI vesamenu.c32
MENU TITLE Cybr Linux Boot Menu
MENU BACKGROUND splash.png
MENU COLOR border 30;44 #40ffffff #a0000000 std
MENU COLOR title 1;36;44 #9033ccff #a0000000 std
MENU COLOR sel 7;37;40 #e0ffffff #20ff8000 all
MENU COLOR unsel 37;44 #50ffffff #a0000000 std
DEFAULT cybr
TIMEOUT 150
LABEL cybr
    MENU LABEL Cybr Linux (Live)
    LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lqx
    INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lqx.img
    APPEND archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% splash quiet
LABEL cybr-fallback
    MENU LABEL Cybr Linux (Fallback)
    LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lqx
    INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lqx-fallback.img
    APPEND archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL%
LABEL cybr-nomodeset
    MENU LABEL Cybr Linux (Safe Graphics)
    LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lqx
    INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lqx.img
    APPEND archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% nomodeset
LABEL memtest
    MENU LABEL Memory Test
    LINUX /%INSTALL_DIR%/boot/memtest86+/memtest.bin
LABEL reboot
    MENU LABEL Reboot
    COM32 reboot.c32
LABEL poweroff
    MENU LABEL Power Off
    COM32 poweroff.c32
SYSLIN
          
          mkdir -p airootfs/etc/systemd/system/multi-user.target.wants
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          ln -sf /usr/lib/systemd/system/NetworkManager.service airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /usr/lib/systemd/system/bluetooth.service airootfs/etc/systemd/system/multi-user.target.wants/
          
          sed -i "s/airootfs_image_tool_options=()/airootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"100%\")/" profiledef.sh
          sed -i "s/iso_name=\"archlinux\"/iso_name=\"cybr\"/" profiledef.sh
          sed -i "s/iso_label=\"ARCH_\$(date +%Y%m)\"/iso_label=\"CYBR_\$(date +%Y%m)\"/" profiledef.sh
          sed -i "s/iso_publisher=\"Arch Linux <https:\/\/archlinux.org>\"/iso_publisher=\"Cybr Linux <https:\/\/wolfos.uk>\"/" profiledef.sh
          sed -i "s/iso_application=\"Arch Linux Live\/Rescue CD\"/iso_application=\"Cybr Linux Live Environment\"/" profiledef.sh
          
          mkarchiso -v -w /tmp/work -o /tmp/out .
          ISO_FILE=$(ls /tmp/out/*.iso)
          [ -f "$ISO_FILE" ] && mv "$ISO_FILE" "/workspace/${ISO_NAME}.iso"
          BUILDSCRIPT
      
      - name: Generate checksums
        run: |
          sha256sum "${{ env.ISO_NAME }}.iso" > "${{ env.ISO_NAME }}.iso.sha256"
          ISO_SIZE=$(($(stat -c%s "${{ env.ISO_NAME }}.iso")/1024/1024))
          echo "### Cybr Linux Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "**ISO:** ${{ env.ISO_NAME }}.iso | **Size:** ${ISO_SIZE}MB" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256:** \`$(cat ${{ env.ISO_NAME }}.iso.sha256 | cut -d' ' -f1)\`" >> $GITHUB_STEP_SUMMARY
      
      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [ -z "$SF_USER" ] || [ -z "$SF_PASS" ] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" "${{ env.ISO_NAME }}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done