name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-linux-v${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Create package list
        run: |
          cat > packages.x86_64 <<'EOF'
          linux-lts
          linux-firmware
          base
          base-devel
          syslinux
          edk2-shell
          memtest86+
          memtest86+-efi
          mkinitcpio
          mkinitcpio-archiso
          arch-install-scripts
          pacman-contrib
          archlinux-contrib
          plymouth
          plasma-desktop
          plasma-workspace
          plasma-nm
          bluedevil
          bluez
          bluez-utils
          sddm
          dolphin
          konsole
          kate
          firefox
          kscreen
          discover
          packagekit-qt6
          flatpak
          fwupd
          networkmanager
          pulseaudio
          pulseaudio-alsa
          pulseaudio-bluetooth
          pavucontrol
          git
          curl
          wget
          vim
          nano
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          gparted
          ntfs-3g
          dosfstools
          exfatprogs
          xf86-input-wacom
          iwd
          kvantum
          papirus-icon-theme
          breeze-gtk
          kcalc
          spectacle
          gwenview
          EOF
      
      - name: Build ISO with Calamares
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune -af
          sudo apt-get clean
          
          docker build -t builder - <<'DOCKERFILE'
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git base-devel && pacman -Scc --noconfirm
          WORKDIR /build
          DOCKERFILE
          
          docker run --rm --privileged -v "$PWD:/workspace" -e ISO_NAME="${{ env.ISO_NAME }}" builder bash -c '
          set -euo pipefail
          
          cp -r /usr/share/archiso/configs/releng /build/cybr
          cd /build/cybr
          cp /workspace/packages.x86_64 .
          
          # Add Calamares from AUR
          cat >> packages.x86_64 <<CALA
          boost-libs
          ckbcomp
          hwinfo
          icu
          kconfig5
          kcoreaddons5
          kiconthemes5
          ki18n5
          kio5
          kparts5
          kpmcore
          kservice5
          libpwquality
          plasma-framework5
          python
          qt5-svg
          qt5-tools
          qt5-translations
          qt5-xmlpatterns
          solid5
          squashfs-tools
          yaml-cpp
          CALA
          
          pacman-key --init
          pacman-key --populate archlinux
          sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/" pacman.conf
          
          mkdir -p airootfs/etc airootfs/etc/skel/.config airootfs/etc/calamares
          
          cat > airootfs/etc/os-release <<OSREL
          NAME="Cybr Linux"
          PRETTY_NAME="Cybr Linux"
          ID=cybr
          ID_LIKE=arch
          BUILD_ID=rolling
          ANSI_COLOR="38;2;23;147;209"
          HOME_URL="https://wolfos.uk/"
          LOGO=cybr-logo
          OSREL
          
          echo "cybr-live" > airootfs/etc/hostname
          
          # Plymouth configuration
          mkdir -p airootfs/etc/mkinitcpio.conf.d
          cat > airootfs/etc/mkinitcpio.conf.d/plymouth.conf <<MKINIT
          MODULES=()
          BINARIES=()
          FILES=()
          HOOKS=(base udev plymouth modconf kms keyboard keymap consolefont block filesystems archiso)
          COMPRESSION="xz"
          MKINIT
          
          # Create Plymouth theme
          mkdir -p airootfs/usr/share/plymouth/themes/cybr
          cat > airootfs/usr/share/plymouth/themes/cybr/cybr.plymouth <<PLYM
          [Plymouth Theme]
          Name=Cybr
          Description=Cybr Boot Animation
          ModuleName=script
          
          [script]
          ImageDir=/usr/share/plymouth/themes/cybr
          ScriptFile=/usr/share/plymouth/themes/cybr/cybr.script
          PLYM
          
          cat > airootfs/usr/share/plymouth/themes/cybr/cybr.script <<'\''SCPT'\''
          Window.SetBackgroundTopColor(0,0,0);
          Window.SetBackgroundBottomColor(0,0,0);
          w=Window.GetWidth();h=Window.GetHeight();
          sz=80;sp=15;
          
          dot=Sprite(Image.Text("â—",1,1,1,1,"Sans 50"));
          letters=[];reveals=[];sprites=[];
          
          for(i=0;i<4;i++){
            letters[i]=["C","y","b","r"][i];
            reveals[i]=0;
            sprites[i]=Sprite(Image.Text(letters[i],1,1,1,0,"Sans "+sz));
          }
          
          lw=sprites[0].GetImage().GetWidth();
          tw=(lw*4)+(sp*3);
          sx=(w-tw)/2;sy=(h/2)-(sz/2);
          
          for(i=0;i<4;i++)sprites[i].SetPosition(sx+(lw+sp)*i,sy,1);
          
          tag=Sprite(Image.Text("Simple. Fast. Secure.",0.5,0.5,0.5,0,"Sans 20"));
          tag.SetPosition((w-tag.GetImage().GetWidth())/2,sy+sz+40,1);
          
          dx=sx-120;de=sx+tw+120;dy=sy+(sz/2)-25;
          done=0;shown=0;
          
          fun refresh_callback(){
            t=Plymouth.GetTime();
            if(t<2.5&&done==0){
              r=t/2.5;
              x=dx+((de-dx)*r);
              dot.SetPosition(x,dy,10);
              for(i=0;i<4;i++){
                if(x>=sx+(lw+sp)*i+(lw/2)&&reveals[i]==0){
                  sprites[i].SetImage(Image.Text(letters[i],1,1,1,1,"Sans "+sz));
                  reveals[i]=1;
                }
              }
            }
            else if(done==0){dot.SetOpacity(0);done=1;}
            if(t>2.8&&shown==0){
              tag.SetImage(Image.Text("Simple. Fast. Secure.",0.5,0.5,0.5,1,"Sans 20"));
              shown=1;
            }
          }
          
          Plymouth.SetRefreshFunction(refresh_callback);
          SCPT
          
          mkdir -p airootfs/etc/plymouth
          cat > airootfs/etc/plymouth/plymouthd.conf <<PLYMCONF
          [Daemon]
          Theme=cybr
          ShowDelay=0
          DeviceTimeout=8
          PLYMCONF
          
          # Calamares basic config
          cat > airootfs/etc/calamares/settings.conf <<CALASET
          modules-search: [ local ]
          sequence:
            - show:
              - welcome
              - locale
              - keyboard
              - partition
              - users
              - summary
            - exec:
              - partition
              - mount
              - unpackfs
              - machineid
              - fstab
              - locale
              - keyboard
              - localecfg
              - users
              - networkcfg
              - hwclock
              - services-systemd
              - bootloader
              - umount
            - show:
              - finished
          
          branding: cybr
          prompt-install: true
          dont-chroot: false
          CALASET
          
          # Customization script
          cat > airootfs/root/customize_airootfs.sh <<'\''CUSTOM'\''
          #!/usr/bin/env bash
          set -e
          
          plymouth-set-default-theme -R cybr 2>/dev/null || true
          
          KVER=$(file -bL /boot/vmlinuz-linux-lts 2>/dev/null | grep -o "version [^ ]*" | cut -d" " -f2 || echo "")
          if [ -n "$KVER" ]; then
            mkinitcpio -k "$KVER" -c /etc/mkinitcpio.conf.d/plymouth.conf -g /boot/initramfs-linux-lts.img
          fi
          
          useradd -m -G wheel,audio,video,optical,storage,network -s /bin/bash liveuser || true
          echo "liveuser:live" | chpasswd
          echo "root:root" | chpasswd
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel
          chmod 440 /etc/sudoers.d/wheel
          
          mkdir -p /etc/sddm.conf.d
          cat > /etc/sddm.conf.d/autologin.conf <<SDDM
          [Autologin]
          User=liveuser
          Session=plasma
          
          [General]
          HaltCommand=/usr/bin/systemctl poweroff
          RebootCommand=/usr/bin/systemctl reboot
          
          [Theme]
          Current=breeze
          SDDM
          
          mkdir -p /home/liveuser/.config
          cat > /home/liveuser/.config/kdeglobals <<KDE
          [General]
          ColorScheme=BreezeDark
          
          [KDE]
          LookAndFeelPackage=org.kde.breezedark.desktop
          
          [Icons]
          Theme=Papirus-Dark
          KDE
          
          mkdir -p /home/liveuser/Desktop
          cat > /home/liveuser/Desktop/install.desktop <<DESK
          [Desktop Entry]
          Type=Application
          Name=Install Cybr Linux
          Exec=calamares
          Icon=system-software-install
          Terminal=false
          DESK
          chmod +x /home/liveuser/Desktop/install.desktop
          
          mkdir -p /home/liveuser/.config/autostart
          ln -sf /home/liveuser/Desktop/install.desktop /home/liveuser/.config/autostart/
          
          chown -R liveuser:liveuser /home/liveuser
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo 2>/dev/null || true
          CUSTOM
          chmod +x airootfs/root/customize_airootfs.sh
          
          # Boot entries
          mkdir -p efiboot/loader/entries
          cat > efiboot/loader/loader.conf <<LOADER
          timeout 15
          default 01-cybr.conf
          console-mode max
          editor no
          LOADER
          
          cat > efiboot/loader/entries/01-cybr.conf <<ENTRY
          title   Cybr Linux
          linux   /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux-lts
          initrd  /%INSTALL_DIR%/boot/x86_64/initramfs-linux-lts.img
          options archisobasedir=%INSTALL_DIR% archisosearchuuid=%ARCHISO_UUID% splash quiet loglevel=3 rd.udev.log_priority=3 vt.global_cursor_default=0
          ENTRY
          
          # Systemd services
          mkdir -p airootfs/etc/systemd/system/multi-user.target.wants
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          ln -sf /usr/lib/systemd/system/NetworkManager.service airootfs/etc/systemd/system/multi-user.target.wants/
          ln -sf /usr/lib/systemd/system/bluetooth.service airootfs/etc/systemd/system/multi-user.target.wants/
          
          # Compression settings
          sed -i "s/airootfs_image_tool_options=()/airootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"100%\")/" profiledef.sh
          
          mkarchiso -v -w /tmp/work -o /tmp/out .
          
          ISO_FILE=$(ls /tmp/out/*.iso)
          [ -f "$ISO_FILE" ] && mv "$ISO_FILE" "/workspace/${ISO_NAME}.iso"
          '
      
      - name: Generate checksums
        run: |
          sha256sum "${{ env.ISO_NAME }}.iso" > "${{ env.ISO_NAME }}.iso.sha256"
          echo "ISO Size: $(($(stat -c%s "${{ env.ISO_NAME }}.iso")/1024/1024))MB"
      
      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [ -z "$SF_USER" ] || [ -z "$SF_PASS" ] && echo "Configure SF secrets" && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for i in 1 2 3; do
            timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "${{ env.ISO_NAME }}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done