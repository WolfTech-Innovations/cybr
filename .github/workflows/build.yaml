name: "Cybr Linux - Dawn Light Shines Upon the Arches (Plasma Edition)"
on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: "Build variant"
        required: false
        default: "standard"
        type: choice
        options: ["minimal", "standard", "full"]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

env:
  ISO_NAME: "cybr-arch-plasma-v${{ github.run_number }}"
  BUILD_VERSION: ${{ github.run_number }}

jobs:
  build:
    name: "Build Cybr Arch Linux (Plasma)"
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/{share/dotnet,local/lib/android} /opt/{ghc,hostedtoolcache}
          sudo apt-get clean && df -h
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          cat << 'EOF' | docker build -t cybr-arch-builder -
          FROM archlinux:latest
          RUN pacman -Syu --noconfirm && pacman -S --noconfirm archiso git && pacman -Scc --noconfirm
          WORKDIR /build
          EOF

      - name: Build Cybr Linux ISO
        run: |
          docker run --rm --privileged -v $PWD:/workspace -e ISO_NAME="${{ env.ISO_NAME }}" cybr-arch-builder bash -c '
          set -euo pipefail
          echo "Building Cybr Linux..."
          cp -r /usr/share/archiso/configs/releng /build/cybr && cd /build/cybr
          
          # Initialize and populate the Pacman keyring
          pacman-key --init
          pacman-key --populate archlinux
          
          # Add ALCI repo FIRST (for Calamares installer)
          cat >> pacman.conf << "REPOS"

[alci_repo]
SigLevel = Optional TrustAll
Server = https://arch-linux-calamares-installer.github.io/\$repo/\$arch

[blackarch]
SigLevel = Optional TrustAll
Server = https://www.mirrorservice.org/sites/blackarch.org/blackarch/\$repo/os/\$arch
REPOS
          
          # Enable parallel downloads
          sed -i "s/#ParallelDownloads = 5/ParallelDownloads = 5/" pacman.conf
          
          # Update databases with new repos
          pacman -Sy --noconfirm
          
          # Import BlackArch keyring separately first
          pacman -S --noconfirm --needed wget
          wget https://blackarch.org/keyring/blackarch-keyring.pkg.tar.xz
          pacman -U --noconfirm blackarch-keyring.pkg.tar.xz || true
          
          # Define core packages (removed problematic ones)
          cat > packages.x86_64 << "PKGS"
linux-lts
linux-firmware
base
base-devel
syslinux
edk2-shell
memtest86+
memtest86+-efi
mkinitcpio
mkinitcpio-archiso
plasma-desktop
plasma-workspace
plasma-nm
plasma-pa
sddm
dolphin
konsole
kate
firefox
kscreen
networkmanager
pipewire
pipewire-pulse
pipewire-jack
pipewire-alsa
wireplumber
xf86-input-wacom
iwd
git
curl
wget
vim
nano
ttf-liberation
noto-fonts
noto-fonts-emoji
gparted
ntfs-3g
dosfstools
exfatprogs
PKGS

          # Add Calamares separately if available
          echo "calamares" >> packages.x86_64 || echo "Warning: Calamares not available"
          
          # Configure hostname
          echo "cybr-linux" > airootfs/etc/hostname
          
          # Create OS release file
          mkdir -p airootfs/etc
          cat > airootfs/etc/os-release << "OSREL"
NAME="Cybr Linux"
PRETTY_NAME="Cybr Linux - Dawn Light Shines Upon the Arches"
ID=cybr
ID_LIKE=arch
BUILD_ID=rolling
ANSI_COLOR="38;2;23;147;209"
HOME_URL="https://wolfos.uk/"
LOGO=archlinux-logo
OSREL
          
          # Enable services
          mkdir -p airootfs/etc/systemd/system/multi-user.target.wants
          mkdir -p airootfs/etc/systemd/system/graphical.target.wants
          ln -sf /usr/lib/systemd/system/sddm.service airootfs/etc/systemd/system/display-manager.service
          ln -sf /usr/lib/systemd/system/NetworkManager.service airootfs/etc/systemd/system/multi-user.target.wants/
          
          # Configure compression
          sed -i "s/airootfs_image_type=\"squashfs\"/airootfs_image_type=\"squashfs\"\nairootfs_image_tool_options=(\"-comp\" \"xz\" \"-Xbcj\" \"x86\" \"-b\" \"1M\" \"-Xdict-size\" \"1M\")/" profiledef.sh
          
          # Build ISO
          mkarchiso -v -w /tmp/work -o /tmp/out .
          
          # Move ISO to workspace
          mv /tmp/out/*.iso /workspace/${ISO_NAME}.iso
          ls -lh /workspace/${ISO_NAME}.iso
          echo "ISO: ${ISO_NAME}.iso created successfully"
          '

      - name: Verify ISO and generate checksums
        id: verify
        run: |
          ISO="${{ env.ISO_NAME }}.iso"
          if [[ ! -f "$ISO" ]]; then
            echo "Error: ISO file not found"
            exit 1
          fi
          SIZE_MB=$(($(stat -c%s "$ISO")/1024/1024))
          SHA256=$(sha256sum "$ISO"|cut -d" " -f1)
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "ISO Size: ${SIZE_MB}MB"
          echo "SHA256: $SHA256"
          sha256sum "$ISO" > "${ISO}.sha256"

      - uses: actions/upload-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
          path: |
            ${{ env.ISO_NAME }}.iso
            ${{ env.ISO_NAME }}.iso.sha256
          retention-days: 7

  upload:
    name: "Upload to SourceForge"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    timeout-minutes: 30
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "${{ env.ISO_NAME }}"
      
      - name: Install rsync and sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync
      
      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          if [[ -z "$SF_USER" || -z "$SF_PASS" ]]; then
            echo "Warning: Configure SF_USER and SF_PASS secrets in repository settings"
            exit 0
          fi
          
          ISO="${{ env.ISO_NAME }}.iso"
          
          for i in {1..3}; do
            if timeout 1800 sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "./$ISO" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/plasma/$ISO"; then
              echo "Upload successful!"
              echo "Download link: https://sourceforge.net/projects/wolfos/files/plasma/$ISO/download"
              exit 0
            fi
            
            if [[ $i -eq 3 ]]; then
              echo "Upload failed after 3 attempts"
              exit 1
            fi
            
            echo "Upload attempt $i failed, retrying in 30s..."
            sleep 30
          done

  notify:
    name: "Build Summary"
    runs-on: ubuntu-latest
    needs: [build, upload]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Cybr Linux Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Edition:** Plasma Desktop" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… ISO built successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Artifact: ${{ env.ISO_NAME }}.iso" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi