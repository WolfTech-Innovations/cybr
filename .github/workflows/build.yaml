name: "Cybr Build"

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build-base:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      base_name: ${{ steps.set-names.outputs.base_name }}
      iso_name: ${{ steps.set-names.outputs.iso_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Set build names
        id: set-names
        run: |
          echo "base_name=cybr-base-v${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "iso_name=cybr-netinstall-v${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache
          sudo docker system prune -af --volumes
          sudo apt-get autoremove -y && sudo apt-get clean

      - name: Build Cybr Base System
        run: |
          BASE_NAME="${{ steps.set-names.outputs.base_name }}"
          docker run --rm --privileged -v "$PWD:/w" -e BASE_NAME="${BASE_NAME}" debian:bookworm bash -c '
          set -e
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y debootstrap squashfs-tools wget curl gnupg2
          
          debootstrap --arch=amd64 --variant=minbase bookworm base http://deb.debian.org/debian/
          
          chroot base bash <<'"'"'EOF'"'"'
          export DEBIAN_FRONTEND=noninteractive
          
          cat > /etc/apt/sources.list <<SOURCES
          deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
          SOURCES
          
          apt-get update && apt-get install -y curl gnupg2 ca-certificates
          
          mkdir -p /usr/share/keyrings
          curl -fsSL https://liquorix.net/liquorix-keyring.gpg -o /usr/share/keyrings/liquorix-archive-keyring.gpg
          cat > /etc/apt/sources.list.d/liquorix.sources <<LIQUORIX
          Types: deb
          URIs: https://liquorix.net/debian
          Suites: bookworm
          Components: main
          Architectures: amd64
          Signed-By: /usr/share/keyrings/liquorix-archive-keyring.gpg
          LIQUORIX
          
          apt-get update
          apt-get install -y linux-image-liquorix-amd64 firmware-linux-free firmware-linux-nonfree systemd sudo phosh-full gdm3 network-manager firefox-esr flatpak gparted ntfs-3g dosfstools e2fsprogs nano
          
          dpkg --add-architecture i386 && apt-get update
          apt-get install -y steam libgl1-mesa-dri:amd64 libgl1-mesa-dri:i386 mesa-vulkan-drivers:amd64 mesa-vulkan-drivers:i386
          
          wget -O /tmp/discord.deb "https://discord.com/api/download?platform=linux&format=deb"
          apt-get install -y /tmp/discord.deb || apt-get install -f -y
          
          cat > /etc/os-release <<OSREL
          NAME="Cybr"
          PRETTY_NAME="Cybr Mobile Gaming Edition"
          ID=cybr
          ID_LIKE=debian
          VERSION_ID="1.0"
          HOME_URL="https://getcybr.org/"
          OSREL
          
          useradd -m -s /bin/bash -G sudo,audio,video,netdev cybruser
          echo "cybruser:cybr" | chpasswd
          echo "root:root" | chpasswd
          
          mkdir -p /etc/gdm3
          echo -e "[daemon]\nAutomaticLoginEnable=true\nAutomaticLogin=cybruser" > /etc/gdm3/custom.conf
          
          systemctl enable gdm3 NetworkManager
          apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          EOF
          
          mksquashfs base "${BASE_NAME}.squashfs" -comp xz -b 1M -Xdict-size 100%
          mv "${BASE_NAME}.squashfs" /w/
          '

      - name: Build Minimal Installer ISO
        run: |
          ISO_NAME="${{ steps.set-names.outputs.iso_name }}"
          docker run --rm --privileged -v "$PWD:/w" -e ISO_NAME="${ISO_NAME}" debian:bookworm bash -c '
          set -e
          export DEBIAN_FRONTEND=noninteractive
          apt-get update && apt-get install -y wget cpio xorriso isolinux syslinux-utils squashfs-tools
          
          cd /tmp
          
          # Install everything we need
          apt-get install -y linux-image-amd64 firmware-iwlwifi wpasupplicant parted squashfs-tools
          
          # Get kernel
          cp /boot/vmlinuz-* /tmp/vmlinuz
          
          # Get busybox
          wget -O busybox https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox
          chmod +x busybox
          
          # Create initramfs
          mkdir -p initramfs/{bin,sbin,proc,sys,dev,mnt,lib/firmware}
          cp busybox initramfs/bin/
          
          cd initramfs/bin
          for cmd in sh ls cp mv rm mkdir mount umount cat echo wget tar gzip cpio dd chmod ln ps sleep ping ip; do ln -s busybox $cmd; done
          cd ../sbin
          for cmd in init poweroff reboot mdev blkid mkfs.ext4 mkfs.vfat udhcpc; do ln -s ../bin/busybox $cmd; done
          cd /tmp
          
          # Copy firmware
          cp -r /lib/firmware/* initramfs/lib/firmware/
          
          # Copy tools
          cp /sbin/wpa_supplicant initramfs/sbin/
          cp /sbin/parted initramfs/sbin/
          cp /usr/sbin/unsquashfs initramfs/sbin/
          
          # Copy libs
          mkdir -p initramfs/lib/{x86_64-linux-gnu,64}
          cp /lib64/ld-linux-x86-64.so.2 initramfs/lib64/
          for lib in libc.so.6 libnl-3.so.200 libnl-genl-3.so.200 libblkid.so.1 libuuid.so.1; do
            find /lib /usr/lib -name "$lib" -exec cp {} initramfs/lib/x86_64-linux-gnu/ \; 2>/dev/null
          done
          
          cat > initramfs/init <<'"'"'INIT'"'"'
          #!/bin/sh
          export PATH=/bin:/sbin LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:/lib64
          mount -t proc none /proc; mount -t sysfs none /sys; mount -t devtmpfs none /dev; mdev -s
          clear
          echo "=== Cybr Installer ==="
          echo "Commands: wifi, install, shell"
          wifi_setup() {
            WLAN=$(ip link | grep -o "wl[^:]*" | head -1)
            [ -z "$WLAN" ] && echo "No WiFi" && return 1
            ip link set "$WLAN" up; sleep 2
            read -p "SSID: " SSID; read -sp "Pass: " PASS; echo
            echo "network={ssid=\"$SSID\" psk=\"$PASS\"}" > /tmp/wpa.conf
            wpa_supplicant -B -i "$WLAN" -c /tmp/wpa.conf; sleep 3; udhcpc -i "$WLAN"
            ping -c 1 8.8.8.8 && echo "Connected" || echo "Failed"
          }
          install_cybr() {
            ping -c 1 8.8.8.8 || { echo "No internet"; return 1; }
            blkid | grep -v loop
            read -p "Disk (e.g. sda): " D; D="/dev/$D"
            read -p "Erase $D? (YES): " C; [ "$C" != "YES" ] && return 1
            echo "Partitioning..."; parted -s "$D" mklabel gpt mkpart ESP fat32 1MiB 513MiB mkpart primary ext4 513MiB 100%; parted -s "$D" set 1 esp on
            echo "Formatting..."; mkfs.vfat -F32 "${D}1"; mkfs.ext4 -F "${D}2"
            echo "Mounting..."; mount "${D}2" /mnt; mkdir -p /mnt/boot/efi; mount "${D}1" /mnt/boot/efi
            echo "Downloading..."; BASE_URL="https://sourceforge.net/projects/wolfos/files/gaming/base"
            LATEST=$(wget -qO- "$BASE_URL/" | grep -oP "cybr-base-v\d+" | sort -V | tail -1)
            [ -z "$LATEST" ] && echo "Download failed" && return 1
            wget -O /tmp/base.sq "${BASE_URL}/${LATEST}.squashfs/download"
            echo "Extracting..."; unsquashfs -f -d /mnt /tmp/base.sq
            echo "Installing bootloader..."; mount --bind /dev /mnt/dev; mount --bind /proc /mnt/proc; mount --bind /sys /mnt/sys
            chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=Cybr "$D"
            chroot /mnt update-grub
            umount /mnt/dev /mnt/proc /mnt/sys; sync; umount -R /mnt
            echo "=== Install Complete ==="
          }
          while true; do
            read -p "cybr> " cmd
            case "$cmd" in wifi) wifi_setup;; install) install_cybr;; shell) exec /bin/sh;; *) echo "Unknown: $cmd";; esac
          done
          INIT
          chmod +x initramfs/init
          
          cd initramfs
          find . | cpio -o -H newc | gzip -9 > /tmp/initrd.gz
          
          # Build ISO with ISOLINUX only
          mkdir -p /w/iso/{boot,isolinux}
          cp /tmp/vmlinuz /tmp/initrd.gz /w/iso/boot/
          
          cat > /w/iso/isolinux/isolinux.cfg <<CFG
          DEFAULT linux
          LABEL linux
            KERNEL /boot/vmlinuz
            APPEND initrd=/boot/initrd.gz quiet
          CFG
          
          cp /usr/lib/ISOLINUX/isolinux.bin /w/iso/isolinux/
          
          xorriso -as mkisofs -o "/w/${ISO_NAME}.iso" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin /w/iso/
          '

      - name: Generate checksums
        run: |
          sha256sum "${{ steps.set-names.outputs.iso_name }}.iso" > "${{ steps.set-names.outputs.iso_name }}.iso.sha256"
          sha256sum "${{ steps.set-names.outputs.base_name }}.squashfs" > "${{ steps.set-names.outputs.base_name }}.squashfs.sha256"
          
          echo "### Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "**ISO:** ${{ steps.set-names.outputs.iso_name }}.iso ($(($(stat -c%s "${{ steps.set-names.outputs.iso_name }}.iso")/1024/1024))MB)" >> $GITHUB_STEP_SUMMARY
          echo "**Base:** ${{ steps.set-names.outputs.base_name }}.squashfs ($(($(stat -c%s "${{ steps.set-names.outputs.base_name }}.squashfs")/1024/1024))MB)" >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v4
        with:
          name: "cybr-build-${{ github.run_number }}"
          path: |
            ${{ steps.set-names.outputs.iso_name }}.iso
            ${{ steps.set-names.outputs.iso_name }}.iso.sha256
            ${{ steps.set-names.outputs.base_name }}.squashfs
            ${{ steps.set-names.outputs.base_name }}.squashfs.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build-base
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "cybr-build-${{ github.run_number }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
          ISO_NAME: ${{ needs.build-base.outputs.iso_name }}
          BASE_NAME: ${{ needs.build-base.outputs.base_name }}
        run: |
          [ -z "$SF_USER" ] && exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          
          # Upload ISO with retry logic
          for i in 1 2 3; do
            sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" "${ISO_NAME}.iso" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done
          
          # Upload Base with retry logic
          for i in 1 2 3; do
            sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" "${BASE_NAME}.squashfs" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/base/" && break
            [ $i -eq 3 ] && exit 1
            sleep 30
          done