name: "Cybr Build"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - iso-only
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        if: ${{ inputs.build_type != 'iso-only' }}
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker system prune -af --volumes

      - name: Build Cybr
        run: |
          docker run --rm --privileged -v "$PWD:/w" -e BUILD_TYPE="${{ inputs.build_type || 'full' }}" \
            -e RUN_NUM="${{ github.run_number }}" debian:bookworm bash -c '
          set -ex; export DEBIAN_FRONTEND=noninteractive
          cat>/etc/apt/sources.list<<S
          deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
          S
          apt-get update && apt-get install -y debootstrap squashfs-tools wget curl gnupg2 xorriso \
            isolinux syslinux-utils dosfstools grub-efi-amd64-bin mtools git build-essential cpio \
            linux-image-amd64 firmware-linux wpasupplicant parted iw ethtool
          cd /w; BASE="cybr-base-v${RUN_NUM}"; ISO="cybr-netinstall-v${RUN_NUM}"
          
          if [ "$BUILD_TYPE" = "full" ]; then
            echo "=== Building Base ==="
            debootstrap --arch=amd64 --variant=minbase bookworm base http://deb.debian.org/debian/
            chroot base bash<<E
          cat>/etc/apt/sources.list<<S
          deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
          S
          apt-get update && apt-get install -y curl gnupg2 ca-certificates
          curl -fsSL https://liquorix.net/liquorix-keyring.gpg -o /usr/share/keyrings/liquorix.gpg
          cat>/etc/apt/sources.list.d/liquorix.sources<<L
          Types: deb
          URIs: https://liquorix.net/debian
          Suites: bookworm
          Components: main
          Signed-By: /usr/share/keyrings/liquorix.gpg
          L
          apt-get update && apt-get install -y linux-image-liquorix-amd64 firmware-linux systemd sudo \
            phosh-full gdm3 network-manager firefox-esr flatpak gparted ntfs-3g e2fsprogs nano \
            grub-efi-amd64 grub-pc-bin
          dpkg --add-architecture i386 && apt-get update
          apt-get install -y steam libgl1-mesa-dri:amd64 libgl1-mesa-dri:i386 mesa-vulkan-drivers:amd64 \
            mesa-vulkan-drivers:i386
          wget -qO /tmp/d.deb "https://discord.com/api/download?platform=linux&format=deb"
          apt-get install -y /tmp/d.deb || apt-get install -f -y
          cat>/etc/os-release<<O
          NAME="Cybr"
          ID=cybr
          ID_LIKE=debian
          VERSION_ID="1.0"
          O
          useradd -m -s /bin/bash -G sudo,audio,video,netdev cybruser
          echo "cybruser:cybr"|chpasswd; echo "root:root"|chpasswd
          echo -e "[daemon]\nAutomaticLoginEnable=true\nAutomaticLogin=cybruser">/etc/gdm3/custom.conf
          systemctl enable gdm3 NetworkManager
          apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/*
          E
            mksquashfs base "${BASE}.squashfs" -comp xz -b 1M
            echo "✓ Base: $(($(stat -c%s ${BASE}.squashfs)/1024/1024))MB"
          else
            echo "=== Skipping Base (ISO-only) ==="
          fi
          
          echo "=== Building ISO ==="
          cd /tmp; cp "$(find /boot -name vmlinuz-* | tail -1)" vmlinuz
          KVER=$(ls /lib/modules/|tail -1)
          
          git clone --depth 1 https://github.com/ipxe/ipxe.git; cd ipxe/src
          cat>e.ipxe<<I
          #!ipxe
          dhcp||goto m
          :m
          menu Cybr
          item i Install
          item s Shell
          choose o && goto \${o}
          :i
          kernel vmlinuz initrd=initrd.gz
          boot
          :s
          shell
          I
          make bin/ipxe.lkrn EMBED=e.ipxe -j4 2>&1|tail -10||true
          make bin-x86_64-efi/ipxe.efi EMBED=e.ipxe -j4 2>&1|tail -10||true
          cp bin/ipxe.lkrn bin-x86_64-efi/ipxe.efi /tmp/ 2>/dev/null||true; cd /tmp
          
          wget -qO bb https://busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox; chmod +x bb
          mkdir -p i/{bin,sbin,proc,sys,dev,mnt,etc,lib/{firmware,modules,x86_64-linux-gnu},lib64}
          cp bb i/bin/busybox; cd i/bin
          for c in sh mount umount cat wget ping ip ls modprobe;do ln -s busybox $c;done; cd ../sbin
          for c in init mdev udhcpc;do ln -s ../bin/busybox $c;done; cd /tmp
          cp -r /lib/firmware/* i/lib/firmware/
          mkdir -p i/lib/modules/$KVER
          for d in drivers/net drivers/virtio kernel/net;do
            find /lib/modules/$KVER/$d -name "*.ko" 2>/dev/null|while read m;do
              r="${m#/lib/modules/$KVER/}"; mkdir -p "i/lib/modules/$KVER/$(dirname $r)"
              cp "$m" "i/lib/modules/$KVER/$r"
            done
          done
          cp /lib/modules/$KVER/modules.* i/lib/modules/$KVER/ 2>/dev/null||true
          for t in /usr/sbin/unsquashfs /sbin/{parted,wpa_supplicant,iw,ethtool};do
            [ -f "$t" ]&&cp "$t" i/sbin/&&ldd "$t" 2>/dev/null|grep -oP "/lib[^ ]*"|while read l;do
              [ -f "$l" ]&&cp --parents "$l" i/;done
          done
          cp /lib64/ld-linux-x86-64.so.2 i/lib64/
          for l in libc.so.6 libm.so.6 libnl-*.so.200 libdbus-1.so.3 libblkid.so.1 libuuid.so.1 libz.so.1 \
                   liblzma.so.5 libresolv.so.2 libnss_*.so.2 libcrypto.so.3 libssl.so.3;do
            find /lib /usr/lib -name "$l" 2>/dev/null|head -1|while read f;do
              [ -f "$f" ]&&cp "$f" i/lib/x86_64-linux-gnu/;done
          done
          echo "nameserver 8.8.8.8">i/etc/resolv.conf
          
          cat>i/init<<"F"
          #!/bin/sh
          export PATH=/bin:/sbin LD_LIBRARY_PATH=/lib/x86_64-linux-gnu:/lib64
          mount -t proc none /proc;mount -t sysfs none /sys;mount -t devtmpfs none /dev;mdev -s;hostname cybr
          for m in virtio virtio_pci virtio_net e1000 r8169 cfg80211 iwlwifi;do modprobe $m 2>/dev/null||true;done
          sleep 2;for n in /sys/class/net/*;do n=$(basename $n);[ "$n" != "lo" ]&&ip link set $n up;done
          clear;printf "\033[36m╔══════════════════╗\n║ CYBR INSTALLER   ║\n╠══════════════════╣\n║ 1)WiFi 2)Eth     ║\n║ 3)Install 4)Shell║\n╚══════════════════╝\033[0m\n"
          eth(){E=$(ip -br l|grep "^e"|head -1|awk "{print \$1}");[ -z "$E" ]&&echo "No eth"&&return
          ip link set $E up;udhcpc -i $E -qn 2>&1|grep -q obtained&&ping -c1 8.8.8.8>/dev/null&&echo "✓"||echo "✗";}
          wifi(){W=$(ip -br l|grep "^wl"|head -1|awk "{print \$1}");[ -z "$W" ]&&echo "No WiFi"&&return
          ip link set $W up;printf "SSID:";read S;printf "Pass:";read -s P;echo
          echo -e "network={\nssid=\"$S\"\npsk=\"$P\"\n}">/tmp/w;killall wpa_supplicant 2>/dev/null
          wpa_supplicant -Bi $W -c /tmp/w;sleep 3;udhcpc -i $W -qn 2>&1|tail -1
          ping -c1 8.8.8.8>/dev/null&&echo "✓"||echo "✗";}
          inst(){ping -c1 8.8.8.8>/dev/null||{echo "No net";return;};lsblk -d|grep disk;printf "Disk:";read D
          D="/dev/$D";[ ! -b "$D" ]&&echo "Invalid"&&return;printf "ERASE $D? (YES):";read C;[ "$C" != "YES" ]&&return
          parted -s $D mklabel gpt mkpart ESP fat32 1M 513M mkpart primary ext4 513M 100% set 1 esp on 2>&1|tail -1
          mkfs.vfat -F32 ${D}1>/dev/null 2>&1;mkfs.ext4 -F ${D}2>/dev/null 2>&1;mount ${D}2 /mnt
          mkdir -p /mnt/boot/efi;mount ${D}1 /mnt/boot/efi
          U="https://sourceforge.net/projects/wolfos/files/gaming/base"
          L=$(wget -qO- $U|grep -oP "cybr-base-v\d+"|sort -V|tail -1)
          [ -z "$L" ]&&echo "✗ Not found"&&umount -R /mnt&&return;echo "→ $L"
          wget -qO /tmp/b.sq "$U/$L.squashfs/download"||{echo "✗ DL fail";umount -R /mnt;return;}
          echo "→ Extracting...";unsquashfs -f -d /mnt /tmp/b.sq>/dev/null||{echo "✗";umount -R /mnt;return;}
          mount --bind /dev /mnt/dev;mount --bind /proc /mnt/proc;mount --bind /sys /mnt/sys
          chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=Cybr $D>/dev/null 2>&1
          chroot /mnt grub-install --target=i386-pc $D>/dev/null 2>&1;chroot /mnt update-grub>/dev/null 2>&1
          sync;umount -R /mnt;echo "✓ Done! Type: reboot";}
          eth>/dev/null 2>&1
          while :;do printf "\ncybr>";read c;case $c in 1|wifi)wifi;;2|eth)eth;;3|install)inst;;4|shell)exec sh;;
          reboot)reboot -f;;*)echo "1-4";;esac;done
          F
          chmod +x i/init;cd i;find .|cpio -oH newc|gzip -9>/tmp/initrd.gz;cd /tmp
          
          mkdir -p iso/{boot/grub,EFI/BOOT,isolinux}
          cp vmlinuz initrd.gz iso/boot/
          [ -f ipxe.lkrn ]&&cp ipxe.lkrn iso/boot/||echo "⚠ iPXE BIOS not built"
          [ -f ipxe.efi ]&&cp ipxe.efi iso/EFI/BOOT/BOOTX64.EFI||echo "⚠ iPXE EFI not built"
          cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/
          cp /usr/lib/syslinux/modules/bios/{ldlinux.c32,menu.c32} iso/isolinux/
          cat>iso/isolinux/isolinux.cfg<<L
          DEFAULT menu.c32
          TIMEOUT 50
          LABEL i
            MENU LABEL Install
            KERNEL /boot/vmlinuz
            APPEND initrd=/boot/initrd.gz
          L
          [ -f iso/boot/ipxe.lkrn ]&&cat>>iso/isolinux/isolinux.cfg<<L
          LABEL p
            MENU LABEL iPXE
            KERNEL /boot/ipxe.lkrn
          L
          cat>iso/boot/grub/grub.cfg<<G
          set timeout=5
          menuentry "Install Cybr" {linux /boot/vmlinuz;initrd /boot/initrd.gz}
          G
          [ -f iso/EFI/BOOT/BOOTX64.EFI ]&&cat>>iso/boot/grub/grub.cfg<<G
          menuentry "iPXE" {chainloader /EFI/BOOT/BOOTX64.EFI}
          G
          dd if=/dev/zero of=efi.img bs=1M count=10 2>/dev/null;mkfs.vfat efi.img>/dev/null 2>&1
          mmd -i efi.img ::/EFI ::/EFI/BOOT;mcopy -i efi.img iso/EFI/BOOT/BOOTX64.EFI ::/EFI/BOOT/
          xorriso -as mkisofs -o "/w/${ISO}.iso" -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
            -c isolinux/boot.cat -b isolinux/isolinux.bin -no-emul-boot -boot-load-size 4 \
            -boot-info-table -eltorito-alt-boot -e efi.img -no-emul-boot -isohybrid-gpt-basdat iso/ 2>&1|tail -3
          cd /w; sha256sum ${ISO}.iso>${ISO}.iso.sha256
          [ -f ${BASE}.squashfs ]&&sha256sum ${BASE}.squashfs>${BASE}.squashfs.sha256
          echo "=== Complete ==="; ls -lh *.iso *.squashfs 2>/dev/null||true
          '

      - uses: actions/upload-artifact@v4
        with:
          name: "cybr-build-${{ github.run_number }}"
          path: |
            *.iso
            *.iso.sha256
            *.squashfs
            *.squashfs.sha256
          retention-days: 7

  upload:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: "cybr-build-${{ github.run_number }}"

      - name: Upload to SourceForge
        env:
          SF_USER: ${{ secrets.SF_USER }}
          SF_PASS: ${{ secrets.SF_PASS }}
        run: |
          [ -z "$SF_USER" ]&&exit 0
          sudo apt-get update && sudo apt-get install -y sshpass rsync
          for f in *.iso;do for i in 1 2 3;do
            sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "$f" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/"&&break;sleep 30;done;done
          for f in *.squashfs;do [ -f "$f" ]||continue;for i in 1 2 3;do
            sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
              "$f" "$SF_USER@frs.sourceforge.net:/home/frs/project/wolfos/gaming/base/"&&break;sleep 30;done;done