name: "Cybr Build"
on: workflow_dispatch
env:
  ISO_NAME: "cybr-v${{ github.run_number }}"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /opt/hostedtoolcache /usr/share/swift && sudo docker system prune -af
      - run: |
          docker run --rm --privileged -v "$PWD:/w" -e ISO_NAME="${{ env.ISO_NAME }}" debian:bookworm bash -c '
          apt-get update && apt-get install -y debootstrap squashfs-tools xorriso isolinux syslinux-efi mtools wget gnupg2 curl dosfstools
          cd /tmp && mkdir -p iso/{live,boot,isolinux,EFI/boot}
          debootstrap --arch=amd64 bookworm c http://deb.debian.org/debian/
          chroot c bash <<C
          export DEBIAN_FRONTEND=noninteractive
          echo "deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware" > /etc/apt/sources.list
          apt-get update && apt-get install -y curl gnupg2
          mkdir -p /usr/share/keyrings
          curl -fsSL https://liquorix.net/liquorix-keyring.gpg -o /usr/share/keyrings/liq.gpg
          echo -e "Types: deb\nURIs: https://liquorix.net/debian\nSuites: bookworm\nComponents: main\nSigned-By: /usr/share/keyrings/liq.gpg" > /etc/apt/sources.list.d/liq.sources
          apt-get update
          dpkg --add-architecture i386
          apt-get update
          apt-get install -y linux-image-liquorix-amd64 firmware-linux-free firmware-linux-nonfree live-boot systemd-sysv plymouth plymouth-themes phosh-full gdm3 firefox-esr network-manager calamares steam-installer libgl1-mesa-dri:amd64 libgl1-mesa-dri:i386 mesa-vulkan-drivers:amd64 mesa-vulkan-drivers:i386 gnome-contacts gnome-calls chatty flatpak gparted ntfs-3g dosfstools e2fsprogs git vim nano network-manager-gnome qml-module-qtquick2 qml-module-qtquick-controls qml-module-qtquick-layouts qml-module-qtquick-window2
          wget -O /p.png "https://a.fsdn.com/allura/p/wolfos/icon?w=96" 2>/dev/null || true
          test -f /p.png && cp /p.png /usr/share/plymouth/themes/spinner/watermark.png || true
          plymouth-set-default-theme spinner && update-initramfs -u
          echo -e "NAME=\"Cybr\"\nPRETTY_NAME=\"Cybr Mobile Gaming\"\nID=cybr\nVERSION_ID=\"1.0\"\nHOME_URL=\"https://wolfos.uk\"" > /etc/os-release
          echo "Cybr 1.0 \n \l" > /etc/issue
          echo "Cybr Mobile Gaming Edition 1.0" > /etc/issue.net
          useradd -m -G sudo,audio,video cybruser && passwd -d cybruser && passwd -d root
          mkdir -p /etc/sudoers.d
          echo "cybruser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/c && chmod 440 /etc/sudoers.d/c
          mkdir -p /etc/gdm3
          echo -e "[daemon]\nAutomaticLoginEnable=true\nAutomaticLogin=cybruser" > /etc/gdm3/custom.conf
          echo -e "#%PAM-1.0\nauth required pam_permit.so\n@include common-account" > /etc/pam.d/gdm-autologin
          mkdir -p /home/cybruser/.config/autostart
          echo -e "[Desktop Entry]\nType=Application\nExec=calamares\nX-GNOME-Autostart-enabled=true" > /home/cybruser/.config/autostart/cal.desktop
          chown -R cybruser: /home/cybruser
          systemctl enable gdm3 NetworkManager
          apt-get clean
          C
          cp -r c/boot/* iso/boot/
          K=$(ls iso/boot/vmlinuz-*liquorix* | head -1 | sed "s|iso/boot/vmlinuz-||")
          mksquashfs c iso/live/filesystem.squashfs -comp xz -e boot
          echo -e "DEFAULT l\nLABEL l\n KERNEL /boot/vmlinuz-$K\n APPEND initrd=/boot/initrd.img-$K boot=live quiet splash" > iso/isolinux/isolinux.cfg
          cp /usr/lib/ISOLINUX/isolinux.bin iso/isolinux/ && cp /usr/lib/syslinux/modules/bios/vesamenu.c32 iso/isolinux/
          echo -e "DEFAULT l\nLABEL l\n LINUX /boot/vmlinuz-$K\n APPEND boot=live quiet\n INITRD /boot/initrd.img-$K" > iso/EFI/boot/syslinux.cfg
          cp /usr/lib/SYSLINUX.EFI/efi64/syslinux.efi iso/EFI/boot/bootx64.efi
          dd if=/dev/zero of=iso/e.img bs=1M count=10 && mkfs.vfat iso/e.img
          mkdir m && mount iso/e.img m && mkdir -p m/EFI/boot && cp iso/EFI/boot/* m/EFI/boot/ && umount m && rmdir m
          xorriso -as mkisofs -o /w/$ISO_NAME.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin -eltorito-alt-boot -e e.img -no-emul-boot -isohybrid-gpt-basdat iso/
          '
          sha256sum ${{ env.ISO_NAME }}.iso > ${{ env.ISO_NAME }}.sha256
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: ${{ env.ISO_NAME }}.*
  upload:
  runs-on: ubuntu-latest
  needs: build
  if: github.ref == 'refs/heads/main'
  env:
    ISO_NAME: "cybr-v${{ github.run_number }}"
  steps:
    - uses: actions/download-artifact@v4
      with:
        name: ${{ env.ISO_NAME }}
    
    - run: |
        [ -z "${{ secrets.SF_USER }}" ] && exit 0
        sudo apt-get install -y sshpass rsync
        sshpass -p "${{ secrets.SF_PASS }}" rsync -avP -e "ssh -o StrictHostKeyChecking=no" ${{ env.ISO_NAME }}.iso ${{ secrets.SF_USER }}@frs.sourceforge.net:/home/frs/project/wolfos/gaming/