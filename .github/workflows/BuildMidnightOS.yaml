name: Build and Deploy MidnightOS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BOARD: "amd64-openfyde"
  BUILD_TYPE: "midnight-ui"
  CHROMEOS_RELEASE: "release-R102-14695.B"
  SF_USER: "spoinkoscdn"
  SF_PROJECT: "MidnightOS"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    
    steps:
    - name: Maximize disk space
      uses: mkorje/free-disk-space-action@2e7c9816aad6f9d3394a8a5224cebe6622dd7600

    - name: Double space freed 
      uses: endersonmenezes/free-disk-space@713d134e243b926eba4a5cce0cf608bfd1efb89a

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create build ctx
      run: |
        mkdir -p dbld
        
        cat > dbld/Dockerfile << 'EOF'
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive TZ=UTC

RUN apt-get update && apt-get install -y \
    git curl wget python3 python3-pip build-essential sudo locales \
    ca-certificates gnupg lsb-release unzip xz-utils bc bison flex \
    libssl-dev libncurses5-dev u-boot-tools device-tree-compiler \
    gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
    lib32z1-dev zlib1g-dev libelf-dev libdbus-1-dev libbluetooth-dev \
    libnss3-dev libasound2-dev imagemagick fontconfig sshpass rsync \
    fonts-liberation fonts-dejavu openssh-client \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

RUN useradd -m -s /bin/bash -G sudo bld && \
    echo 'bld ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

RUN git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git /opt/dt && \
    chown -R bld:bld /opt/dt && chmod -R 755 /opt/dt && \
    echo 'bld ALL=(ALL) NOPASSWD: /opt/dt/repo' >> /etc/sudoers.d/bld-repo && \
    chmod 0440 /etc/sudoers.d/bld-repo

COPY bld.sh /home/bld/bld.sh
RUN chmod +x /home/bld/bld.sh && chown bld:bld /home/bld/bld.sh && \
    mkdir -p /home/bld/{cros,art,log} && chown -R bld:bld /home/bld

USER bld
WORKDIR /home/bld
ENV PATH="/opt/dt:$PATH"
RUN git config --global user.name "MOS" && \
    git config --global user.email "mos@build" && \
    git config --global color.ui auto

CMD ["/home/bld/bld.sh"]
EOF

        cat > dbld/bld.sh << 'EOF'
#!/bin/bash
set -e

export BOARD="amd64-openfyde"
export R="release-R102-14695.B"
export PATH="/opt/dt:$PATH"
        
echo "=== MOS Bld Start ==="
mkdir -p $HOME/bnd/{ic,wp,cfg,thm} $HOME/art $HOME/log $HOME/cros

cd $HOME/bnd
MP="#0F0F0F"; MS="#1A1A1A"; MA="#6366F1"; MT="#E5E5E5"; MSU="#121212"

convert -size 800x200 xc:"$MP" -fill "$MT" -font "DejaVu-Sans-Bold" \
  -pointsize 48 -gravity center -annotate +0-10 "MidnightOS" \
  -fill "$MA" -pointsize 20 -annotate +0+25 "MIDNIGHT" mos-logo.png 2>/dev/null || true

convert -size 1920x1080 gradient:"$MP"-"$MS" -fill "$MT" -pointsize 64 \
  -gravity center -annotate +0-80 "MidnightOS" -fill "$MA" -pointsize 24 \
  -annotate +0-20 "Dark • Modern • Private" boot.png 2>/dev/null || true

mkdir -p wp
convert -size 1920x1080 gradient:"$MP"-"$MS" wp/mos-def.jpg 2>/dev/null || true

cat > cfg/mos.json << 'TH'
{"name":"MOS","v":"1.0","base":"ofyd","board":"amd64-ofyd","thm":{"dm":true,"pc":"#0F0F0F","ac":"#6366F1"},"ft":{"pbc":true,"ig":true,"nt":true}}
TH

cd $HOME/cros
git config --global color.ui false

sudo -E /opt/dt/repo init -u https://chromium.googlesource.com/chromiumos/manifest.git \
  --repo-url https://chromium.googlesource.com/external/repo.git \
  -b ${R} -g minilayout --depth=1 2>&1
sudo chown -R bld:bld .repo

mkdir -p .repo/local_manifests

cat > .repo/local_manifests/ofyd.xml << 'MF'
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote name="ofyd" fetch="https://github.com/openFyde" />
  <project path="src/overlays/overlay-amd64-openfyde" name="overlay-amd64-openfyde" remote="ofyd" revision="refs/heads/main" />
  <project path="src/overlays/project-openfyde" name="project-openfyde" remote="ofyd" revision="refs/heads/r102-dev" />
</manifest>
MF

cat > .repo/local_manifests/opt.xml << 'OPT'
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remove-project name="chromiumos/platform/tast-tests" />
  <remove-project name="chromiumos/platform/dev-util" />
  <remove-project name="chromiumos/third_party/autotest" />
</manifest>
OPT

sudo mkdir -p /home/bld/log
sudo chmod -R 777 /home/bld/log

sudo -E /opt/dt/repo sync -c -j$(nproc) --fail-fast --force-sync 2>&1 &
SP=$!
while kill -0 $SP 2>/dev/null; do
  echo "Sync $(date +%H:%M:%S) $(du -sh $HOME/cros 2>/dev/null | cut -f1)"
  sleep 60
done
wait $SP
sudo chown -R bld:bld $HOME/cros

mkdir -p src/overlays/overlay-mos/chromeos-base/{cros-ast,ash-cfg}
cp -r $HOME/bnd/* src/overlays/overlay-mos/chromeos-base/cros-ast/ 2>/dev/null || true

mkdir -p src/overlays/overlay-mos/profiles/base
cat > src/overlays/overlay-mos/profiles/base/make.defaults << 'PR'
USE="${USE} openfyde_board-amd64-openfyde intel_graphics intel_hd_graphics intel_audio"
USE="${USE} drm_atomic baytrail_audio vaapi v4l2_codec"
USE="${USE} dark_mode material_design wayland compositor blur_effects"
USE="${USE} vulkan opengl animations gpu_rasterization"
USE="${USE} linux_apps android_apps crostini bluetooth wifi"
USE="${USE} -metrics_collection -crash_reporter -feedback -uma"
USE="${USE} -crash_sender -anomaly_detector -diagnostics"
FEATURES="-test"
CHROMEOS_DEVICE_ID="mos-amd64"
CHROMEOS_VERSION_STRING="MOS"
CHROMEOS_METRICS_ENABLED=0
PR

cros_sdk --enter --cmd="setup_board --board=${BOARD}" 2>&1 || true
cros_sdk --enter --cmd="sudo emerge capnproto" 2>&1 || true

cros_sdk --enter --cmd="
  export BOARD=${BOARD}
  export USE='minimal -autotest dark_mode material_design compositor blur_effects vulkan opengl -metrics_collection -crash_reporter'
  export CHROMEOS_VERSION_STRING='MOS'
  export CHROMEOS_DEVICE_ID='mos-amd64'
  export CHROMEOS_METRICS_ENABLED=0
  
  build_packages --board=\${BOARD} --nowithautotest --autosetgov --nouse_any_chrome
" 2>&1 &

BP=$!
while kill -0 $BP 2>/dev/null; do
  echo "Bld $(date +%H:%M:%S)"
  sleep 120
done
wait $BP || true

cros_sdk --enter --cmd="
  export BOARD=${BOARD}
  export CHROMEOS_METRICS_ENABLED=0
  
  build_image --board=\${BOARD} --noenable_rootfs_verification \
    --boot_args='cros_secure quiet dark_mode=1 loglevel=3 splash' dev
" 2>&1 || true

echo ""
echo "════════════════════════════════════════════════════════════"
echo "  PREPARING RELEASE ARTIFACTS"
echo "════════════════════════════════════════════════════════════"

ARTIFACTS_DIR="$HOME/art"
mkdir -p "${ARTIFACTS_DIR}"

BUILD_DIR="$HOME/cros/src/build/images/$BOARD/latest/"

shopt -s nullglob

if [ -d "${BUILD_DIR}" ]; then
  echo "→ Copying build artifacts from ${BUILD_DIR}..."

  cp -v "${BUILD_DIR}"/*.bin "${ARTIFACTS_DIR}/" 2>/dev/null || true
  cp -v "${BUILD_DIR}"/*.img "${ARTIFACTS_DIR}/" 2>/dev/null || true
  
  shopt -u nullglob

  cd "${ARTIFACTS_DIR}"

  for f in *.bin *.img; do
    if [ -f "$f" ]; then
      nn="MOS-$(date +%Y.%m.%d)-${f}"
      mv "$f" "$nn"
      sha256sum "$nn" > "${nn}.sha256"
      md5sum "$nn" > "${nn}.md5"
      
      SZ_B=$(stat -c%s "$nn")
      SZ_MB=$(echo "scale=2; $SZ_B / 1024 / 1024" | bc)
      echo "  ✓ $nn (${SZ_MB}MB)"
    fi
  done
  
  ls -lh "${ARTIFACTS_DIR}/"
else
  echo "ERROR: Build directory not found: ${BUILD_DIR}"
  exit 1
fi
EOF

    - name: Bld MOS in Docker
      run: |
        cd dbld
        docker build -t mos-bld .
        docker run --privileged --rm --name mos-bld \
          -v "$(pwd)/../art:/home/bld/art" \
          -v "$(pwd)/../log:/home/bld/log" \
          --tmpfs /tmp:rw,noexec,nosuid,size=8g \
          --shm-size=8g \
          mos-bld

    - name: Verify art
      run: |
        [ -d "art" ] || exit 1
        ls -lah art/
        for f in art/*.bin art/*.img; do
          [ -f "$f" ] || continue
          sz=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null || echo "0")
          echo "$(basename "$f"): $((sz/1024/1024))MB"
        done

    - name: Prep SF
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      run: |
        sudo apt-get update && sudo apt-get install -y rsync sshpass
        mkdir -p rel
        [ -d "art" ] && [ "$(ls -A art/)" ] && cp art/* rel/ || exit 1

    - name: Upload SF
      if: success() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
      env:
        SF_PASS: ${{ secrets.SF_PASS }}
      run: |
        [ -z "$SF_PASS" ] && exit 0
        cd rel
        VD="$(date +%Y.%m.%d)"
        sshpass -p "$SF_PASS" rsync -avP -e "ssh -o StrictHostKeyChecking=no" \
          ./ ${SF_USER}@frs.sourceforge.net:/home/frs/project/${SF_PROJECT}/${VD}/ || true

    - name: Archive log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mos-log-${{ github.run_number }}
        path: log/
        retention-days: 30

    - name: Archive art
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: mos-rel-${{ github.run_number }}
        path: |
          rel/
          art/
        retention-days: 90